<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart QR Event Wallet</title>
    <!-- 1. Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. QR Code Generation Library --><script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- 3. QR Code Scanning Library --><script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>
    <!-- 4. jsPDF Library (NEW) --><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- 5. Firebase SDKs --><script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            setPersistence,
            inMemoryPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            addDoc,
            getDocs,
            serverTimestamp,
            increment,
            arrayUnion,
            arrayRemove,
            runTransaction,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // --- GLOBAL STATE ---
        let db, auth, analytics;
        let html5QrCode; // Main scanner
        let stallQrScanner; // Stall's payment scanner
        let adminRechargeQrScanner; // Admin's recharge scanner
        let currentUnsubscribes = []; // To detach listeners on logout
        let appState = {
            currentUser: null, // { id, name, role, balance, class, menu (for stall) }
            currentView: 'home',
            rechargeAmount: 0, // Still used for admin recharge
            scannedStudentId: null,
            scannedStudentName: null,
            stallCart: {}, // { itemId: quantity }
            allTransactionsForExport: [],
            allStallMenus: {}, // { stallId: { name: 'Stall Name', menu: [...] } }
            // NEW: Cache for PDF generation
            currentClassStudentList: [], // {id, name, class}
        };
        let modal, modalMessage, modalButton;
        let confirmModal, confirmModalMessage, btnConfirmYes, btnConfirmNo;
        let confirmCallback = null;


        // --- FIREBASE CONFIG & PATHS ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-event-wallet';

        // --- DOM Elements ---
        let views = {};
        let loadingMessageEl;

        // --- FIREBASE COLLECTION REFERENCES ---
        const usersRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'users');
        const stallsRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'stalls');
        const transactionsRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'transactions');
        const configRef = () => doc(db, 'artifacts', appId, 'public', 'data', 'eventConfig', 'config');
        const classesRef = () => doc(db, 'artifacts', appId, 'public', 'data', 'eventConfig', 'classes');

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Cache all view elements
            views = {
                home: document.getElementById('homeView'),
                adminLogin: document.getElementById('adminLoginView'),
                adminDashboard: document.getElementById('adminDashboardView'),
                scanner: document.getElementById('scannerView'),
                studentDashboard: document.getElementById('studentDashboardView'),
                stallDashboard: document.getElementById('stallDashboardView'),
                stallPayment: document.getElementById('stallPaymentView'),
                loading: document.getElementById('loadingView'),
                adminRecharge: document.getElementById('adminRechargeView'),
            };
            modal = document.getElementById('modal');
            modalMessage = document.getElementById('modalMessage');
            modalButton = document.getElementById('modalButton');

            confirmModal = document.getElementById('confirmModal');
            confirmModalMessage = document.getElementById('confirmModalMessage');
            btnConfirmYes = document.getElementById('btnConfirmYes');
            btnConfirmNo = document.getElementById('btnConfirmNo');
            loadingMessageEl = document.getElementById('loadingMessage');

            // Initialize Firebase
            initFirebase();

            // Attach base event listeners
            attachHomeListeners();
            attachAdminLoginListeners();
            attachScannerListeners();
            attachAdminDashboardListeners();
            attachStudentDashboardListeners();
            attachStallDashboardListeners();
            attachStallPaymentListeners();
            attachAdminRechargeListeners();

            if (modalButton) {
                modalButton.onclick = () => modal?.classList.add('hidden');
            } else {
                 console.error("Error: Could not find button with ID 'modalButton'");
            }

            if (btnConfirmNo) {
                btnConfirmNo.onclick = () => {
                    confirmCallback = null;
                    confirmModal?.classList.add('hidden');
                };
            } else {
                 console.error("Error: Could not find button with ID 'btnConfirmNo'");
            }

            if (btnConfirmYes) {
                btnConfirmYes.onclick = () => {
                    if (confirmCallback) {
                        confirmCallback();
                    }
                    confirmCallback = null;
                    confirmModal?.classList.add('hidden');
                };
            } else {
                 console.error("Error: Could not find button with ID 'btnConfirmYes'");
            }
        });

        async function initFirebase() {
            try {
                // --- PASTE YOUR FIREBASE CONFIG HERE ---
                const firebaseConfig = {
                 apiKey: "AIzaSyCsuWEjnrYr1g7ruvZ60ur6TADzbHkJpno",
                 authDomain: "qr-wallet-2ef48.firebaseapp.com",
                 projectId: "qr-wallet-2ef48",
                 storageBucket: "qr-wallet-2ef48.firebasestorage.app",
                 messagingSenderId: "755057942199",
                 appId: "1:755057942199:web:f5fa763b08534bcf1f3732",
                 measurementId: "G-NSLXTCC8JM"
                 };

                // const firebaseConfig = { ... };
                // ----------------------------------------

                let effectiveConfig;
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    console.log("Using environment-provided Firebase config.");
                    effectiveConfig = JSON.parse(__firebase_config);
                } else if (typeof firebaseConfig !== 'undefined') {
                    console.log("Using user-provided Firebase config.");
                    effectiveConfig = firebaseConfig;
                } else {
                    showAlert("SETUP REQUIRED: Firebase configuration is missing.");
                    console.error("Firebase config is not set.");
                    return;
                }

                const app = initializeApp(effectiveConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                analytics = getAnalytics(app);
                setLogLevel('Debug');

                await setPersistence(auth, inMemoryPersistence);

                onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                        showLoading('Connecting to event...');
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                            console.log("Firebase Auth successful.");
                        } catch (error) {
                            console.error("Auth Error:", error);
                            if (error.code === 'auth/configuration-not-found') {
                                showAlert("SETUP ERROR: Anonymous sign-in is not enabled.");
                            } else {
                                showAlert(`Error connecting: ${error.message}`);
                            }
                            hideLoading();
                        }
                    } else {
                        console.log("User is authenticated:", user.uid);
                        preloadAllStallMenus();
                        hideLoading();
                        showView('home');
                    }
                });

            } catch (error) {
                console.error("Firebase Init Error:", error);
                showAlert("Critical error loading app configuration.");
            }
        }

        function preloadAllStallMenus() {
            const unsub = onSnapshot(stallsRef(), (snapshot) => {
                appState.allStallMenus = {};
                snapshot.forEach(doc => {
                    appState.allStallMenus[doc.id] = {
                        name: doc.data().name,
                        menu: doc.data().menu || []
                    };
                });
                console.log("All stall menus loaded/updated:", appState.allStallMenus);
                if (appState.currentUser && appState.currentUser.role === 'student' && appState.currentView === 'studentDashboard') {
                    loadStudentStallList();
                }
            }, (error) => {
                console.error("Error loading all stall menus:", error);
            });
        }

        // --- VIEW NAVIGATION ---
        function showView(viewId) {
            cleanupListeners();
            stopAllScanners();
            appState.currentView = viewId;
            Object.values(views).forEach(v => v?.classList.add('hidden'));
            if (views[viewId]) views[viewId].classList.remove('hidden');
            hideLoading();
        }

        function showLoading(message) {
            if (loadingMessageEl) {
                loadingMessageEl.textContent = message;
            } else {
                console.error("loadingMessage element not found");
            }
            if (views.loading) views.loading.classList.remove('hidden');
        }

        function hideLoading() {
            if (views.loading) views.loading.classList.add('hidden');
        }

        function showAlert(message) {
            if (modalMessage && modal) {
                modalMessage.textContent = message;
                modal.classList.remove('hidden');
            } else {
                console.error("Modal elements not found for showAlert:", message);
                console.log("ALERT:", message);
            }
        }
       
        function showConfirm(message, onYesCallback) {
             if (confirmModalMessage && confirmModal && btnConfirmYes && btnConfirmNo) {
                confirmModalMessage.textContent = message;
                confirmCallback = onYesCallback;
                confirmModal.classList.remove('hidden');
             } else {
                 console.error("Confirm modal elements not found for showConfirm:", message);
                 console.error("Confirmation skipped as modal elements are missing.");
                 confirmCallback = null;
             }
        }

        function cleanupListeners() {
            currentUnsubscribes.forEach(unsub => unsub());
            currentUnsubscribes = [];
        }

        function stopAllScanners() {
            [html5QrCode, stallQrScanner, adminRechargeQrScanner].forEach(scanner => {
                try {
                    if (scanner && typeof scanner.getState === 'function' && scanner.getState() === Html5QrcodeScannerState.SCANNING) {
                         scanner.stop().catch(err => console.warn("Scanner stop error (ignorable):", err));
                    } else if (scanner && scanner.isScanning) { // Fallback
                         scanner.stop().catch(err => console.warn("Scanner stop error (ignorable, fallback):", err));
                    }
                } catch (e) {
                    // console.warn("Error accessing or stopping scanner:", e);
                }
            });
        }
       

        function logout() {
            appState.currentUser = null;
            appState.scannedStudentId = null;
            appState.scannedStudentName = null;
            appState.stallCart = {};
            showView('home');
        }

        // --- HOME VIEW LOGIC ---
        function attachHomeListeners() {
            const btnAdmin = document.getElementById('btnAdminLogin');
            const btnStall = document.getElementById('btnStallLogin');
            const btnStudent = document.getElementById('btnStudentLogin');

            if (btnAdmin) btnAdmin.onclick = () => showView('adminLogin');
            else console.error("btnAdminLogin not found");
            if (btnStall) btnStall.onclick = () => startScanner('stall');
             else console.error("btnStallLogin not found");
            if (btnStudent) btnStudent.onclick = () => startScanner('student');
             else console.error("btnStudentLogin not found");
        }

        // --- SCANNER VIEW LOGIC ---
        function attachScannerListeners() {
            const btnCancel = document.getElementById('btnCancelScan');
            if (btnCancel) btnCancel.onclick = () => showView('home');
            else console.error("btnCancelScan not found");
        }


        function startScanner(loginType) {
            showView('scanner');
            const scannerTitle = document.getElementById('scannerTitle');
            if (scannerTitle) scannerTitle.textContent = `Scan ${loginType.charAt(0).toUpperCase() + loginType.slice(1)} QR Code`;
             else console.error("scannerTitle not found");

            if (!html5QrCode) {
                try {
                    html5QrCode = new Html5Qrcode("qr-reader");
                } catch (e) {
                    console.error("Failed to initialize Html5Qrcode:", e);
                    showAlert("QR Scanner component failed to load.");
                    showView('home');
                    return;
                }
            }
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => handleLoginScan(decodedText, loginType), (errorMessage) => { /* console.warn(errorMessage) */ })
                .catch(err => {
                    console.error("Scanner start error:", err);
                    showAlert("Could not start camera. Please check permissions.");
                    showView('home');
                });
        }

        async function handleLoginScan(userId, loginType) {
            stopAllScanners();
            showLoading('Verifying QR Code...');
            try {
                const userDoc = await getDoc(doc(usersRef(), userId));
                if (!userDoc.exists()) throw new Error('Invalid QR Code.');
                const user = userDoc.data();
                if (user.role !== loginType) throw new Error(`Incorrect QR Code type (${user.role}).`);
                appState.currentUser = { id: userId, ...user };
                if (loginType === 'student') loadStudentDashboard();
                else if (loginType === 'stall') loadStallDashboard();
            } catch (error) {
                console.error("Login Scan Error:", error);
                showAlert(error.message);
                showView('home');
            }
        }

        // --- ADMIN LOGIN VIEW LOGIC ---
        function attachAdminLoginListeners() {
            const btnBack = document.getElementById('btnAdminLoginBack');
            const btnSubmit = document.getElementById('btnAdminLoginSubmit');
            const btnReset = document.getElementById('btnAdminResetPassword');

            if (btnBack) btnBack.onclick = () => showView('home');
            else console.error("btnAdminLoginBack not found");

            if (btnSubmit) btnSubmit.onclick = async () => {
                const passwordInput = document.getElementById('adminPassword');
                if (!passwordInput) { console.error("adminPassword input not found"); return; }
                const password = passwordInput.value;
                if (!password) return showAlert('Please enter password.');
                showLoading('Verifying password...');
                try {
                    const configSnap = await getDoc(configRef());
                    let correctPassword = 'admin123';
                    if (!configSnap.exists()) {
                        await setDoc(configRef(), { adminPassword: correctPassword });
                    } else {
                        correctPassword = configSnap.data().adminPassword;
                    }
                    if (password === correctPassword) loadAdminDashboard();
                    else throw new Error('Wrong password.');
                } catch (error) {
                    console.error("Admin Login Error:", error);
                    showAlert(error.message);
                    passwordInput.value = '';
                    hideLoading();
                }
            };
             else console.error("btnAdminLoginSubmit not found");

            if (btnReset) btnReset.onclick = () => {
                showConfirm("Reset admin password to 'admin123'?", async () => {
                    showLoading('Resetting...');
                    try {
                        await setDoc(configRef(), { adminPassword: 'admin123' });
                        showAlert('Password reset to "admin123".');
                    } catch (error) {
                        showAlert('Error resetting: ' + error.message);
                    } finally {
                        hideLoading();
                    }
                });
            };
             else console.error("btnAdminResetPassword not found");
        }


        // --- ADMIN DASHBOARD LOGIC ---
        function attachAdminDashboardListeners() {
            const btnLogout = document.getElementById('btnAdminLogout');
            if (btnLogout) btnLogout.onclick = logout;
            else console.error("btnAdminLogout not found");

            const tabs = document.querySelectorAll('#adminDashboardView .admin-tab');
            const tabPanels = document.querySelectorAll('#adminDashboardView .admin-tab-panel');
            tabs.forEach(tab => {
                tab.onclick = () => {
                    tabs.forEach(t => { t.classList.replace('bg-blue-600', 'bg-gray-700'); t.classList.add('text-gray-300'); });
                    tabPanels.forEach(p => p.classList.add('hidden'));
                    tab.classList.replace('bg-gray-700', 'bg-blue-600');
                    tab.classList.remove('text-gray-300');
                    const targetPanel = document.getElementById(tab.dataset.target);
                    if (targetPanel) targetPanel.classList.remove('hidden');
                    else console.error("Target panel not found:", tab.dataset.target);
                };
            });

            const btnGenStudent = document.getElementById('btnAdminGenerateStudent');
            if (btnGenStudent) btnGenStudent.onclick = () => generateUser('student');
            else console.error("btnAdminGenerateStudent not found");

            const btnRecharge = document.getElementById('btnAdminRechargeStudent');
            if (btnRecharge) btnRecharge.onclick = startAdminRechargeScan;
             else console.error("btnAdminRechargeStudent not found");

            const classSelect = document.getElementById('adminSearchClassSelect');
            if (classSelect) classSelect.onchange = handleClassFilterChange;
            else console.error("adminSearchClassSelect not found");

            // NEW: Add listener for bulk PDF download button
            const btnDownloadAll = document.getElementById('btnDownloadAllPasses');
            if (btnDownloadAll) btnDownloadAll.onclick = generateClassPDF;
            else console.error("btnDownloadAllPasses not found");

            const btnAddClass = document.getElementById('btnAdminAddClass');
            if (btnAddClass) btnAddClass.onclick = addAdminClass;
            else console.error("btnAdminAddClass not found");

            const btnGenStall = document.getElementById('btnAdminGenerateStall');
            if (btnGenStall) btnGenStall.onclick = () => generateUser('stall');
            else console.error("btnAdminGenerateStall not found");

            const btnAddItem = document.getElementById('btnAdminAddMenuItem');
            if (btnAddItem) btnAddItem.onclick = addMenuItem;
             else console.error("btnAdminAddMenuItem not found");

            const btnSearchStall = document.getElementById('btnAdminSearchStall');
            if (btnSearchStall) btnSearchStall.onclick = searchStall;
             else console.error("btnAdminSearchStall not found");

            const btnExport = document.getElementById('btnExportCSV');
            if (btnExport) btnExport.onclick = exportTransactionsToCSV;
            else console.error("btnExportCSV not found");
        }


        // --- Renders entry pass (admin view has print/download) ---
        function displayUserQR(containerElement, user) {
            if (!containerElement) { console.error("displayUserQR: containerElement is null"); return; }
            containerElement.innerHTML = ''; containerElement.classList.remove('hidden');
            const passId = `printable-pass-${user.id}`, qrInnerId = `qr-code-inner-${user.id}`;
            const printBtnId = `btnPrintPass-${user.id}`, downloadBtnId = `btnDownloadQR-${user.id}`;
            const isAdmin = appState.currentUser && appState.currentUser.role === 'admin';

            containerElement.innerHTML = `
                <div id="${passId}" class="printable-area bg-white text-black p-6 rounded-lg shadow-lg max-w-xs mx-auto border-4 border-blue-600">
                    <div class="text-center border-b pb-4 border-gray-300">
                        <h3 class="text-xl font-bold text-gray-800">Udaya Public School</h3>
                        <p class="text-xs text-gray-600">Mahadev Jharkhandi, Kunraghat, Gorakhpur</p>
                    </div>
                    <div class="my-4 text-center">
                        <p class="text-sm font-medium text-gray-700">ANNUAL FEST 2025-26</p>
                        <p class="text-2xl font-bold text-blue-600">ENTRY PASS</p>
                        <p class="text-sm font-semibold text-gray-700">Date: 1-FEB-2026</p>
                    </div>
                    <div class="my-4 text-center">
                        <p class="text-lg font-bold text-black">${user.name}</p>
                        <p class="text-base text-gray-700">Class: ${user.class || 'N/A'}</p>
                    </div>
                    <div id="${qrInnerId}" class="flex justify-center p-4 bg-white rounded-lg"></div>
                    <p class="text-xs text-center break-all text-gray-500">${user.id}</p>
                </div>
                ${isAdmin ? `
                <div class="flex space-x-2 mt-4 print-hide">
                    <button id="${printBtnId}" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Print Pass</button>
                    <button id="${downloadBtnId}" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Download QR</button>
                </div>` : ''}
            `;
            const qrElement = document.getElementById(qrInnerId);
            if (qrElement) {
                new QRCode(qrElement, { text: user.id, width: 200, height: 200, colorDark: "#000", colorLight: "#fff", correctLevel: QRCode.CorrectLevel.H });
            } else {
                 console.error(`QR container ${qrInnerId} not found`);
            }
            if (isAdmin) {
                const btnPrint = document.getElementById(printBtnId);
                const btnDownload = document.getElementById(downloadBtnId);
                if(btnPrint) btnPrint.onclick = () => printPass(passId);
                else console.error(`Print button ${printBtnId} not found`);
                if(btnDownload) btnDownload.onclick = () => downloadQR(qrInnerId, user.name);
                 else console.error(`Download button ${downloadBtnId} not found`);
            }
        }

        // --- Print/Download Helpers ---
        function printPass(elementId) {
             const passElement = document.getElementById(elementId);
            if (!passElement) {
                console.error('Could not find element to print:', elementId);
                return;
            }
            passElement.classList.add('print-this-one');
            window.print();
            passElement.classList.remove('print-this-one');
        }
        function downloadQR(qrContainerId, name) {
             try {
                const qrContainer = document.getElementById(qrContainerId);
                if (!qrContainer) { throw new Error(`QR container ${qrContainerId} not found`); }
                const qrImage = qrContainer.querySelector('img');
                if (!qrImage) throw new Error('QR image not found within container');
                const link = document.createElement('a');
                link.href = qrImage.src;
                link.download = `qr_${name.replace(/ /g, '_')}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error('Download QR Error:', error);
                showAlert('Could not download QR code.');
            }
        }

        // MODIFIED: Show/hide bulk download button and cache student list
        async function handleClassFilterChange(e) {
            const className = e.target.value;
            const studentListEl = document.getElementById('adminStudentListByClass');
            const qrContainer = document.getElementById('adminSearchQRContainer');
            const btnDownloadAll = document.getElementById('btnDownloadAllPasses'); // NEW

            if (!studentListEl || !qrContainer || !btnDownloadAll) {
                console.error("Missing elements for class filter");
                return;
            }

            studentListEl.innerHTML = '';
            qrContainer.innerHTML = '';
            qrContainer.classList.add('hidden');
            btnDownloadAll.classList.add('hidden'); // NEW: Hide button on change
            appState.currentClassStudentList = []; // NEW: Clear cache

            if (!className) return;

            showLoading('Fetching students...');
            try {
                const q = query(usersRef(), where('role', '==', 'student'), where('class', '==', className));
                const snapshot = await getDocs(q);
                if (snapshot.empty) throw new Error('No students found in this class.');

                // NEW: Cache student data
                appState.currentClassStudentList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                studentListEl.innerHTML = appState.currentClassStudentList.map(student =>
                    `<button class="btn-show-qr w-full text-left bg-gray-700 hover:bg-gray-600 p-3 rounded-lg" data-id="${student.id}" data-name="${student.name}" data-class="${student.class}">${student.name}</button>`
                ).join('');

                document.querySelectorAll('.btn-show-qr').forEach(btn => {
                    btn.onclick = (e) => {
                        document.querySelectorAll('.btn-show-qr').forEach(b => b.classList.remove('bg-blue-600'));
                        e.currentTarget.classList.add('bg-blue-600');
                        displayUserQR(qrContainer, { role: 'student', ...e.currentTarget.dataset });
                    };
                });

                btnDownloadAll.classList.remove('hidden'); // NEW: Show button
            } catch (error) {
                showAlert(error.message);
                studentListEl.innerHTML = `<p class="text-${error.message.startsWith('No students') ? 'gray-400' : 'red-500'}">${error.message}</p>`;
            } finally {
                hideLoading();
            }
        }

        // --- NEW PDF GENERATION FUNCTIONS ---

        /**
         * Generates a QR code for the given text and returns it as a Data URL.
         * Uses a temporary, hidden container to render the QR code image.
         */
        async function generateQRDataURL(text, container) {
            container.innerHTML = ''; // Clear previous QR
            return new Promise((resolve, reject) => {
                try {
                    // Generate QR code
                    new QRCode(container, {
                        text: text,
                        width: 256,
                        height: 256,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });

                    // Use a short delay to allow the QR code library to render the <img> tag
                    setTimeout(() => {
                        const img = container.querySelector('img');
                        if (img && img.src) {
                            resolve(img.src);
                        } else {
                            // Fallback check for canvas render
                            const canvas = container.querySelector('canvas');
                            if (canvas) {
                                resolve(canvas.toDataURL('image/png'));
                            } else {
                                reject(new Error('QR code image or canvas element not found after render.'));
                            }
                        }
                    }, 100); // 100ms should be safe for QR generation
                } catch (e) {
                    reject(e);
                }
            });
        }

        /**
         * Generates a multi-page PDF for all students in the currently selected class.
         */
        async function generateClassPDF() {
            const students = appState.currentClassStudentList;
            if (!students || students.length === 0) {
                return showAlert("No students found for the selected class.");
            }

            const className = students[0].class || "all_students";
            showLoading(`Generating PDF for ${className}... (0 / ${students.length})`);

            // 1. Init jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('portrait', 'mm', 'a4'); // A4: 210 x 297 mm

            // 2. Create temporary QR container
            let qrTempContainer = document.getElementById('qr-temp-container');
            if (!qrTempContainer) {
                qrTempContainer = document.createElement('div');
                qrTempContainer.id = 'qr-temp-container';
                qrTempContainer.style.position = 'absolute';
                qrTempContainer.style.left = '-9999px'; // Hide off-screen
                qrTempContainer.style.top = '-9999px';
                document.body.appendChild(qrTempContainer);
            }

            // 3. Layout Constants (in mm)
            const A4_WIDTH = 210;
            const A4_HEIGHT = 297;
            const MARGIN = 10;
            const GUTTER = 6; // Space between passes

            const USABLE_WIDTH = A4_WIDTH - 2 * MARGIN;
            const USABLE_HEIGHT = A4_HEIGHT - 2 * MARGIN;

            const PASS_WIDTH = (USABLE_WIDTH - GUTTER) / 2;
            const PASS_HEIGHT = (USABLE_HEIGHT - (2 * GUTTER)) / 3;

            // X,Y positions for the top-left corner of each of the 6 passes
            const positions = [
                { x: MARGIN, y: MARGIN }, // Row 1, Col 1
                { x: MARGIN + PASS_WIDTH + GUTTER, y: MARGIN }, // Row 1, Col 2
                { x: MARGIN, y: MARGIN + PASS_HEIGHT + GUTTER }, // Row 2, Col 1
                { x: MARGIN + PASS_WIDTH + GUTTER, y: MARGIN + PASS_HEIGHT + GUTTER }, // Row 2, Col 2
                { x: MARGIN, y: MARGIN + 2 * (PASS_HEIGHT + GUTTER) }, // Row 3, Col 1
                { x: MARGIN + PASS_WIDTH + GUTTER, y: MARGIN + 2 * (PASS_HEIGHT + GUTTER) }, // Row 3, Col 2
            ];

            let studentCounter = 0;

            // 4. Loop through students and draw passes
            for (const student of students) {
                const passIndex = studentCounter % 6; // 0-5
                const { x, y } = positions[passIndex];

                // Add a new page if we are starting the 7th student (index 6, which is 0 % 6)
                if (studentCounter > 0 && passIndex === 0) {
                    doc.addPage();
                }

                showLoading(`Generating PDF... (${studentCounter + 1} / ${students.length})`);

                // Generate QR code data URL
                let qrDataUrl;
                try {
                    qrDataUrl = await generateQRDataURL(student.id, qrTempContainer);
                } catch (error) {
                    console.error("Failed to generate QR for", student.name, error);
                    qrDataUrl = null; // We'll skip drawing it if it fails
                }

                // --- Draw Pass ---
                doc.setDrawColor(200, 200, 200); // Light grey border for cutting
                doc.rect(x, y, PASS_WIDTH, PASS_HEIGHT);

                const FONT_TITLE = 9;
                const FONT_HEADER = 8;
                const FONT_NAME = 11;
                const FONT_DETAIL = 9;
                const FONT_ID = 5;
                const QR_SIZE = 30; // 30mm x 30mm
                const PADDING = 4; // Inner padding

                let currentY = y + PADDING + 2; // Start Y

                // School Name
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(FONT_TITLE);
                doc.text('Udaya Public School', x + PASS_WIDTH / 2, currentY, { align: 'center' });
                currentY += FONT_TITLE * 0.5;

                // Event Name
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(FONT_HEADER);
                doc.text('ANNUAL FEST 2025-26', x + PASS_WIDTH / 2, currentY, { align: 'center' });
                currentY += FONT_HEADER * 0.5;

                // Pass Type
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(FONT_HEADER);
                doc.text('ENTRY PASS', x + PASS_WIDTH / 2, currentY, { align: 'center' });
                currentY += FONT_HEADER * 0.5 + 4; // Add extra gap

                // Student Name
                doc.setFontSize(FONT_NAME);
                doc.setFont('helvetica', 'bold');
                doc.text(student.name, x + PADDING, currentY, { maxWidth: PASS_WIDTH - PADDING * 2 - QR_SIZE - 5 });
                currentY += FONT_NAME * 0.5;

                // Class
                doc.setFontSize(FONT_DETAIL);
                doc.setFont('helvetica', 'normal');
                doc.text(`Class: ${student.class || 'N/A'}`, x + PADDING, currentY, { maxWidth: PASS_WIDTH - PADDING * 2 - QR_SIZE - 5 });
                currentY += FONT_DETAIL * 0.5;

                // Draw QR Code
                if (qrDataUrl) {
                    const qrX = x + PASS_WIDTH - PADDING - QR_SIZE;
                    const qrY = y + PADDING + 15; // Align QR code vertically
                    doc.addImage(qrDataUrl, 'PNG', qrX, qrY, QR_SIZE, QR_SIZE);
                }
                
                // Student ID (at the bottom)
                doc.setFontSize(FONT_ID);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(100, 100, 100); // Grey text for ID
                doc.text(student.id, x + PASS_WIDTH / 2, y + PASS_HEIGHT - PADDING, { align: 'center', maxWidth: PASS_WIDTH - PADDING * 2 });
                doc.setTextColor(0, 0, 0); // Reset text color

                studentCounter++;
            }

            // 5. Save PDF
            qrTempContainer.innerHTML = ''; // Clean up temp container
            hideLoading();
            doc.save(`entry_passes_${className.replace(/ /g, '_')}.pdf`);
        }
        
        // --- END NEW PDF FUNCTIONS ---


        async function searchStall() {
             const stallNameInput = document.getElementById('adminSearchStallName');
             const qrContainer = document.getElementById('adminSearchStallQRContainer');
             if (!stallNameInput || !qrContainer) { console.error("Missing elements for stall search"); return; }
             const stallName = stallNameInput.value;
            if (!stallName) return showAlert('Please enter stall name.');
            showLoading('Searching...'); qrContainer.innerHTML = '';
            try {
                const q = query(usersRef(), where('role', '==', 'stall'), where('name', '==', stallName));
                const snapshot = await getDocs(q);
                if (snapshot.empty) throw new Error('No stall found with that name.');
                const stallUser = snapshot.docs[0].data();
                qrContainer.classList.remove('hidden');
                const qrInnerId = `qr-stall-${stallUser.userId}`;
                qrContainer.innerHTML = `
                    <h3 class="text-lg font-semibold mb-2 text-black">${stallUser.name}</h3>
                    <div id="${qrInnerId}" class="flex justify-center"></div>
                    <p class="text-xs mt-2 break-all text-black">${stallUser.userId}</p>
                    <button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mt-4 btn-download-stall-qr">Download QR</button>
                `;
                const qrElement = document.getElementById(qrInnerId);
                 if (qrElement) new QRCode(qrElement, { text: stallUser.userId, width: 200, height: 200 });
                 else console.error(`QR container ${qrInnerId} not found`);
               
                const btnDownload = qrContainer.querySelector('.btn-download-stall-qr');
                if(btnDownload) btnDownload.onclick = () => downloadQR(qrInnerId, stallUser.name);
                else console.error("Stall QR download button not found");
               
                stallNameInput.value = '';
            } catch (error) {
                showAlert(error.message);
                qrContainer.innerHTML = '<p class="text-red-500">Search failed.</p>';
            } finally { hideLoading(); }
        }


        function loadAdminDashboard() {
             showView('adminDashboard');
            appState.currentUser = { id: 'admin', role: 'admin' };
            loadAdminStudents(); loadAdminStallsAndMenus(); loadAdminReports(); loadAdminClasses();
        }

        async function generateUser(role) {
             const nameInput = document.getElementById(role === 'student' ? 'adminStudentName' : 'adminStallName');
             const qrContainer = document.getElementById(role === 'student' ? 'adminStudentQRContainer' : 'adminStallQRContainer');
             if (!nameInput || !qrContainer) { console.error("Missing elements for user generation"); return;}
             const name = nameInput.value;

            let studentClass = null;
            if (role === 'student') {
                const classSelect = document.getElementById('adminStudentClassSelect');
                 if (!classSelect) { console.error("adminStudentClassSelect not found"); return;}
                studentClass = classSelect.value;
                if (!studentClass) return showAlert('Please select student class.');
            }
            if (!name) return showAlert(`Please enter ${role} name.`);
            showLoading(`Generating ${role}...`);
            try {
                const newUser = { name, role, balance: role === 'student' ? 0 : null, class: studentClass, createdAt: serverTimestamp() };
                const newDocRef = await addDoc(usersRef(), newUser);
                await updateDoc(newDocRef, { userId: newDocRef.id });
                if (role === 'stall') await setDoc(doc(stallsRef(), newDocRef.id), { name, ownerId: newDocRef.id, menu: [] });

                const userForQR = { id: newDocRef.id, name, class: studentClass, role };
                if (role === 'student') {
                    displayUserQR(qrContainer, userForQR);
                } else { // Stall QR
                    qrContainer.innerHTML = ''; qrContainer.classList.remove('hidden');
                    const qrInnerId = `qr-stall-gen-${userForQR.id}`;
                    qrContainer.innerHTML = `
                        <h3 class="text-lg font-semibold mb-2 text-black">${userForQR.name}</h3>
                        <div id="${qrInnerId}" class="flex justify-center"></div>
                        <p class="text-xs mt-2 break-all text-black">${userForQR.id}</p>
                        <button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mt-4 btn-download-stall-qr">Download QR</button>
                    `;
                    const qrElement = document.getElementById(qrInnerId);
                    if (qrElement) new QRCode(qrElement, { text: userForQR.id, width: 200, height: 200 });
                    else console.error(`QR container ${qrInnerId} not found`);

                    const btnDownload = qrContainer.querySelector('.btn-download-stall-qr');
                    if(btnDownload) btnDownload.onclick = () => downloadQR(qrInnerId, userForQR.name);
                    else console.error("Stall QR download button not found");
                }
                nameInput.value = '';
                if (role === 'student') {
                    const classSelect = document.getElementById('adminStudentClassSelect');
                    if(classSelect) classSelect.value = '';
                }
                showAlert(`${role} created successfully!`);
            } catch (error) { showAlert(`Error creating ${role}.`); console.error(error); } finally { hideLoading(); }
        }


        function loadAdminClasses() {
            const unsub = onSnapshot(classesRef(), (docSnap) => {
                const listEl = document.getElementById('adminClassList');
                const searchSelectEl = document.getElementById('adminSearchClassSelect');
                const genSelectEl = document.getElementById('adminStudentClassSelect');
                if (!listEl || !searchSelectEl || !genSelectEl) { console.error("Missing class list/select elements"); return;}

                let classNames = (docSnap.exists() && docSnap.data().classNames) ? docSnap.data().classNames.sort() : [];

                listEl.innerHTML = classNames.length === 0 ? '<p class="text-gray-400">No classes.</p>' :
                    classNames.map(name => `<div class="bg-gray-700 p-3 rounded-lg flex justify-between items-center"><span>${name}</span><button data-name="${name}" class="btn-delete-class bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg text-sm">Delete</button></div>`).join('');

                const optionsHTML = classNames.map(name => `<option value="${name}">${name}</option>`).join('');
                searchSelectEl.innerHTML = '<option value="">Select Class</option>' + optionsHTML;
                genSelectEl.innerHTML = '<option value="">Select Class</option>' + optionsHTML;

                document.querySelectorAll('.btn-delete-class').forEach(btn => {
                    btn.onclick = (e) => showConfirm(`Delete class "${e.target.dataset.name}"?`, () => deleteAdminClass(e.target.dataset.name));
                });
            }, error => console.error("Error loading classes:", error));
            currentUnsubscribes.push(unsub);
        }

        async function addAdminClass() {
             const input = document.getElementById('adminClassName');
             if (!input) { console.error("adminClassName input not found"); return; }
             const name = input.value.trim();
            if (!name) return showAlert('Enter class name.');
            showLoading('Adding...');
            try { await setDoc(classesRef(), { classNames: arrayUnion(name) }, { merge: true }); input.value = ''; }
            catch (e) { showAlert('Error: ' + e.message); } finally { hideLoading(); }
        }
        async function deleteAdminClass(name) {
            if (!name) return; showLoading('Deleting...');
            try { await updateDoc(classesRef(), { classNames: arrayRemove(name) }); }
            catch (e) { showAlert('Error: ' + e.message); } finally { hideLoading(); }
        }
        function loadAdminStudents() {
            const q = query(usersRef(), where('role', '==', 'student'));
            const unsub = onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('adminStudentList');
                if (!listEl) { console.error("adminStudentList not found"); return; }
                listEl.innerHTML = snapshot.empty ? '<p>No students.</p>' : snapshot.docs.map(d => `<div class="bg-gray-700 p-3 rounded-lg flex justify-between items-center"><div><span>${d.data().name} (${d.data().class||'N/A'})</span><span class="text-green-400 block text-sm">₹${d.data().balance.toFixed(2)}</span></div><button data-id="${d.id}" data-name="${d.data().name}" class="btn-delete-student bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg text-sm">Delete</button></div>`).join('');
                document.querySelectorAll('.btn-delete-student').forEach(btn => {
                    btn.onclick = (e) => showConfirm(`Delete "${e.currentTarget.dataset.name}"?`, () => _deleteStudent(e.currentTarget.dataset.id));
                });
            }, error => console.error("Error loading students:", error)); currentUnsubscribes.push(unsub);
        }


        function renderMenuList(menu, stallId, isAdminView) {
            if (!menu || menu.length === 0) return '<p class="text-sm text-gray-400">No menu items yet.</p>';

            return menu.map(item => `
                <div class="flex justify-between items-center text-sm bg-gray-600 px-3 py-2 rounded">
                    <div>
                        <span>${item.name}</span>
                        <span class="ml-2 font-medium text-blue-300">₹${item.price.toFixed(2)}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-xs ${item.stock <= 0 ? 'text-red-400 font-bold' : 'text-gray-300'}">(${item.stock || 0} left)</span>
                        ${isAdminView ? `
                        <input type="number" value="${item.stock || 0}" min="0" 
                                class="admin-stock-input bg-gray-700 text-white w-16 text-center rounded px-1 py-0.5 border border-gray-500 focus:ring-blue-500 focus:border-blue-500" 
                                data-item-id="${item.id}" data-stall-id="${stallId}">
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function updateItemStock(stallId, itemId, newStock) {
            const stockValue = parseInt(newStock, 10);
            if (isNaN(stockValue) || stockValue < 0) {
                showAlert("Please enter a valid non-negative stock number.");
                return false;
            }

            showLoading(`Updating stock for item ${itemId}...`);
            const stallDocRef = doc(stallsRef(), stallId);
            try {
                await runTransaction(db, async (transaction) => {
                    const stallDoc = await transaction.get(stallDocRef);
                    if (!stallDoc.exists()) throw new Error("Stall not found.");

                    const stallData = stallDoc.data();
                    const menu = stallData.menu || [];
                    const itemIndex = menu.findIndex(item => item.id === itemId);

                    if (itemIndex === -1) throw new Error("Menu item not found.");

                    const updatedMenu = menu.map((item, index) =>
                        index === itemIndex ? { ...item, stock: stockValue } : item
                    );

                    transaction.update(stallDocRef, { menu: updatedMenu });
                });
                console.log(`Stock updated for ${itemId} in stall ${stallId} to ${stockValue}`);
                hideLoading();
                return true;
            } catch (error) {
                console.error("Update Stock Error:", error);
                showAlert(`Error updating stock: ${error.message}`);
                hideLoading();
                return false;
            }
        }


        function loadAdminStallsAndMenus() {
            const q = query(stallsRef());
            const unsub = onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('adminStallMenuList');
                const selectEl = document.getElementById('adminStallSelect');
                 if (!listEl || !selectEl) { console.error("Missing stall list/select elements"); return; }


                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-gray-400">No stalls.</p>'; selectEl.innerHTML = '<option value="">No stalls</option>'; return;
                 }

                listEl.innerHTML = snapshot.docs.map(doc => {
                    const stall = doc.data();
                    return `<div class="bg-gray-700 p-4 rounded-lg">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="text-lg font-semibold">${stall.name}</h4>
                                    <button data-id="${stall.ownerId}" data-name="${stall.name}" class="btn-delete-stall bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg text-sm">Delete</button>
                                </div>
                                <div id="menu-list-${stall.ownerId}" class="mt-2 space-y-1">
                                    ${renderMenuList(stall.menu, doc.id, true)} 
                                </div>
                            </div>`;
                }).join('');

                selectEl.innerHTML = snapshot.docs.map(doc => `<option value="${doc.id}">${doc.data().name}</option>`).join('');

                document.querySelectorAll('.btn-delete-stall').forEach(btn => {
                    btn.onclick = (e) => showConfirm(`Delete stall "${e.currentTarget.dataset.name}"?`, () => _deleteStall(e.currentTarget.dataset.id));
                });

                listEl.removeEventListener('change', handleStockInputChange);
                listEl.addEventListener('change', handleStockInputChange);

            }, error => console.error("Error loading stalls:", error));
            currentUnsubscribes.push(unsub);
        }

        async function handleStockInputChange(e) {
            if (e.target.classList.contains('admin-stock-input')) {
                const stallId = e.target.dataset.stallId;
                const itemId = e.target.dataset.itemId;
                const newStock = e.target.value;
                const success = await updateItemStock(stallId, itemId, newStock);
                if (!success) {
                   const stallData = appState.allStallMenus[stallId]; 
                   const oldStock = stallData?.menu?.find(i=>i.id===itemId)?.stock ?? 0;
                   e.target.value = oldStock;
                }
            }
        }


        async function _deleteStall(stallId) {
            if (!stallId) return; showLoading('Deleting...');
            try { await deleteDoc(doc(usersRef(), stallId)); await deleteDoc(doc(stallsRef(), stallId)); }
            catch (e) { showAlert('Error: ' + e.message); } finally { hideLoading(); }
        }
        async function _deleteStudent(studentId) {
             if (!studentId) return; showLoading('Deleting...');
            try { await deleteDoc(doc(usersRef(), studentId)); }
            catch (e) { showAlert('Error: ' + e.message); } finally { hideLoading(); }
        }

        async function addMenuItem() {
            const stallSelect = document.getElementById('adminStallSelect');
            const nameInput = document.getElementById('adminItemName');
            const priceInput = document.getElementById('adminItemPrice');
            const stockInput = document.getElementById('adminItemStock');
             if (!stallSelect || !nameInput || !priceInput || !stockInput) { console.error("Missing elements for adding menu item"); return; }
           
            const stallId = stallSelect.value;
            const name = nameInput.value;
            const price = parseFloat(priceInput.value);
            const stock = parseInt(stockInput.value, 10);

            if (!stallId || !name || isNaN(price) || price <= 0 || isNaN(stock) || stock < 0) {
                showAlert('Please fill out all fields with valid values (price > 0, stock >= 0).');
                return;
            }

            showLoading('Adding item...');
            try {
                const stallDocRef = doc(stallsRef(), stallId);
                const newItem = {
                    id: 'item_' + crypto.randomUUID(), name, price, stock
                };
                await updateDoc(stallDocRef, { menu: arrayUnion(newItem) });

                nameInput.value = '';
                priceInput.value = '';
                stockInput.value = '';
                showAlert('Menu item added!');
            } catch (error) { showAlert('Error adding item.'); console.error(error); } finally { hideLoading(); }
        }


        function loadAdminReports() {
             let allTx = []; let studentMap = new Map();
            const unsubTx = onSnapshot(query(transactionsRef()), snap => { allTx = snap.docs.map(d=>d.data()); _recalculateAdminReports(allTx, studentMap); }, e => console.error("Error loading transactions:", e));
            const unsubUsers = onSnapshot(query(usersRef(), where('role', '==', 'student')), snap => { studentMap = new Map(snap.docs.map(d=>[d.id, d.data().class || 'N/A'])); _recalculateAdminReports(allTx, studentMap); }, e => console.error("Error loading users for report:", e));
            currentUnsubscribes.push(unsubTx, unsubUsers);
        }

        function _recalculateAdminReports(transactions, studentClassMap) {
            const listEl = document.getElementById('adminTransactionList');
            const totalSalesEl = document.getElementById('adminTotalSales');
            const totalRechargedEl = document.getElementById('adminTotalRecharged');
            const outstandingBalanceEl = document.getElementById('adminOutstandingBalance');
            const totalTransactionsEl = document.getElementById('adminTotalTransactions');
            const avgPurchaseValueEl = document.getElementById('adminAvgPurchaseValue');
            const stallSalesEl = document.getElementById('adminStallSalesSummary');
            const topItemsEl = document.getElementById('adminTopItemsList');
            const classSpendingEl = document.getElementById('adminClassSpendingSummary');

            if (!listEl || !totalSalesEl || !totalRechargedEl || !outstandingBalanceEl || !totalTransactionsEl || !avgPurchaseValueEl || !stallSalesEl || !topItemsEl || !classSpendingEl) {
                console.error("One or more report elements are missing from the DOM.");
                return;
            }

            let totalSales = 0, totalRecharged = 0, purchaseCount = 0, rechargeCount = 0;
            const stallSales = {}, topItems = {}, classSpending = {};

             if (transactions.length === 0) {
                 listEl.innerHTML = '<p class="text-gray-400">No transactions yet.</p>';
                 totalSalesEl.textContent = '₹0.00';
                 totalRechargedEl.textContent = '₹0.00';
                 outstandingBalanceEl.textContent = '₹0.00';
                 totalTransactionsEl.textContent = '0';
                 avgPurchaseValueEl.textContent = '₹0.00';
                 stallSalesEl.innerHTML = '<p class="text-gray-400 text-sm">No sales yet.</p>';
                 topItemsEl.innerHTML = '<p class="text-gray-400 text-sm">No items sold yet.</p>';
                 classSpendingEl.innerHTML = '<p class="text-gray-400 text-sm">No spending data yet.</p>';
                 return;
             }

            transactions.forEach(tx => {
                if (tx.type === 'purchase') {
                    totalSales += tx.amount; purchaseCount++;
                    stallSales[tx.stallName] = (stallSales[tx.stallName] || 0) + tx.amount;
                    if (tx.items) tx.items.forEach(item => topItems[item.name] = (topItems[item.name] || 0) + item.quantity);
                    const studentClass = studentClassMap.get(tx.studentId) || 'N/A';
                    classSpending[studentClass] = (classSpending[studentClass] || 0) + tx.amount;
                } else if (tx.type === 'recharge') { totalRecharged += tx.amount; rechargeCount++; }
            });

            const outstanding = totalRecharged - totalSales; const totalTx = purchaseCount + rechargeCount;
            const avgPurchase = purchaseCount > 0 ? totalSales / purchaseCount : 0;

            totalRechargedEl.textContent = `₹${totalRecharged.toFixed(2)}`;
            totalSalesEl.textContent = `₹${totalSales.toFixed(2)}`;
            outstandingBalanceEl.textContent = `₹${outstanding.toFixed(2)}`;
            totalTransactionsEl.textContent = totalTx;
            avgPurchaseValueEl.textContent = `₹${avgPurchase.toFixed(2)}`;

            const renderSummary = (element, data, formatFn) => {
                 element.innerHTML = Object.keys(data).length > 0 ? Object.entries(data).sort((a,b)=>b[1]-a[1]).map(formatFn).join('') : '<p class="text-gray-400 text-sm">No data.</p>';
            };

            renderSummary(stallSalesEl, stallSales, ([name, amt]) => `<div class="flex justify-between p-2 bg-gray-700 rounded"><span>${name}</span><span class="font-medium">₹${amt.toFixed(2)}</span></div>`);
            renderSummary(topItemsEl, topItems, ([name, qty]) => `<div class="flex justify-between p-2 bg-gray-700 rounded"><span class="font-medium">${name}</span><span>${qty} sold</span></div>`);
            renderSummary(classSpendingEl, classSpending, ([name, amt]) => `<div class="flex justify-between p-2 bg-gray-700 rounded"><span>Class ${name}</span><span class="font-medium">₹${amt.toFixed(2)}</span></div>`);


            listEl.innerHTML = transactions.map(tx => { 
                const time = tx.timestamp ? new Date(tx.timestamp.seconds * 1000).toLocaleTimeString() : '...';
                const itemsStr = tx.items ? tx.items.map(i => `${i.name} (x${i.quantity})`).join(', ') : '';
                if (tx.type === 'purchase') return `<div class="bg-gray-700 p-3 rounded-lg"><p class="font-semibold">${tx.studentName} paid ${tx.stallName}</p><p class="text-sm">${itemsStr}</p><div class="flex justify-between items-center mt-1"><span class="text-red-400 font-bold">- ₹${tx.amount.toFixed(2)}</span><span class="text-xs text-gray-400">${time}</span></div></div>`;
                else return `<div class="bg-gray-700 p-3 rounded-lg"><p class="font-semibold">${tx.studentName} recharged wallet</p><p class="text-sm text-gray-400">Processed by: ${tx.adminName ? 'Admin' : 'Self'}</p><div class="flex justify-between items-center mt-1"><span class="text-green-400 font-bold">+ ₹${tx.amount.toFixed(2)}</span><span class="text-xs text-gray-400">${time}</span></div></div>`;
             }).reverse().join('');
            appState.allTransactionsForExport = transactions;
        }

        function exportTransactionsToCSV() {
            if (appState.allTransactionsForExport.length === 0) return showAlert('No transactions.');
            const escapeCSV = (str) => `"${(str || '').replace(/"/g, '""')}"`;
            let csv = "Date,Time,Type,Student,Amount,Stall,Items,Processor\r\n";
            appState.allTransactionsForExport.forEach(tx => {
                const dt = tx.timestamp ? new Date(tx.timestamp.seconds * 1000) : new Date();
                const itemsStr = tx.items ? tx.items.map(i => `${i.name}(x${i.quantity})`).join("|") : 'N/A';
                const processor = tx.adminName || 'Self';
                csv += [dt.toLocaleDateString(), dt.toLocaleTimeString(), tx.type, escapeCSV(tx.studentName), tx.amount.toFixed(2), escapeCSV(tx.stallName||'N/A'), escapeCSV(itemsStr), escapeCSV(processor)].join(',') + "\r\n";
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI("data:text/csv;charset=utf-8," + csv));
            link.setAttribute("download", `tx_${new Date().toISOString().split('T')[0]}.csv`);
            link.click();
       }

        // --- STUDENT DASHBOARD LOGIC ---
        function attachStudentDashboardListeners() { 
            const btnLogout = document.getElementById('btnStudentLogout');
            const btnBack = document.getElementById('btnStudentBack');
            const btnPrint = document.getElementById('btnStudentPrintPass');
            const btnDownload = document.getElementById('btnStudentDownloadQR');

            if(btnLogout) btnLogout.onclick = logout;
            else console.error("btnStudentLogout not found");
            if(btnBack) btnBack.onclick = logout;
             else console.error("btnStudentBack not found");
            if(btnPrint) btnPrint.onclick = () => printPass('student-printable-pass');
             else console.error("btnStudentPrintPass not found");
            if(btnDownload) btnDownload.onclick = () => downloadQR('studentPassQR', appState.currentUser?.name || 'student');
            else console.error("btnStudentDownloadQR not found");
        }


        function loadStudentDashboard() { 
            showView('studentDashboard');
            const user = appState.currentUser;
            if (!user) { logout(); return; }

            const updateText = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; else console.error(`${id} not found`); };
           
            updateText('studentName', user.name);
            updateText('studentIdDisplay', `ID: ${user.id}`);
            updateText('studentPassName', user.name);
            updateText('studentPassClass', user.class || 'N/A');
           
            const qrContainer = document.getElementById('studentPassQR'); 
            if (qrContainer) {
                 qrContainer.innerHTML = '';
                 new QRCode(qrContainer, { text: user.id, width: 200, height: 200 });
            } else { console.error("studentPassQR container not found"); }

            const unsubBalance = onSnapshot(doc(usersRef(), user.id), (docSnap) => {
                const balanceEl = document.getElementById('studentBalance');
                if (docSnap.exists()) {
                    appState.currentUser.balance = docSnap.data().balance;
                    if(balanceEl) balanceEl.textContent = `₹${docSnap.data().balance.toFixed(2)}`;
                     else console.error("studentBalance element not found");
                } else logout();
            }, error => { console.error("Error listening to balance:", error); logout(); }); 
            currentUnsubscribes.push(unsubBalance);

            loadStudentStallList();
            loadStudentTransactionHistory();
        }

        function loadStudentStallList() {
            const listEl = document.getElementById('studentStallList');
             if (!listEl) { console.error("studentStallList not found"); return; }
            const stallsData = Object.values(appState.allStallMenus);

            if (!stallsData || stallsData.length === 0) {
                listEl.innerHTML = '<p class="text-gray-400">No stalls are open yet.</p>';
                return;
            }

            listEl.innerHTML = stallsData.map(stall => `
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h4 class="text-xl font-semibold text-blue-300">${stall.name}</h4>
                    <div class="mt-2 space-y-1">
                        ${renderMenuList(stall.menu, null, false)} 
                    </div>
                </div>
            `).join('');
        }

        function loadStudentTransactionHistory() { 
            if (!appState.currentUser) return;
            const q = query(transactionsRef(), where('studentId', '==', appState.currentUser.id));
            const listEl = document.getElementById('studentTransactionList');
             if (!listEl) { console.error("studentTransactionList not found"); return; }
            const unsub = onSnapshot(q, (snapshot) => {
                listEl.innerHTML = snapshot.empty ? '<p class="text-gray-400">No history.</p>' : snapshot.docs.map(d => {
                    const tx = d.data(); const time = tx.timestamp ? new Date(tx.timestamp.seconds * 1000).toLocaleString() : '...';
                    const itemsStr = tx.items ? tx.items.map(i => `${i.name} (x${i.quantity})`).join(', ') : '';
                    if (tx.type === 'purchase') return `<div class="bg-gray-700 p-3 rounded-lg"><p class="font-semibold">Paid ${tx.stallName}</p><p class="text-sm">${itemsStr}</p><div class="flex justify-between items-center mt-1"><span class="text-red-400 font-bold">- ₹${tx.amount.toFixed(2)}</span><span class="text-xs text-gray-400">${time}</span></div></div>`;
                    else return `<div class="bg-gray-700 p-3 rounded-lg"><p class="font-semibold">Wallet Recharge</p><p class="text-sm text-gray-400">Processed by: ${tx.adminName?'Admin':'Self'}</p><div class="flex justify-between items-center mt-1"><span class="text-green-400 font-bold">+ ₹${tx.amount.toFixed(2)}</span><span class="text-xs text-gray-400">${time}</span></div></div>`;
                }).reverse().join('');
            }, error => console.error("Error loading student history:", error)); currentUnsubscribes.push(unsub);
        }

        // --- STALL DASHBOARD LOGIC ---
        function attachStallDashboardListeners() { 
            const btnLogout = document.getElementById('btnStallLogout');
            const btnBack = document.getElementById('btnStallBack');
            const btnScan = document.getElementById('btnStallScanToPay');

            if(btnLogout) btnLogout.onclick = logout;
            else console.error("btnStallLogout not found");
            if(btnBack) btnBack.onclick = logout;
            else console.error("btnStallBack not found");
            if(btnScan) btnScan.onclick = startStallPaymentScan;
             else console.error("btnStallScanToPay not found");
        }

        function loadStallDashboard() {
            if (!appState.currentUser) { logout(); return; }
            showView('stallDashboard');
           
            const stallNameEl = document.getElementById('stallName');
            if (stallNameEl) stallNameEl.textContent = appState.currentUser.name;
            else console.error("stallName element not found");

            const stallDocRef = doc(stallsRef(), appState.currentUser.id);
            const unsubMenu = onSnapshot(stallDocRef, (docSnap) => {
                 const menuEl = document.getElementById('stallMenuList');
                 if (!menuEl) { console.error("stallMenuList not found"); return; }
                if (docSnap.exists()) {
                    const stall = docSnap.data();
                    menuEl.innerHTML = renderMenuList(stall.menu, null, false);
                    appState.currentUser.menu = stall.menu;
                } else logout();
            }, error => { console.error("Error loading stall menu:", error); logout(); });

            const q = query(transactionsRef(), where('stallId', '==', appState.currentUser.id));
            const listEl = document.getElementById('stallSaleList');
            const totalEl = document.getElementById('stallTotalSales');
            if (!listEl || !totalEl) { console.error("Missing stall sales list/total elements"); return;}

            const unsubHistory = onSnapshot(q, (snapshot) => {
                let totalSales = 0;
                listEl.innerHTML = snapshot.empty ? '<p class="text-gray-400">No sales.</p>' : snapshot.docs.map(d => {
                    const tx = d.data(); totalSales += tx.amount; const time = tx.timestamp ? new Date(tx.timestamp.seconds * 1000).toLocaleString() : '...';
                     const itemsStr = tx.items ? tx.items.map(i => `${i.name} (x${i.quantity})`).join(', ') : '';
                    return `<div class="bg-gray-700 p-3 rounded-lg"><p class="font-semibold">Sale to ${tx.studentName}</p><p class="text-sm">${itemsStr}</p><div class="flex justify-between items-center mt-1"><span class="text-green-400 font-bold">+ ₹${tx.amount.toFixed(2)}</span><span class="text-xs text-gray-400">${time}</span></div></div>`;
                }).reverse().join('');
                totalEl.textContent = `₹${totalSales.toFixed(2)}`;
            }, error => console.error("Error loading stall sales history:", error));
            currentUnsubscribes.push(unsubMenu, unsubHistory);
        }

        // --- STALL PAYMENT VIEW LOGIC ---
        function attachStallPaymentListeners() { 
            const btnCancel = document.getElementById('btnStallPaymentCancel');
            const btnConfirm = document.getElementById('btnStallConfirmPayment');
            if (btnCancel) btnCancel.onclick = () => loadStallDashboard();
             else console.error("btnStallPaymentCancel not found");
            if (btnConfirm) btnConfirm.onclick = processPayment;
            else console.error("btnStallConfirmPayment not found");
        }


        function startStallPaymentScan() {
             showView('stallPayment');
            appState.scannedStudentId = null; appState.stallCart = {};
            const detailsEl = document.getElementById('stallPaymentDetails');
            const scannerContainer = document.getElementById('stall-qr-reader-container');
            const confirmBtn = document.getElementById('btnStallConfirmPayment');
             if (!detailsEl || !scannerContainer || !confirmBtn) { console.error("Missing elements for stall payment scan"); return; }

            detailsEl.classList.add('hidden');
            scannerContainer.classList.remove('hidden');
            confirmBtn.classList.add('hidden');
           
            if (!stallQrScanner) {
                 try { stallQrScanner = new Html5Qrcode("stall-qr-reader"); } 
                 catch(e) { console.error("Failed to init stall scanner:", e); showAlert("Scanner failed"); loadStallDashboard(); return; }
            }
            stallQrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async (text) => {
                stopAllScanners(); showLoading('Fetching Student...');
                try {
                    const userDoc = await getDoc(doc(usersRef(), text));
                    if (!userDoc.exists() || userDoc.data().role !== 'student') throw new Error('Invalid student QR.');
                    const student = userDoc.data();
                    appState.scannedStudentId = text; appState.scannedStudentName = student.name;
                    scannerContainer.classList.add('hidden');
                    detailsEl.classList.remove('hidden');
                    confirmBtn.classList.remove('hidden');
                   
                    const nameEl = document.getElementById('stallPaymentStudentName');
                    const balanceEl = document.getElementById('stallPaymentStudentBalance');
                    if(nameEl) nameEl.textContent = student.name;
                    if(balanceEl) balanceEl.textContent = `₹${student.balance.toFixed(2)}`;

                    buildCartUI(student.balance);
                } catch (e) { showAlert(e.message); loadStallDashboard(); } finally { hideLoading(); }
            }, (e) => {/*console.warn(e)*/}).catch(err => { showAlert("Camera error."); loadStallDashboard(); });
        }


        function buildCartUI(studentBalance) { 
            const cartEl = document.getElementById('stallCart');
             if (!cartEl) { console.error("stallCart element not found"); return; }
            const menu = appState.currentUser?.menu || [];
            if (menu.length === 0) { 
                cartEl.innerHTML = '<p class="text-yellow-400">Stall menu not available.</p>'; 
                const confirmBtn = document.getElementById('btnStallConfirmPayment');
                if(confirmBtn) confirmBtn.classList.add('hidden');
                return; 
            }
            cartEl.innerHTML = menu.map(item => `
                <div class="bg-gray-700 p-3 rounded-lg flex items-center justify-between">
                    <div>
                        <p class="font-semibold">${item.name}</p>
                        <p class="text-sm text-blue-300">₹${item.price.toFixed(2)}</p>
                    </div>
                    <div class="flex items-center space-x-3">
                         <span class="text-xs ${item.stock <= 0 ? 'text-red-400 font-bold' : 'text-gray-300'}">(${item.stock || 0} left)</span>
                        <button data-id="${item.id}" class="btn-cart-change bg-red-600 w-8 h-8 rounded-full font-bold text-lg">-</button>
                        <span id="cart-qty-${item.id}" class="text-xl font-bold w-10 text-center">0</span>
                        <button data-id="${item.id}" class="btn-cart-change bg-green-600 w-8 h-8 rounded-full font-bold text-lg">+</button>
                    </div>
                </div>
            `).join('');
            document.querySelectorAll('.btn-cart-change').forEach(btn => {
                btn.onclick = (e) => updateCart(e.target.dataset.id, e.target.textContent === '+', studentBalance);
            });
            updateCartTotal(studentBalance);
        }

        function updateCart(itemId, isIncrement, studentBalance) {
            let currentQty = appState.stallCart[itemId] || 0;
            const menuMap = new Map((appState.currentUser?.menu || []).map(i => [i.id, i]));
            const item = menuMap.get(itemId);
            if (!item) { console.error(`Item ${itemId} not found in stall menu`); return; }
            const itemStock = item.stock || 0; 

            if (isIncrement) {
                if (currentQty >= itemStock) {
                    showAlert(`Cannot add more ${item.name}, only ${itemStock} available.`);
                    return; 
                }
                currentQty++;
            } else {
                currentQty = Math.max(0, currentQty - 1);
            }

            if (currentQty === 0) delete appState.stallCart[itemId];
            else appState.stallCart[itemId] = currentQty;

            const qtyEl = document.getElementById(`cart-qty-${itemId}`);
            if (qtyEl) qtyEl.textContent = currentQty;
            else console.error(`cart-qty-${itemId} element not found`);
            updateCartTotal(studentBalance);
        }


        function updateCartTotal(studentBalance) { 
             const totalEl = document.getElementById('stallCartTotal');
            const confirmBtn = document.getElementById('btnStallConfirmPayment');
             if (!totalEl || !confirmBtn) { console.error("Missing cart total/confirm button elements"); return; }

            const menuMap = new Map((appState.currentUser?.menu||[]).map(i=>[i.id, i]));
            let total = 0;
            for (const [id, qty] of Object.entries(appState.stallCart)) { total += (menuMap.get(id)?.price || 0) * qty; }
            totalEl.textContent = `₹${total.toFixed(2)}`;
            const canAfford = total <= studentBalance; const hasItems = total > 0;
            totalEl.classList.toggle('text-red-500', !canAfford); totalEl.classList.toggle('text-green-400', canAfford);
            confirmBtn.disabled = !canAfford || !hasItems;
            confirmBtn.classList.toggle('opacity-50', !canAfford || !hasItems); confirmBtn.classList.toggle('cursor-not-allowed', !canAfford || !hasItems);
        }

        async function processPayment() {
             if (!appState.currentUser || !appState.scannedStudentId) {
                 showAlert("Error: Missing user or scanned student data.");
                 return;
            }
            const menuMap = new Map((appState.currentUser.menu || []).map(i => [i.id, i]));
            let totalAmount = 0;
            const cartItemsForTx = []; 
            const itemsToUpdateStock = []; 

            for (const [itemId, quantity] of Object.entries(appState.stallCart)) {
                if (quantity > 0) {
                    const item = menuMap.get(itemId);
                    if (!item) {showAlert(`Error: Item ${itemId} not found in menu.`); return;} 
                    totalAmount += item.price * quantity;
                    cartItemsForTx.push({ id: itemId, name: item.name, price: item.price, quantity: quantity });
                    itemsToUpdateStock.push({ id: itemId, quantity });
                }
            }

            if (totalAmount === 0) return showAlert('Cart is empty.');

            showLoading('Processing Payment...');
            const studentId = appState.scannedStudentId;
            const stallId = appState.currentUser.id;
            const studentDocRef = doc(usersRef(), studentId);
            const stallDocRef = doc(stallsRef(), stallId); 

            try {
                await runTransaction(db, async (transaction) => {
                    // 1. Get student and stall data
                    const studentDoc = await transaction.get(studentDocRef);
                    const stallDoc = await transaction.get(stallDocRef);
                    if (!studentDoc.exists()) throw new Error("Student not found.");
                    if (!stallDoc.exists()) throw new Error("Stall not found.");

                    // 2. Check balance
                    const studentBalance = studentDoc.data().balance;
                    if (studentBalance < totalAmount) throw new Error("Insufficient student balance.");

                    // 3. Check stock and prepare stock updates
                    const currentMenu = stallDoc.data().menu || [];
                    const updatedMenu = [...currentMenu]; 
                    let stockError = null;

                    for (const itemUpdate of itemsToUpdateStock) {
                        const itemIndex = updatedMenu.findIndex(i => i.id === itemUpdate.id);
                        if (itemIndex === -1) { stockError = `Item ${itemUpdate.id} missing.`; break; }
                        const currentStock = updatedMenu[itemIndex].stock || 0;
                        if (currentStock < itemUpdate.quantity) { stockError = `Stock error for ${updatedMenu[itemIndex].name}. ${currentStock} left.`; break; }
                        updatedMenu[itemIndex] = { ...updatedMenu[itemIndex], stock: currentStock - itemUpdate.quantity };
                    }
                    if (stockError) throw new Error(stockError); // Abort

                    // 4. Update balance
                    transaction.update(studentDocRef, { balance: increment(-totalAmount) });
                    // 5. Update stock
                    transaction.update(stallDocRef, { menu: updatedMenu });
                    // 6. Log transaction
                    transaction.set(doc(transactionsRef()), { studentId, studentName: appState.scannedStudentName, stallId, stallName: appState.currentUser.name, amount: totalAmount, items: cartItemsForTx, type: 'purchase', timestamp: serverTimestamp() });
                });
                showAlert('Payment Successful!');
                loadStallDashboard(); 
            } catch (error) {
                console.error("Payment Error:", error);
                showAlert(`Payment Failed: ${error.message}`);
                hideLoading(); 
            }
        }


        // --- ADMIN RECHARGE VIEW LOGIC ---
        function attachAdminRechargeListeners() { 
            const btnCancel = document.getElementById('btnAdminRechargeCancel');
            const btnConfirm = document.getElementById('btnAdminConfirmRecharge');
             if(btnCancel) btnCancel.onclick = () => loadAdminDashboard();
             else console.error("btnAdminRechargeCancel not found");
             if(btnConfirm) btnConfirm.onclick = processAdminRecharge;
             else console.error("btnAdminConfirmRecharge not found");
        }

        function startAdminRechargeScan() { 
            showView('adminRecharge'); appState.scannedStudentId=null;
            const detailsEl = document.getElementById('adminRechargeDetails');
            const scannerContainer = document.getElementById('admin-recharge-qr-reader-container');
            const confirmBtn = document.getElementById('btnAdminConfirmRecharge');
            const amountInput = document.getElementById('adminRechargeAmount');
             if (!detailsEl || !scannerContainer || !confirmBtn || !amountInput) { console.error("Missing elements for admin recharge scan"); return; }


            detailsEl.classList.add('hidden');
            scannerContainer.classList.remove('hidden');
            confirmBtn.classList.add('hidden');
            amountInput.value = '';
           
            if(!adminRechargeQrScanner) {
                 try { adminRechargeQrScanner = new Html5Qrcode("admin-recharge-qr-reader"); } 
                 catch(e) { console.error("Failed to init admin recharge scanner:", e); showAlert("Scanner failed"); loadAdminDashboard(); return; }
            }
            adminRechargeQrScanner.start({facingMode:"environment"},{fps:10,qrbox:250}, async (text)=>{
                stopAllScanners(); showLoading('Fetching...');
                try {
                    const userDoc = await getDoc(doc(usersRef(),text));
                    if(!userDoc.exists() || userDoc.data().role !== 'student') throw new Error('Invalid student QR.');
                    const student = userDoc.data(); appState.scannedStudentId=text; appState.scannedStudentName=student.name;
                    scannerContainer.classList.add('hidden');
                    detailsEl.classList.remove('hidden');
                    confirmBtn.classList.remove('hidden');

                    const nameEl = document.getElementById('adminRechargeStudentName');
                    const balanceEl = document.getElementById('adminRechargeStudentBalance');
                    if (nameEl) nameEl.textContent = `${student.name} (${student.class||'N/A'})`;
                     else console.error("adminRechargeStudentName not found");
                    if (balanceEl) balanceEl.textContent = `₹${student.balance.toFixed(2)}`;
                    else console.error("adminRechargeStudentBalance not found");

                } catch(e) { showAlert(e.message); loadAdminDashboard(); } finally { hideLoading(); }
            }, (e)=>{/*console.warn(e)*/}).catch(err=>{showAlert("Camera error."); loadAdminDashboard();});
        }
       
        async function processAdminRecharge() { 
             const amountInput = document.getElementById('adminRechargeAmount');
             if (!amountInput) { console.error("adminRechargeAmount input not found"); return; }
            const amount = parseFloat(amountInput.value);
            if (!amount || amount <= 0) return showAlert('Invalid amount.');
             if (!appState.scannedStudentId) { showAlert("No student scanned."); return; }

            showLoading('Processing...'); const studentId = appState.scannedStudentId; const studentRef = doc(usersRef(), studentId);
            try {
                await runTransaction(db, async tx => {
                    const studentDoc = await tx.get(studentRef); if (!studentDoc.exists()) throw new Error("Student not found.");
                    tx.update(studentRef, { balance: increment(amount) });
                    tx.set(doc(transactionsRef()), { studentId, studentName:appState.scannedStudentName, amount, type:'recharge', adminName:appState.currentUser?.id || 'admin', timestamp:serverTimestamp() });
                });
                showAlert('Recharge OK!'); loadAdminDashboard();
            } catch (e) { showAlert(`Error: ${e.message}`); } finally { hideLoading(); }
        }


    </script>

    <style>
        .spinner { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media print {
            body * { visibility: hidden; } .print-this-one, .print-this-one * { visibility: visible; }
            .print-this-one { position: absolute; left: 0; top: 0; width: 100%; max-width: 100%; margin: 0; padding: 20px; border: none !important; box-shadow: none !important; background-color: white !important; }
            .print-this-one div[id^="qr-code-inner-"], .print-this-one #studentPassQR { background-color: white !important; }
            .print-this-one, .print-this-one * { color: #000 !important; background-color: white !important; }
            .print-hide { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans antialiased">

    <!-- Main Container --><div class="container mx-auto p-4 max-w-lg min-h-screen pb-16">

        <!-- VIEW: Home --><div id="homeView" class="">
             <header class="text-center my-12"> <h1 class="text-4xl font-bold text-blue-400 mb-2">Smart QR Event Wallet</h1> <p class="text-lg text-gray-300">Udaya Public School - Annual Fest 2025-26</p> </header>
            <main class="space-y-6"> <button id="btnAdminLogin" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg text-lg transition-all">Admin Login</button> <button id="btnStallLogin" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg text-lg transition-all">Stall Login (Scan QR)</button> <button id="btnStudentLogin" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg text-lg transition-all">Student Login (Scan QR)</button> </main>
        </div>

        <!-- VIEW: Admin Login --><div id="adminLoginView" class="hidden">
             <header class="my-8"> <div class="flex items-center space-x-3 mb-4"> <div> <h2 class="text-lg font-semibold text-white">Udaya Public School</h2> <p class="text-sm text-gray-400">Annual Fest 2025-26</p> </div> </div> <button id="btnAdminLoginBack" class="text-blue-400 hover:text-blue-300">&larr; Back to Home</button> <h1 class="text-3xl font-bold text-center text-red-400 mt-4">Admin Login</h1> </header>
            <main class="space-y-4 bg-gray-800 p-6 rounded-lg shadow-xl"> <div> <label for="adminPassword" class="block text-sm font-medium text-gray-300 mb-1">Password</label> <input type="password" id="adminPassword" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3 focus:ring-red-500 focus:border-red-500" placeholder="••••••••"> </div> <button id="btnAdminLoginSubmit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all"> Login </button> <button id="btnAdminResetPassword" type="button" class="w-full text-center text-xs text-gray-400 hover:text-white mt-4"> Forgot Password? Reset to default </button> </main>
        </div>

        <!-- VIEW: Admin Dashboard --><div id="adminDashboardView" class="hidden">
            <header class="my-8 flex justify-between items-center"> <div class="flex items-center space-x-3"> <div> <h1 class="text-3xl font-bold text-red-400">Admin Dashboard</h1> <p class="text-sm text-gray-400">Udaya Public School</p> </div> </div> <button id="btnAdminLogout" class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg text-sm transition-all self-start">Logout</button> </header>
            <!-- Admin Tabs --><div class="mb-4 border-b border-gray-700"> <nav class="flex space-x-1" aria-label="Tabs"> <button data-target="panel-students" class="admin-tab bg-blue-600 text-white px-4 py-3 rounded-t-lg font-medium text-sm">Students</button> <button data-target="panel-stalls" class="admin-tab bg-gray-700 text-gray-300 px-4 py-3 rounded-t-lg font-medium text-sm">Stalls</button> <button data-target="panel-classes" class="admin-tab bg-gray-700 text-gray-300 px-4 py-3 rounded-t-lg font-medium text-sm">Classes</button> <button data-target="panel-reports" class="admin-tab bg-gray-700 text-gray-300 px-4 py-3 rounded-t-lg font-medium text-sm">Reports</button> </nav> </div>
            <main class="space-y-6">
                <!-- Panel 1: Manage Students -->
                <div id="panel-students" class="admin-tab-panel space-y-6">
                     <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h2 class="text-2xl font-semibold mb-4 text-blue-300">Generate Student</h2> <div class="space-y-4"> <input type="text" id="adminStudentName" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Student Name"> <select id="adminStudentClassSelect" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3"> <option value="">Select a Class</option> </select> <button id="btnAdminGenerateStudent" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all"> Generate Student QR </button> <div id="adminStudentQRContainer" class="mt-4"> </div> <button id="btnAdminRechargeStudent" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all mt-4"> Recharge Student (Scan QR) </button> </div> </section>
                     <!-- MODIFIED: Added btnDownloadAllPasses -->
                     <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h2 class="text-2xl font-semibold mb-4 text-yellow-300">Find Student QR by Class</h2> <div class="space-y-4"> <div> <label class="block text-sm font-medium text-gray-300 mb-1">Select Class</label> <select id="adminSearchClassSelect" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3"> <option value="">Select a Class</option> </select> </div> <div id="adminStudentListByClass" class="space-y-2 max-h-60 overflow-y-auto"> </div> <button id="btnDownloadAllPasses" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all mt-4 hidden"> Download All Passes for this Class </button> <div id="adminSearchQRContainer" class="mt-4 hidden"> </div> </div> </section>
                     <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h2 class="text-2xl font-semibold mb-4">Current Students</h2> <div id="adminStudentList" class="space-y-2 max-h-60 overflow-y-auto"> </div> </section>
                </div>

                <!-- Panel 2: Manage Stalls -->
                <div id="panel-stalls" class="admin-tab-panel hidden space-y-6">
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h2 class="text-2xl font-semibold mb-4 text-green-300">Generate Stall</h2> <div class="space-y-4"> <input type="text" id="adminStallName" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Stall Name (e.g., Pizza Corner)"> <button id="btnAdminGenerateStall" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all"> Generate Stall QR </button> <div id="adminStallQRContainer" class="bg-white p-4 rounded-lg text-black text-center mt-4"> </div> </div> </section>
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h2 class="text-2xl font-semibold mb-4 text-yellow-300">Find Stall QR</h2> <div class="space-y-4"> <input type="text" id="adminSearchStallName" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Enter Full Stall Name"> <button id="btnAdminSearchStall" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all"> Search </button> <div id="adminSearchStallQRContainer" class="bg-white p-4 rounded-lg text-black text-center mt-4 hidden"> </div> </div> </section>
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-semibold mb-4 text-green-300">Add Menu Item</h2>
                        <div class="space-y-4">
                            <div><label class="block text-sm font-medium text-gray-300 mb-1">Select Stall</label><select id="adminStallSelect" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3"></select></div>
                            <input type="text" id="adminItemName" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Item Name">
                            <input type="number" id="adminItemPrice" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Item Price">
                            <input type="number" id="adminItemStock" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Initial Stock (e.g., 50)" min="0">
                            <button id="btnAdminAddMenuItem" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all">Add Item</button>
                        </div>
                    </section>
                    <section>
                        <h2 class="text-2xl font-semibold mb-4">Current Stalls & Menus</h2>
                        <div id="adminStallMenuList" class="space-y-4"> </div>
                    </section>
                </div>

                <!-- Panel 3: Manage Classes -->
                <div id="panel-classes" class="admin-tab-panel hidden space-y-6">
                     <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h2 class="text-2xl font-semibold mb-4 text-purple-300">Add New Class</h2> <div class="space-y-4"> <input type="text" id="adminClassName" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Class Name (e.g., 10-A, 12-C)"> <button id="btnAdminAddClass" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all"> Add Class </button> </div> </section>
                     <section> <h2 class="text-2xl font-semibold mb-4">Current Classes</h2> <div id="adminClassList" class="space-y-3"> </div> </section>
                </div>

                <!-- Panel 4: Reports -->
                <div id="panel-reports" class="admin-tab-panel hidden space-y-6">
                     <section class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-4"> <h2 class="text-2xl font-semibold mb-4 text-yellow-300">Event Financials</h2> <div class="flex justify-between bg-gray-700 p-4 rounded-lg"> <span>Total Recharged:</span> <span id="adminTotalRecharged" class="text-lg font-bold text-green-400">₹0.00</span> </div> <div class="flex justify-between bg-gray-700 p-4 rounded-lg"> <span>Total Sales:</span> <span id="adminTotalSales" class="text-lg font-bold text-red-400">₹0.00</span> </div> <div class="flex justify-between bg-gray-700 p-4 rounded-lg"> <span>Outstanding Balance:</span> <span id="adminOutstandingBalance" class="text-lg font-bold text-blue-400">₹0.00</span> </div> <div class="grid grid-cols-2 gap-4"> <div class="bg-gray-700 p-4 rounded-lg text-center"> <span class="text-sm text-gray-400">Total Transactions</span> <span id="adminTotalTransactions" class="text-2xl font-bold block">0</span> </div> <div class="bg-gray-700 p-4 rounded-lg text-center"> <span class="text-sm text-gray-400">Avg. Purchase</span> <span id="adminAvgPurchaseValue" class="text-2xl font-bold block">₹0.00</span> </div> </div> </section>
                     <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h3 class="text-xl font-semibold mb-2">Sales per Stall</h3> <div id="adminStallSalesSummary" class="space-y-2 max-h-60 overflow-y-auto"> </div> </section>
                     <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h3 class="text-xl font-semibold mb-2">Top-Selling Items</h3> <div id="adminTopItemsList" class="space-y-2 max-h-60 overflow-y-auto"> </div> </section> <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h3 class="text-xl font-semibold mb-2">Total Spending by Class</h3> <div id="adminClassSpendingSummary" class="space-y-2 max-h-60 overflow-y-auto"> </div> </section>
                     <section> <h2 class="text-2xl font-semibold mb-4">All Transactions</h2> <div id="adminTransactionList" class="space-y-3 max-h-96 overflow-y-auto"> </div> <button id="btnExportCSV" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all mt-4"> Export All Transactions to CSV </button> </section>
                </div>
            </main>
        </div>

        <!-- VIEW: Scanner --><div id="scannerView" class="hidden">
            <header class="my-8"> <div class="flex items-center space-x-3 mb-4"> <div> <h2 class="text-lg font-semibold text-white">Udaya Public School</h2> <p class="text-sm text-gray-400">Annual Fest 2025-26</p> </div> </div> <h1 id="scannerTitle" class="text-3xl font-bold text-center text-yellow-300">Scan QR Code</h1> </header>
            <main class="space-y-4"> <div id="qr-reader" class="w-full rounded-lg overflow-hidden border-4 border-gray-700"></div> <button id="btnCancelScan" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all"> Cancel </button> </main>
        </div>

        <!-- VIEW: Student Dashboard --><div id="studentDashboardView" class="hidden">
            <header class="my-8"> <button id="btnStudentBack" class="text-blue-400 hover:text-blue-300 mb-4">&larr; Back to Home (Logout)</button> <div class="flex justify-between items-start"> <div class="flex items-center space-x-3"> <div> <h1 class="text-3xl font-bold text-blue-400">Welcome, <span id="studentName"></span></h1> <p class="text-sm text-gray-400">Udaya Public School</p> </div> </div> <button id="btnStudentLogout" class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg text-sm transition-all self-start flex-shrink-0">Logout</button> </div> <div class="mt-4"> <p id="studentIdDisplay" class="text-sm text-gray-400"></p> <p class="text-lg text-gray-300 mt-4">Your Balance:</p> <p id="studentBalance" class="text-5xl font-extrabold text-green-400">₹0.00</p> </div> </header>
            <main class="space-y-8">
               
                <!-- Entry Pass Section -->
                <section class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-4">
                    <h2 class="text-2xl font-semibold mb-4 text-blue-300">My Entry Pass</h2>
                    <div id="student-printable-pass" class="printable-area bg-white text-black p-6 rounded-lg shadow-lg max-w-xs mx-auto border-4 border-blue-600"> 
                        <div class="text-center border-b pb-4 border-gray-300"> <h3 class="text-xl font-bold text-gray-800">Udaya Public School</h3> <p class="text-xs text-gray-600">Mahadev Jharkhandi, Kunraghat, Gorakhpur</p> </div> 
                        <div class="my-4 text-center"> <p class="text-sm font-medium text-gray-700">ANNUAL FEST 2025-26</p> <p class="text-2xl font-bold text-blue-600">ENTRY PASS</p> <p class="text-sm font-semibold text-gray-700">Date: 1-FEB-2026</p> </div> 
                        <div class="my-4 text-center"> <p id="studentPassName" class="text-lg font-bold text-black">[Student Name]</p> <p class="text-base text-gray-700">Class: <span id="studentPassClass">[Class]</span></p> </div> 
                        <div id="studentPassQR" class="flex justify-center p-4 bg-white rounded-lg"> </div> 
                    </div>
                    <div class="flex space-x-2 mt-4 max-w-xs mx-auto print-hide">
                        <button id="btnStudentPrintPass" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Print Pass</button>
                        <button id="btnStudentDownloadQR" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Download QR</button>
                    </div>
                </section>
                <!-- Stalls & Prices -->
                <section>
                    <h2 class="text-2xl font-semibold mb-4">Stalls & Prices</h2>
                    <div id="studentStallList" class="space-y-4"> </div>
                </section>
                <!-- Transaction History -->
                <section>
                    <h2 class="text-2xl font-semibold mb-4">Transaction History</h2>
                    <div id="studentTransactionList" class="space-y-3 max-h-96 overflow-y-auto"> </div>
                </section>
            </main>
        </div>

        <!-- VIEW: Stall Dashboard --><div id="stallDashboardView" class="hidden">
            <header class="my-8"> <button id="btnStallBack" class="text-blue-400 hover:text-blue-300 mb-4">&larr; Back to Home (Logout)</button> <div class="flex justify-between items-start"> <div class="flex items-center space-x-3"> <div> <h1 class="text-3xl font-bold text-green-400"><span id="stallName"></span></h1> <p class="text-sm text-gray-400">Udaya Public School</p> </div> </div> <button id="btnStallLogout" class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg text-sm transition-all self-start flex-shrink-0">Logout</button> </div> <div class="mt-4"> <p class="text-lg text-gray-300">Total Sales:</p> <p id="stallTotalSales" class="text-5xl font-extrabold text-white">₹0.00</p> </div> </header>
            <main class="space-y-8">
                <section><button id="btnStallScanToPay" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-6 px-6 rounded-lg shadow-lg text-2xl transition-all">Scan Student QR to Pay</button></section>
                <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h2 class="text-2xl font-semibold mb-4">My Menu</h2> <div id="stallMenuList" class="space-y-2"> </div> </section>
                <section> <h2 class="text-2xl font-semibold mb-4">Sales History</h2> <div id="stallSaleList" class="space-y-3 max-h-96 overflow-y-auto"> </div> </section>
            </main>
        </div>

        <!-- VIEW: Stall Payment --><div id="stallPaymentView" class="hidden">
            <header class="my-8"> <div class="flex items-center space-x-3 mb-4"> <div> <h2 class="text-lg font-semibold text-white">Udaya Public School</h2> <p class="text-sm text-gray-400">Annual Fest 2025-26</p> </div> </div> <h1 class="text-3xl font-bold text-center text-blue-400">Process Payment</h1> </header>
            <main class="space-y-6">
                 <div id="stall-qr-reader-container"> <p class="text-center text-lg text-yellow-300 mb-4">Scanning for Student QR...</p> <div id="stall-qr-reader" class"w-full rounded-lg overflow-hidden border-4 border-gray-700"></div> </div>
                <div id="stallPaymentDetails" class="hidden space-y-6">
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h2 class="text-2xl font-semibold mb-2">Student Details</h2> <div class="flex justify-between items-center"> <span id="stallPaymentStudentName" class="text-xl"></span> <span id="stallPaymentStudentBalance" class="text-xl font-bold text-green-400"></span> </div> </section>
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h2 class="text-2xl font-semibold mb-4">Create Order</h2> <div id="stallCart" class="space-y-4"> </div> </section>
                    <section class="text-center"> <p class="text-lg text-gray-300">Total Amount:</p> <p id="stallCartTotal" class="text-6xl font-extrabold text-green-400">₹0.00</p> </section>
                </div>
                <button id="btnStallConfirmPayment" class="hidden w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg text-lg transition-all"> Confirm Payment </button>
                <button id="btnStallPaymentCancel" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all"> Cancel </button>
            </main>
        </div>

        <!-- VIEW: Admin Recharge --><div id="adminRechargeView" class="hidden">
             <header class="my-8"> <div class="flex items-center space-x-3 mb-4"> <div> <h2 class="text-lg font-semibold text-white">Udaya Public School</h2> <p class="text-sm text-gray-400">Annual Fest 2025-26</p> </div> </div> <h1 class="text-3xl font-bold text-center text-green-400">Recharge Student Wallet</h1> </header>
             <main class="space-y-6"> <div id="admin-recharge-qr-reader-container"> <p class="text-center text-lg text-yellow-300 mb-4">Scanning for Student QR...</p> <div id="admin-recharge-qr-reader" class="w-full rounded-lg overflow-hidden border-4 border-gray-700"></div> </div> <div id="adminRechargeDetails" class="hidden space-y-6"> <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h2 class="text-2xl font-semibold mb-2">Student Details</h2> <div class="flex justify-between items-center"> <span id="adminRechargeStudentName" class="text-xl"></span> <span id="adminRechargeStudentBalance" class="text-xl font-bold text-green-400"></span> </div> </section> <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h2 class="text-2xl font-semibold mb-4">Enter Amount</h2> <input type="number" id="adminRechargeAmount" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3 text-2xl" placeholder="e.g., 500"> </section> </div> <button id="btnAdminConfirmRecharge" class="hidden w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg text-lg transition-all"> Confirm Recharge </button> <button id="btnAdminRechargeCancel" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all"> Cancel </button> </main>
        </div>

        <!-- VIEW: Loading Overlay --><div id="loadingView" class="hidden fixed inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center z-50"> <div class="spinner w-16 h-16 border-4 border-gray-600 rounded-full"></div> <p id="loadingMessage" class="text-white text-xl mt-4">Loading...</p> </div>
        <!-- Modal (Alert) --><div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"> <div class="bg-white text-black p-6 rounded-lg shadow-xl max-w-sm w-full"> <p id="modalMessage" class="text-lg mb-4">This is an alert message.</p> <button id="modalButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg"> OK </button> </div> </div>
        <!-- Modal (Confirm) --><div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"> <div class="bg-white text-black p-6 rounded-lg shadow-xl max-w-sm w-full"> <p id="confirmModalMessage" class="text-lg mb-6">Are you sure?</p> <div class="flex space-x-4"> <button id="btnConfirmNo" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg"> Cancel </button> <button id="btnConfirmYes" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg"> Yes </button> </div> </div> </div>

        <!-- Global Footer --><footer class="text-center w-full mt-12 mb-4 text-gray-500 text-xs"> <p class="font-semibold">Udaya Public School</p> <p>Mahadev Jharkhandi, Kunraghat, Gorakhpur</p> </footer>
    </div> <!-- End Main Container -->
</body>
</html>
