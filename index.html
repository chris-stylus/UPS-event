<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart QR Event Wallet</title>
    <!-- 1. Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. QR Code Generation Library --><script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- 3. QR Code Scanning Library --><script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>
    <!-- 4. jsPDF Library --><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- 5. html2canvas Library (NEW) --><script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- 6. Firebase SDKs --><script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            setPersistence,
            inMemoryPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            addDoc,
            getDocs,
            serverTimestamp,
            increment,
            arrayUnion,
            arrayRemove,
            runTransaction,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // --- GLOBAL STATE ---
        let db, auth, analytics;
        let html5QrCode; // Main scanner
        let stallQrScanner; // Stall's payment scanner
        let adminRechargeQrScanner; // Admin's recharge scanner
        let currentUnsubscribes = []; // To detach listeners on logout
        let appState = {
            currentUser: null, // { id, name, role, balance, class, menu (for stall) }
            currentView: 'home',
            rechargeAmount: 0, // Still used for admin recharge
            scannedStudentId: null,
            scannedStudentName: null,
            stallCart: {}, // { itemId: quantity }
            allTransactionsForExport: [],
            allStallMenus: {}, // { stallId: { name: 'Stall Name', menu: [...] } }
            currentClassStudentList: [], // {id, name, class}
            eventInfo: "Welcome to the event! Details will be posted here.",
            votingConfig: [], // [{id: 'vote_xyz', title: 'Best Stall', options: ['Stall A', 'Stall B']}] // NEW
            allStallsForExport: [] // NEW: For bulk stall QR download
        };
        let modal, modalMessage, modalButton;
        let confirmModal, confirmModalMessage, btnConfirmYes, btnConfirmNo;
        let confirmCallback = null;
        let editItemModal, editItemNameInput, editItemPriceInput, btnSaveItemChanges, btnCancelItemEdit, editItemId, editItemStallId;


        // --- FIREBASE CONFIG & PATHS ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-event-wallet';

        // --- DOM Elements ---
        let views = {};
        let loadingMessageEl;

        // --- FIREBASE COLLECTION REFERENCES ---
        const usersRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'users');
        const stallsRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'stalls');
        const transactionsRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'transactions');
        const configRef = () => doc(db, 'artifacts', appId, 'public', 'data', 'eventConfig', 'config');
        const classesRef = () => doc(db, 'artifacts', appId, 'public', 'data', 'eventConfig', 'classes');
        const eventInfoRef = () => doc(db, 'artifacts', appId, 'public', 'data', 'eventConfig', 'info');
        const votesRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'votes');
        // NEW: Voting Config Ref
        const votingConfigRef = () => doc(db, 'artifacts', appId, 'public', 'data', 'eventConfig', 'voting');
        
        let studentVotesCache = {}; // Cache for student's votes

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            setupDOMCache();
            initFirebase();
        });

        function setupDOMCache() {
            // Cache all view elements
            views = {
                home: document.getElementById('homeView'),
                adminLogin: document.getElementById('adminLoginView'),
                adminDashboard: document.getElementById('adminDashboardView'),
                scanner: document.getElementById('scannerView'),
                studentDashboard: document.getElementById('studentDashboardView'),
                stallDashboard: document.getElementById('stallDashboardView'),
                stallPayment: document.getElementById('stallPaymentView'),
                loading: document.getElementById('loadingView'),
                adminRecharge: document.getElementById('adminRechargeView'),
            };
            modal = document.getElementById('modal');
            modalMessage = document.getElementById('modalMessage');
            modalButton = document.getElementById('modalButton');

            confirmModal = document.getElementById('confirmModal');
            confirmModalMessage = document.getElementById('confirmModalMessage');
            btnConfirmYes = document.getElementById('btnConfirmYes');
            btnConfirmNo = document.getElementById('btnConfirmNo');
            loadingMessageEl = document.getElementById('loadingMessage');

            // Cache Edit Item Modal
            editItemModal = document.getElementById('editItemModal');
            editItemNameInput = document.getElementById('editItemNameInput');
            editItemPriceInput = document.getElementById('editItemPriceInput');
            btnSaveItemChanges = document.getElementById('btnSaveItemChanges');
            btnCancelItemEdit = document.getElementById('btnCancelItemEdit');
            editItemId = document.getElementById('editItemId');
            editItemStallId = document.getElementById('editItemStallId');

            // Attach all event listeners now that the DOM is loaded
            attachHomeListeners();
            attachAdminLoginListeners();
            attachScannerListeners();
            attachAdminDashboardListeners();
            attachStudentDashboardListeners();
            attachStallDashboardListeners();
            attachStallPaymentListeners();
            attachAdminRechargeListeners();

            // Attach Modal Listeners
            if (modalButton) {
                modalButton.onclick = () => modal?.classList.add('hidden');
            } else {
                console.error("Error: Could not find button with ID 'modalButton'");
            }

            if (btnConfirmNo) {
                btnConfirmNo.onclick = () => {
                    confirmCallback = null;
                    confirmModal?.classList.add('hidden');
                };
            } else {
                console.error("Error: Could not find button with ID 'btnConfirmNo'");
            }

            if (btnConfirmYes) {
                btnConfirmYes.onclick = () => {
                    if (confirmCallback) {
                        confirmCallback();
                    }
                    confirmCallback = null;
                    confirmModal?.classList.add('hidden');
                };
            } else {
                console.error("Error: Could not find button with ID 'btnConfirmYes'");
            }

            // Edit Item Modal Listeners
            if (btnCancelItemEdit) {
                btnCancelItemEdit.onclick = () => editItemModal?.classList.add('hidden');
            } else {
                console.error("Error: Could not find button with ID 'btnCancelItemEdit'");
            }

            if (btnSaveItemChanges) {
                btnSaveItemChanges.onclick = handleSaveItemChanges;
            } else {
                console.error("Error: Could not find button with ID 'btnSaveItemChanges'");
            }
            
            // Edit Voting Modal listeners
            const btnCancelVotingEdit = document.getElementById('btnCancelVotingEdit');
            const btnSaveVotingOptions = document.getElementById('btnSaveVotingOptions');
            if(btnCancelVotingEdit) btnCancelVotingEdit.onclick = () => document.getElementById('editVotingOptionsModal')?.classList.add('hidden');
            if(btnSaveVotingOptions) btnSaveVotingOptions.onclick = handleSaveVotingOptions;
        }

        async function initFirebase() {
            try {
                // --- PASTE YOUR FIREBASE CONFIG HERE ---
                const firebaseConfig = {
                 apiKey: "AIzaSyCsuWEjnrYr1g7ruvZ60ur6TADzbHkJpno",
                 authDomain: "qr-wallet-2ef48.firebaseapp.com",
                 projectId: "qr-wallet-2ef48",
                 storageBucket: "qr-wallet-2ef48.firebasestorage.app",
                 messagingSenderId: "755057942199",
                 appId: "1:755057942199:web:f5fa763b08534bcf1f3732",
                 measurementId: "G-NSLXTCC8JM"
                 };
                // const firebaseConfig = { ... };
                // ----------------------------------------

                let effectiveConfig;
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    console.log("Using environment-provided Firebase config.");
                    effectiveConfig = JSON.parse(__firebase_config);
                } else if (typeof firebaseConfig !== 'undefined') {
                    console.log("Using user-provided Firebase config.");
                    effectiveConfig = firebaseConfig;
                } else {
                    showAlert("SETUP REQUIRED: Firebase configuration is missing.");
                    console.error("Firebase config is not set.");
                    return;
                }

                const app = initializeApp(effectiveConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                analytics = getAnalytics(app);
                setLogLevel('Debug');

                await setPersistence(auth, inMemoryPersistence);

                onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                        showLoading('Connecting to event...');
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                            console.log("Firebase Auth successful.");
                        } catch (error) {
                            console.error("Auth Error:", error);
                            if (error.code === 'auth/configuration-not-found') {
                                showAlert("SETUP ERROR: Anonymous sign-in is not enabled.");
                            } else {
                                showAlert(`Error connecting: ${error.message}`);
                            }
                            hideLoading();
                        }
                    } else {
                        console.log("User is authenticated:", user.uid);
                        // Preload shared data
                        preloadAllStallMenus();
                        loadEventInfo();
                        loadVotingConfig(); // Start listening to voting config here
                        hideLoading();
                        showView('home');
                    }
                });

            } catch (error) {
                console.error("Firebase Init Error:", error);
                showAlert("Critical error loading app configuration.");
            }
        }

        function preloadAllStallMenus() {
            const unsub = onSnapshot(stallsRef(), (snapshot) => {
                appState.allStallMenus = {};
                // NEW: Store stalls for bulk download
                appState.allStallsForExport = [];

                snapshot.forEach(doc => {
                    const stallData = doc.data();
                    appState.allStallMenus[doc.id] = {
                        name: stallData.name,
                        menu: stallData.menu || []
                    };
                    // NEW: Add to export list
                    appState.allStallsForExport.push({ id: doc.id, name: stallData.name, role: 'stall' });
                });
                console.log("All stall menus loaded/updated:", appState.allStallMenus);

                // Re-render stall search/download button state if we are on the admin stall tab
                if (appState.currentView === 'adminDashboard') {
                    updateAdminStallBulkDownloadButton();
                }

                if (appState.currentUser && appState.currentUser.role === 'student' && appState.currentView === 'studentDashboard') {
                    loadStudentStallList();
                }
            }, (error) => {
                console.error("Error loading all stall menus:", error);
            });
            // We keep this running, so don't add to currentUnsubscribes
        }

        // NEW: Update stall download button visibility
        function updateAdminStallBulkDownloadButton() {
            const btnDownloadAllStalls = document.getElementById('btnDownloadAllStallPasses');
            if (btnDownloadAllStalls) {
                if (appState.allStallsForExport.length > 0) {
                    btnDownloadAllStalls.classList.remove('hidden');
                } else {
                    btnDownloadAllStalls.classList.add('hidden');
                }
            }
        }


        // Function to load and cache event info
        function loadEventInfo() {
            const unsub = onSnapshot(eventInfoRef(), (docSnap) => {
                let content = "Welcome to the event! Event details will be posted here by the admin.";
                if (docSnap.exists() && docSnap.data().content) {
                    content = docSnap.data().content;
                }
                appState.eventInfo = content;

                // Update any visible event info panels
                if (appState.currentView === 'studentDashboard') {
                    const el = document.getElementById('studentEventInfo');
                    if (el) el.innerHTML = formatEventInfo(content);
                } else if (appState.currentView === 'stallDashboard') {
                    const el = document.getElementById('stallEventInfo');
                    if (el) el.innerHTML = formatEventInfo(content);
                } else if (appState.currentView === 'adminDashboard') {
                    const el = document.getElementById('adminEventInfoTextarea');
                    if (el) el.value = content;
                }
            }, (error) => {
                console.error("Error loading event info:", error);
                appState.eventInfo = "Error loading event info. Please check back later.";
            });
            // This listener also runs globally
        }
        
        // NEW: Load Voting Config (now dynamic)
        function loadVotingConfig() {
            const unsub = onSnapshot(votingConfigRef(), (docSnap) => {
                let config = [];
                if (docSnap.exists() && docSnap.data().categories) {
                    // Ensure the category structure is an array
                    if(Array.isArray(docSnap.data().categories)) {
                        config = docSnap.data().categories;
                    } else {
                        console.warn("Voting config format incorrect: categories is not an array.");
                    }
                }
                appState.votingConfig = config;

                // Trigger UI updates based on current view
                if (appState.currentView === 'adminDashboard') {
                    // Only re-render if the admin tab is active to avoid unnecessary work
                    const eventPanel = document.getElementById('panel-event');
                    if (eventPanel && !eventPanel.classList.contains('hidden')) {
                        renderAdminVotingConfig();
                    }
                } 
                // Fix: Always call renderVotingCategories for student view, the component itself checks for visibility
                renderVotingCategories(document.getElementById('votingCategoriesList'));
                
            }, (error) => {
                console.error("Error loading voting config:", error);
                appState.votingConfig = [];
                const listEl = document.getElementById('votingCategoriesList');
                if(listEl) listEl.innerHTML = '<p class="text-red-500">Error loading voting data.</p>';
            });
            // FIX: Keep this listener active globally by not pushing to currentUnsubscribes, or manage it separately. 
            // For now, let's keep it running globally to ensure data is updated wherever the user navigates.
            // currentUnsubscribes.push(unsub); // Removed from here, moved cleanup to manual process if needed.
        }
        
        // Helper to format text with line breaks
        function formatEventInfo(text) {
             // 1. Escape HTML
           let escapedText = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
           // 2. Replace newlines with <br>
           return escapedText.replace(/\n/g, '<br>');
        }


        // --- VIEW NAVIGATION ---
        function showView(viewId) {
            cleanupListeners();
            stopAllScanners();
            appState.currentView = viewId;
            Object.values(views).forEach(v => v?.classList.add('hidden'));
            if (views[viewId]) views[viewId].classList.remove('hidden');
            hideLoading();
        }

        function showLoading(message) {
            if (loadingMessageEl) {
                loadingMessageEl.textContent = message;
            } else {
                console.error("loadingMessage element not found");
            }
            if (views.loading) views.loading.classList.remove('hidden');
        }

        function hideLoading() {
            if (views.loading) views.loading.classList.add('hidden');
        }

        function showAlert(message) {
            if (modalMessage && modal) {
                modalMessage.textContent = message;
                modal.classList.remove('hidden');
            } else {
                console.error("Modal elements not found for showAlert:", message);
                console.log("ALERT:", message);
            }
        }
        
        function showConfirm(message, onYesCallback) {
             if (confirmModalMessage && confirmModal && btnConfirmYes && btnConfirmNo) {
                confirmModalMessage.textContent = message;
                confirmCallback = onYesCallback; // Store the callback directly
                confirmModal.classList.remove('hidden');
            } else {
                console.error("Confirm modal elements not found for showConfirm:", message);
                console.error("Confirmation skipped as modal elements is missing.");
                confirmCallback = null;
            }
        }


        function cleanupListeners() {
            currentUnsubscribes.forEach(unsub => {
                if (typeof unsub === 'function') {
                    unsub(); // Direct function call for regular listeners
                } else if (unsub && typeof unsub.unsub === 'function') {
                    unsub.unsub(); // Call the unsubscribe function inside the wrapper object
                }
            });
            currentUnsubscribes = [];
        }

        function stopAllScanners() {
            [html5QrCode, stallQrScanner, adminRechargeQrScanner].forEach(scanner => {
                try {
                    if (scanner && typeof scanner.getState === 'function' && scanner.getState() === Html5QrcodeScannerState.SCANNING) {
                         scanner.stop().catch(err => console.warn("Scanner stop error (ignorable):", err));
                    } else if (scanner && scanner.isScanning) { // Fallback
                         scanner.stop().catch(err => console.warn("Scanner stop error (ignorable, fallback):", err));
                    }
                } catch (e) {
                    // console.warn("Error accessing or stopping scanner:", e);
                }
            });
        }
        
        // Utility to escape HTML for data attributes
        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }


        function logout() {
            appState.currentUser = null;
            appState.scannedStudentId = null;
            appState.scannedStudentName = null;
            appState.stallCart = {};
            showView('home');
        }

        // --- HOME VIEW LOGIC ---
        function attachHomeListeners() {
            const btnAdmin = document.getElementById('btnAdminLogin');
            const btnStall = document.getElementById('btnStallLogin');
            const btnStudent = document.getElementById('btnStudentLogin');

            if (btnAdmin) btnAdmin.onclick = () => showView('adminLogin');
            else console.error("btnAdminLogin not found");
            if (btnStall) btnStall.onclick = () => startScanner('stall');
             else console.error("btnStallLogin not found");
            if (btnStudent) btnStudent.onclick = () => startScanner('student');
             else console.error("btnStudentLogin not found");
        }

        // --- SCANNER VIEW LOGIC ---
        function attachScannerListeners() {
            const btnCancel = document.getElementById('btnCancelScan');
            if (btnCancel) btnCancel.onclick = () => showView('home');
            else console.error("btnCancelScan not found");
        }


        function startScanner(loginType) {
            showView('scanner');
            const scannerTitle = document.getElementById('scannerTitle');
            if (scannerTitle) scannerTitle.textContent = `Scan ${loginType.charAt(0).toUpperCase() + loginType.slice(1)} QR Code`;
             else console.error("scannerTitle not found");

            if (!html5QrCode) {
                try {
                    html5QrCode = new Html5Qrcode("qr-reader");
                } catch (e) {
                    console.error("Failed to initialize Html5Qrcode:", e);
                    showAlert("QR Scanner component failed to load.");
                    showView('home');
                    return;
                }
            }
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => handleLoginScan(decodedText, loginType), (errorMessage) => { /* console.warn(errorMessage) */ })
                .catch(err => {
                    console.error("Scanner start error:", err);
                    showAlert("Could not start camera. Please check permissions.");
                    showView('home');
                });
        }

        async function handleLoginScan(userId, loginType) {
            stopAllScanners();
            showLoading('Verifying QR Code...');
            try {
                const userDoc = await getDoc(doc(usersRef(), userId));
                if (!userDoc.exists()) throw new Error('Invalid QR Code.');
                const user = userDoc.data();
                if (user.role !== loginType) throw new Error(`Incorrect QR Code type (${user.role}).`);
                appState.currentUser = { id: userId, ...user };
                if (loginType === 'student') loadStudentDashboard();
                else if (loginType === 'stall') loadStallDashboard();
            } catch (error) {
                console.error("Login Scan Error:", error);
                showAlert(error.message);
                showView('home');
            }
        }

        // --- ADMIN LOGIN VIEW LOGIC ---
        function attachAdminLoginListeners() {
            const btnBack = document.getElementById('btnAdminLoginBack');
            const btnSubmit = document.getElementById('btnAdminLoginSubmit');

            if (btnBack) btnBack.onclick = () => showView('home');
            else console.error("btnAdminLoginBack not found");

            if (btnSubmit) btnSubmit.onclick = async () => {
                const passwordInput = document.getElementById('adminPassword');
                if (!passwordInput) { console.error("adminPassword input not found"); return; }
                const password = passwordInput.value;
                if (!password) return showAlert('Please enter password.');
                showLoading('Verifying password...');
                try {
                    const configSnap = await getDoc(configRef());
                    let correctPassword = '@cx1136'; // Default password

                    // Check if config exists and has the password field
                    if (!configSnap.exists() || !configSnap.data()?.adminPassword) {
                        console.log("Admin password not found in config, setting default '@cx1136'.");
                        // Attempt to save the default password if it's missing (best effort)
                        try {
                            await setDoc(configRef(), { adminPassword: correctPassword }, { merge: true });
                        } catch (saveError) {
                            console.error("Could not save default admin password:", saveError);
                            // Proceed with the default password anyway for this attempt
                        }
                    } else {
                        correctPassword = configSnap.data().adminPassword;
                    }

                    // *** ADDED LOGGING ***
                    console.log(`Admin Login Attempt: Entered='${password}', Expected='${correctPassword}'`);
                    
                    if (password === correctPassword) {
                        console.log("Admin password matches.");
                        // ADDED try/catch to ensure loading indicator is hidden if load fails
                        try {
                            loadAdminDashboard();
                        } catch (e) {
                             console.error("Failed to load admin dashboard:", e);
                            showAlert("Login successful, but failed to load dashboard view.");
                            hideLoading();
                        }
                    } else {
                        throw new Error('Wrong password.');
                    }
                } catch (error) {
                    console.error("Admin Login Error:", error);
                    showAlert(error.message); // Show the specific error (e.g., "Wrong password.")
                    passwordInput.value = ''; // Clear password field on error
                    hideLoading();
                }
            };
             else console.error("btnAdminLoginSubmit not found");
        }

        // --- NEW GLOBAL REFRESH HANDLERS ---

        function refreshAdminData() {
            showLoading('Refreshing all admin data...');
            // Reload all major components of the admin dashboard
            loadAdminStudents(); 
            loadAdminStallsAndMenus(); 
            loadAdminReports(); 
            loadAdminClasses();
            loadEventInfo(); // Reloads event info, which triggers voting config load
            // Note: renderAdminVotingConfig is called inside loadVotingConfig listener.
            setTimeout(hideLoading, 500); 
        }

        function refreshStudentData() {
            showLoading('Refreshing student data...');
            // Reloads all components (balance, menu list, voting list, history)
            loadStudentDashboard(); 
            setTimeout(hideLoading, 500);
        }

        function refreshStallData() {
            showLoading('Refreshing stall data...');
            // Reloads all components (sales, menu, history)
            loadStallDashboard(); 
            setTimeout(hideLoading, 500);
        }

        // --- ADMIN DASHBOARD LOGIC ---
        function attachAdminDashboardListeners() {
            const btnLogout = document.getElementById('btnAdminLogout');
            if (btnLogout) btnLogout.onclick = logout;
            else console.error("btnAdminLogout not found");

            const btnRefreshAdmin = document.getElementById('btnAdminRefresh');
            if (btnRefreshAdmin) btnRefreshAdmin.onclick = refreshAdminData;
            else console.error("btnAdminRefresh not found");


            const tabs = document.querySelectorAll('#adminDashboardView .admin-tab');
            const tabPanels = document.querySelectorAll('#adminDashboardView .admin-tab-panel');
            tabs.forEach(tab => {
                tab.onclick = () => {
                    tabs.forEach(t => { t.classList.replace('bg-blue-600', 'bg-gray-700'); t.classList.add('text-gray-300'); });
                    tabPanels.forEach(p => p.classList.add('hidden'));
                    tab.classList.replace('bg-gray-700', 'bg-blue-600');
                    tab.classList.remove('text-gray-300');
                    const targetPanel = document.getElementById(tab.dataset.target);
                    if (targetPanel) targetPanel.classList.remove('hidden');
                    else console.error("Target panel not found:", tab.dataset.target);
                };
            });

            // Panel: Students
            const btnGenStudent = document.getElementById('btnAdminGenerateStudent');
            if (btnGenStudent) btnGenStudent.onclick = () => generateUser('student');
            else console.error("btnAdminGenerateStudent not found");

            const btnBulkImport = document.getElementById('btnAdminBulkImport');
            if (btnBulkImport) btnBulkImport.onclick = handleBulkImport;
            else console.error("btnAdminBulkImport not found");

            const btnRecharge = document.getElementById('btnAdminRechargeStudent');
            if (btnRecharge) btnRecharge.onclick = startAdminRechargeScan;
             else console.error("btnAdminRechargeStudent not found");

            const classSelect = document.getElementById('adminSearchClassSelect');
            if (classSelect) classSelect.onchange = handleClassFilterChange;
            else console.error("adminSearchClassSelect not found");

            const btnDownloadAll = document.getElementById('btnDownloadAllPasses');
            if (btnDownloadAll) btnDownloadAll.onclick = generateClassPDF;
            else console.error("btnDownloadAllPasses not found");

            const btnSearchStudent = document.getElementById('btnAdminSearchStudent');
            if (btnSearchStudent) btnSearchStudent.onclick = searchStudentByName;
            else console.error("btnAdminSearchStudent not found");
            
            // Panel: Stalls
            const btnGenStall = document.getElementById('btnAdminGenerateStall');
            if (btnGenStall) btnGenStall.onclick = () => generateUser('stall');
            else console.error("btnAdminGenerateStall not found");

            const btnAddItem = document.getElementById('btnAdminAddMenuItem');
            if (btnAddItem) btnAddItem.onclick = addMenuItem;
             else console.error("btnAdminAddMenuItem not found");

            const btnSearchStall = document.getElementById('btnAdminSearchStall');
            if (btnSearchStall) btnSearchStall.onclick = searchStall;
             else console.error("btnAdminSearchStall not found");

            // NEW: Bulk Stall Download
            const btnDownloadAllStalls = document.getElementById('btnDownloadAllStallPasses');
            if (btnDownloadAllStalls) btnDownloadAllStalls.onclick = () => generateBulkQRPasses(appState.allStallsForExport, 'stall');
            else console.error("btnDownloadAllStallPasses not found");
            
            // Panel: Classes
            const btnAddClass = document.getElementById('btnAdminAddClass');
            if (btnAddClass) btnAddClass.onclick = addAdminClass;
            else console.error("btnAddClass not found");

            // Panel: Reports
            const btnExport = document.getElementById('btnExportCSV');
            if (btnExport) btnExport.onclick = exportTransactionsToCSV;
            else console.error("btnExportCSV not found");

            // NEW: Report Refresh Button
            const btnRefreshReports = document.getElementById('btnAdminRefreshReports');
            if (btnRefreshReports) btnRefreshReports.onclick = () => loadAdminReports();
            else console.error("btnAdminRefreshReports not found");
            
            // Panel: Event
            const btnSaveEventInfo = document.getElementById('btnAdminSaveEventInfo');
            if(btnSaveEventInfo) btnSaveEventInfo.onclick = handleSaveEventInfo;
            else console.error("btnAdminSaveEventInfo not found");
            
            // Panel: Event (Voting)
            const btnAddVotingCategory = document.getElementById('btnAdminAddVotingCategory');
            if(btnAddVotingCategory) btnAddVotingCategory.onclick = addVotingCategory;
        }

        // Function to save event info
        async function handleSaveEventInfo() {
            const textarea = document.getElementById('adminEventInfoTextarea');
            if (!textarea) return console.error("adminEventInfoTextarea not found");
            
            const newContent = textarea.value;
            showLoading("Saving event info...");
            try {
                await setDoc(eventInfoRef(), { content: newContent }, { merge: true });
                showAlert("Event info saved successfully!");
            } catch (error) {
                console.error("Error saving event info:", error);
                showAlert("Error saving event info: " + error.message);
            } finally {
                hideLoading();
            }
        }


        // --- Renders entry pass (admin view has print/download) ---
        // MODIFIED to accept isStall flag
        function displayUserQR(containerElement, user) {
            if (!containerElement) { console.error("displayUserQR: containerElement is null"); return; }
            containerElement.innerHTML = ''; containerElement.classList.remove('hidden');
            const passId = `printable-pass-${user.id}`, qrInnerId = `qr-code-inner-${user.id}`;
            const printBtnId = `btnPrintPass-${user.id}`, downloadBtnId = `btnDownloadQR-${user.id}`;
            const isAdmin = appState.currentUser && appState.currentUser.role === 'admin';
            const isStall = user.role === 'stall';
            
            const passTitle = isStall ? 'STALL QR PASS' : 'ENTRY PASS';
            const typeDetail = isStall ? `Stall Name: ${user.name}` : `Class: ${user.class || 'N/A'}`;
            const nameDisplay = isStall ? user.name : user.name;


            containerElement.innerHTML = `
                <div id="${passId}" class="printable-area bg-white text-black p-6 rounded-lg shadow-lg max-w-xs mx-auto border-4 ${isStall ? 'border-green-600' : 'border-blue-600'}">
                    <div class="text-center border-b pb-4 border-gray-300">
                        <h3 class="text-xl font-bold text-gray-800">Udaya Public School</h3>
                        <p class="text-xs text-gray-600">Mahadev Jharkhandi, Kunraghat, Gorakhpur</p>
                    </div>
                    <div class="my-4 text-center">
                        <p class="text-sm font-medium text-gray-700">ANNUAL FEST 2025-26</p>
                        <p class="text-2xl font-bold ${isStall ? 'text-green-600' : 'text-blue-600'}">${passTitle}</p>
                        <p class="text-sm font-semibold text-gray-700">Date: 1-FEB-2026</p>
                    </div>
                    <div class="my-4 text-center">
                        <p class="text-lg font-bold text-black">${nameDisplay}</p>
                        <p class="text-base text-gray-700">${typeDetail}</p>
                    </div>
                    <div id="${qrInnerId}" class="flex justify-center p-4 bg-white rounded-lg"></div>
                    <p class="text-xs text-center break-all text-gray-500">${user.id}</p>
                </div>
                ${isAdmin ? `
                <div class="flex space-x-2 mt-4 print-hide">
                    <button id="${printBtnId}" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Print Pass</button>
                    <button id="${downloadBtnId}" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Download QR</button>
                </div>` : ''}
            `;
            const qrElement = document.getElementById(qrInnerId);
            if (qrElement) {
                new QRCode(qrElement, { text: user.id, width: 200, height: 200, colorDark: "#000", colorLight: "#fff", correctLevel: QRCode.CorrectLevel.H });
            } else {
                 console.error(`QR container ${qrInnerId} not found`);
            }
            if (isAdmin) {
                const btnPrint = document.getElementById(printBtnId);
                const btnDownload = document.getElementById(downloadBtnId);
                if(btnPrint) btnPrint.onclick = () => printPass(passId);
                else console.error(`Print button ${printBtnId} not found`);
                if(btnDownload) btnDownload.onclick = () => downloadQR(qrInnerId, user.name);
                 else console.error(`Download button ${downloadBtnId} not found`);
            }
        }

        // --- Print/Download Helpers ---
        function printPass(elementId) {
             const passElement = document.getElementById(elementId);
            if (!passElement) {
                console.error('Could not find element to print:', elementId);
                return;
            }
            passElement.classList.add('print-this-one');
            window.print();
            passElement.classList.remove('print-this-one');
        }
        function downloadQR(qrContainerId, name) {
             try {
                 const qrContainer = document.getElementById(qrContainerId);
                 if (!qrContainer) { throw new Error(`QR container ${qrContainerId} not found`); }
                 const qrImage = qrContainer.querySelector('img');
                 if (!qrImage) throw new Error('QR image not found within container');
                 const link = document.createElement('a');
                 link.href = qrImage.src;
                 link.download = `qr_${name.replace(/ /g, '_')}.png`;
                 document.body.appendChild(link);
                 link.click();
                 document.body.removeChild(link);
             } catch (error) {
                 console.error('Download QR Error:', error);
                 showAlert('Could not download QR code.');
             }
        }

        // MODIFIED: Show/hide bulk download button and cache student list
        async function handleClassFilterChange(e) {
            const className = e.target.value;
            const studentListEl = document.getElementById('adminStudentListByClass');
            const qrContainer = document.getElementById('adminSearchQRContainer');
            const btnDownloadAll = document.getElementById('btnDownloadAllPasses'); // NEW

            if (!studentListEl || !qrContainer || !btnDownloadAll) {
                console.error("Missing elements for class filter");
                return;
            }

            studentListEl.innerHTML = '';
            qrContainer.innerHTML = '';
            qrContainer.classList.add('hidden');
            btnDownloadAll.classList.add('hidden'); // NEW: Hide button on change
            appState.currentClassStudentList = []; // NEW: Clear cache

            if (!className) return;

            showLoading('Fetching students...');
            try {
                const q = query(usersRef(), where('role', '==', 'student'), where('class', '==', className));
                const snapshot = await getDocs(q);
                if (snapshot.empty) throw new Error('No students found in this class.');

                // NEW: Cache student data
                appState.currentClassStudentList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                studentListEl.innerHTML = appState.currentClassStudentList.map(student =>
                    `<button class="btn-show-qr w-full text-left bg-gray-700 hover:bg-gray-600 p-3 rounded-lg" data-id="${student.id}" data-name="${student.name}" data-class="${student.class}">${student.name}</button>`
                ).join('');

                document.querySelectorAll('.btn-show-qr').forEach(btn => {
                    btn.onclick = (e) => {
                        document.querySelectorAll('.btn-show-qr').forEach(b => b.classList.remove('bg-blue-600'));
                        e.currentTarget.classList.add('bg-blue-600');
                        displayUserQR(qrContainer, { role: 'student', ...e.currentTarget.dataset });
                    };
                });

                btnDownloadAll.classList.remove('hidden'); // NEW: Show button
            } catch (error) {
                showAlert(error.message);
                studentListEl.innerHTML = `<p class="text-${error.message.startsWith('No students') ? 'gray-400' : 'red-500'}">${error.message}</p>`;
            } finally {
                hideLoading();
            }
        }

        // --- NEW/MODIFIED PDF GENERATION FUNCTIONS ---

        /**
         * Helper function to return the HTML string for a single pass.
         * @param {object} user - The user data object {id, name, class, role}
         * @param {string} qrId - The unique ID to use for the QR code container element
         * @returns {string} - The HTML string for the pass
         */
        function getPassHtml(user, qrId) {
            const isStall = user.role === 'stall';
            const passTitle = isStall ? 'STALL QR PASS' : 'ENTRY PASS';
            const typeDetail = isStall ? `Stall Name: ${user.name}` : `Class: ${user.class || 'N/A'}`;
            const nameDisplay = isStall ? user.name : user.name;
            const borderColor = isStall ? '#10B981' : '#2563EB'; // Green for stall, Blue for student

            return `
                <div class="printable-area bg-white text-black p-6 rounded-lg shadow-lg border-4" style="width: 350px; height: auto; box-sizing: border-box; border-color: ${borderColor};">
                    <div class="text-center border-b pb-4 border-gray-300">
                        <h3 class="text-xl font-bold text-gray-800" style="font-size: 1.25rem; line-height: 1.75rem;">Udaya Public School</h3>
                        <p class="text-xs text-gray-600" style="font-size: 0.75rem; line-height: 1rem;">Mahadev Jharkhandi, Kunraghat, Gorakhpur</p>
                    </div>
                    <div class="my-4 text-center">
                        <p class="text-sm font-medium text-gray-700" style="font-size: 0.875rem; line-height: 1.25rem;">ANNUAL FEST 2025-26</p>
                        <p class="text-2xl font-bold" style="font-size: 1.5rem; line-height: 2rem; color: ${borderColor};">${passTitle}</p>
                        <p class="text-sm font-semibold text-gray-700" style="font-size: 0.875rem; line-height: 1.25rem;">Date: 1-FEB-2026</p>
                    </div>
                    <div class="my-4 text-center">
                        <p class="text-lg font-bold text-black" style="font-size: 1.125rem; line-height: 1.75rem;">${nameDisplay}</p>
                        <p class="text-base text-gray-700" style="font-size: 1rem; line-height: 1.5rem;">${typeDetail}</p>
                    </div>
                    <div id="${qrId}" class="flex justify-center p-4 bg-white rounded-lg" style="display: flex; justify-content: center; padding: 1rem; background-color: #ffffff; border-radius: 0.5rem;"></div>
                    <p class="text-xs text-center break-all text-gray-500" style="font-size: 0.75rem; line-height: 1rem; word-break: break-all;">${user.id}</p>
                </div>`;
        }


        /**
         * Generates a multi-page PDF for a list of users (students or stalls)
         * @param {Array} users - Array of user objects ({id, name, class, role})
         * @param {string} userType - 'student' or 'stall'
         */
        async function generateBulkQRPasses(users, userType) {
            if (!users || users.length === 0) {
                return showAlert(`No ${userType}s selected or available for download.`);
            }
            
            if (typeof window.jspdf === 'undefined' || typeof window.html2canvas === 'undefined') {
                return showAlert("Error: PDF generation libraries (jsPDF or html2canvas) are not loaded.");
            }

            const fileName = `${userType}_passes_${new Date().toISOString().split('T')[0]}`;
            showLoading(`Generating PDF for ${userType}s... (0 / ${users.length})`);

            // 1. Init jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('portrait', 'mm', 'a4'); // A4: 210 x 297 mm

            // 2. Setup temporary render container
            let renderContainer = document.getElementById('pdf-render-container');
            if (!renderContainer) {
                renderContainer = document.createElement('div');
                renderContainer.id = 'pdf-render-container';
                renderContainer.style.position = 'absolute';
                renderContainer.style.left = '-9999px'; // Hide off-screen
                renderContainer.style.top = '0';
                renderContainer.style.width = '350px'; // Fixed width for consistent html2canvas render
                document.body.appendChild(renderContainer);
            }

            // 3. Layout Constants (in mm)
            const PASS_WIDTH = 90; // Approx 90mm width
            const PASS_HEIGHT = 90; // Approx 90mm height (to fit 3 passes vertically)
            const MARGIN = 10;
            const GUTTER = 6; // Space between passes

            // X,Y positions for the top-left corner of each of the 6 passes
            const positions = [
                { x: MARGIN, y: MARGIN }, // Row 1, Col 1
                { x: MARGIN + PASS_WIDTH + GUTTER, y: MARGIN }, // Row 1, Col 2
                { x: MARGIN, y: MARGIN + PASS_HEIGHT + GUTTER }, // Row 2, Col 1
                { x: MARGIN + PASS_WIDTH + GUTTER, y: MARGIN + PASS_HEIGHT + GUTTER }, // Row 2, Col 2
                { x: MARGIN, y: MARGIN + 2 * (PASS_HEIGHT + GUTTER) }, // Row 3, Col 1
                { x: MARGIN + PASS_WIDTH + GUTTER, y: MARGIN + 2 * (PASS_HEIGHT + GUTTER) }, // Row 3, Col 2
            ];

            let userCounter = 0;

            // 4. Loop through users and draw passes
            for (const user of users) {
                const passIndex = userCounter % 6; // 0-5
                const { x, y } = positions[passIndex];

                // Add a new page if we are starting the 7th user (index 6, which is 0 % 6)
                if (userCounter > 0 && passIndex === 0) {
                    doc.addPage();
                }

                showLoading(`Generating PDF... (${userCounter + 1} / ${users.length})`);

                // 1. Create unique ID for QR container
                const qrId = `pdf-qr-${user.id}`;
                
                // 2. Set the HTML for the current pass
                // Ensure the user object contains 'role' for correct styling
                renderContainer.innerHTML = getPassHtml({ ...user, role: user.role || userType.split('_')[0] }, qrId);
                
                // 3. Find the QR element and render the QR code
                const qrElement = document.getElementById(qrId);
                if (!qrElement) {
                    console.error("Could not find QR element for PDF render");
                    continue; // Skip this user
                }
                new QRCode(qrElement, {
                    text: user.id,
                    width: 200,
                    height: 200,
                    colorDark: "#000",
                    colorLight: "#fff",
                    correctLevel: QRCode.CorrectLevel.H
                });

                // 4. Wait for QR to render, then use html2canvas
                await new Promise(resolve => setTimeout(resolve, 150)); 

                let canvas;
                try {
                    const passElement = renderContainer.firstElementChild;
                    if (!passElement) throw new Error("Pass element not found in render container");
                    
                    canvas = await html2canvas(passElement, {
                        scale: 2, // Increase resolution for better quality
                        useCORS: true,
                        logging: false
                    });
                } catch (error) {
                    console.error("html2canvas failed for", user.name, error);
                    continue; // Skip this user
                }

                // 5. Get image data
                const imgData = canvas.toDataURL('image/jpeg', 0.9); // Use JPEG for smaller size

                // 6. Add image to PDF
                const imgProps = doc.getImageProperties(imgData);
                
                // Calculate size based on image aspect ratio and fixed width/height constraint
                let finalWidth = PASS_WIDTH;
                let finalHeight = (imgProps.height * finalWidth) / imgProps.width;

                if (finalHeight > PASS_HEIGHT) {
                    finalHeight = PASS_HEIGHT;
                    finalWidth = (imgProps.width * finalHeight) / imgProps.height;
                }

                // Center the image within the pass slot
                const xOffset = x + (PASS_WIDTH - finalWidth) / 2;
                const yOffset = y + (PASS_HEIGHT - finalHeight) / 2;

                doc.addImage(imgData, 'JPEG', xOffset, yOffset, finalWidth, finalHeight);

                // Add cut border
                doc.setDrawColor(220, 220, 220); // Light grey border for cutting
                doc.rect(x, y, PASS_WIDTH, PASS_HEIGHT);

                userCounter++;
                
                // 7. Clean up container for next loop
                renderContainer.innerHTML = '';
            }

            // 5. Save PDF
            renderContainer.innerHTML = ''; // Clean up temp container
            hideLoading();
            doc.save(`${fileName}.pdf`);
        }

        // Function specific to Student bulk download (calls generic function)
        async function generateClassPDF() {
            const students = appState.currentClassStudentList.map(s => ({ ...s, role: 'student' })); // Ensure role is set
            const className = students[0]?.class || "all_students";
            await generateBulkQRPasses(students, `students_${className.replace(/ /g, '_')}`);
        }
        
        // --- END NEW/MODIFIED PDF FUNCTIONS ---


        async function searchStall() {
             const stallNameInput = document.getElementById('adminSearchStallName');
             const qrContainer = document.getElementById('adminSearchStallQRContainer');
             if (!stallNameInput || !qrContainer) { console.error("Missing elements for stall search"); return; }
             const stallName = stallNameInput.value;
            if (!stallName) return showAlert('Please enter stall name.');
            showLoading('Searching...'); qrContainer.innerHTML = '';
            try {
                const q = query(usersRef(), where('role', '==', 'stall'), where('name', '==', stallName));
                const snapshot = await getDocs(q);
                if (snapshot.empty) throw new Error('No stall found with that name.');
                const stallUserDoc = snapshot.docs[0];
                const stallUser = { id: stallUserDoc.id, role: 'stall', ...stallUserDoc.data() }; // Ensure role is here
                qrContainer.classList.remove('hidden');
                
                // Use the standard displayUserQR which now supports stall passes
                displayUserQR(qrContainer, stallUser);
                
                stallNameInput.value = '';
            } catch (error) {
                showAlert(error.message);
                qrContainer.innerHTML = '<p class="text-red-500">Search failed.</p>';
            } finally { hideLoading(); }
        }

        // +++ NEW FUNCTION +++
        async function searchStudentByName() {
            const studentNameInput = document.getElementById('adminSearchStudentName');
            const qrContainer = document.getElementById('adminSearchStudentQRContainer');
            if (!studentNameInput || !qrContainer) {
                console.error("Missing elements for student name search");
                return;
            }
            const studentName = studentNameInput.value;
            if (!studentName) return showAlert('Please enter student name.');

            showLoading('Searching...');
            qrContainer.innerHTML = '';
            qrContainer.classList.add('hidden'); // Hide until found

            try {
                const q = query(usersRef(), where('role', '==', 'student'), where('name', '==', studentName));
                const snapshot = await getDocs(q);
                if (snapshot.empty) throw new Error('No student found with that name.');

                const studentDoc = snapshot.docs[0];
                const studentUser = { id: studentDoc.id, role: 'student', ...studentDoc.data() };

                // Use the existing displayUserQR function which handles UI
                displayUserQR(qrContainer, studentUser);
                
                studentNameInput.value = '';
            } catch (error) {
                showAlert(error.message);
                qrContainer.innerHTML = `<p class="text-red-500">${error.message}</p>`;
                qrContainer.classList.remove('hidden'); // Show error
            } finally {
                hideLoading();
            }
        }


        function loadAdminDashboard() {
             showView('adminDashboard');
            appState.currentUser = { id: 'admin', role: 'admin' };
            // Load panel data
            loadAdminStudents(); 
            loadAdminStallsAndMenus(); 
            loadAdminReports(); 
            loadAdminClasses();
            loadAdminVotingResults(); 
            // Event info is loaded globally, but we ensure textarea is populated
            const eventTextarea = document.getElementById('adminEventInfoTextarea');
            if (eventTextarea) eventTextarea.value = appState.eventInfo;
            
            // FIX: Manually call this to ensure the list is displayed when navigating to the Event tab
            renderAdminVotingConfig();
            updateAdminStallBulkDownloadButton(); // Initial check for stall download button
        }

        async function generateUser(role) {
             const nameInput = document.getElementById(role === 'student' ? 'adminStudentName' : 'adminStallName');
             const qrContainer = document.getElementById(role === 'student' ? 'adminStudentQRContainer' : 'adminStallQRContainer');
             if (!nameInput || !qrContainer) { console.error("Missing elements for user generation"); return;}
             const name = nameInput.value;

            let studentClass = null;
            if (role === 'student') {
                const classSelect = document.getElementById('adminStudentClassSelect');
                 if (!classSelect) { console.error("adminStudentClassSelect not found"); return;}
                studentClass = classSelect.value;
                if (!studentClass) return showAlert('Please select student class.');
            }
            if (!name) return showAlert(`Please enter ${role} name.`);
            showLoading(`Generating ${role}...`);
            try {
                const newUser = { name, role, balance: role === 'student' ? 0 : null, class: studentClass, createdAt: serverTimestamp() };
                const newDocRef = await addDoc(usersRef(), newUser);
                
                // We will use the doc ID as the main user ID
                const finalUserId = newDocRef.id;
                await updateDoc(newDocRef, { userId: finalUserId }); // Add userId field
                
                if (role === 'stall') {
                    // For stalls, create a matching doc in the 'stalls' collection using the same ID
                    await setDoc(doc(stallsRef(), finalUserId), { name, ownerId: finalUserId, menu: [] });
                }

                const userForQR = { id: finalUserId, name, class: studentClass, role };
                
                // Use the standardized QR display function
                displayUserQR(qrContainer, userForQR);
                
                nameInput.value = '';
                if (role === 'student') {
                    const classSelect = document.getElementById('adminStudentClassSelect');
                    if(classSelect) classSelect.value = '';
                }
                showAlert(`${role} created successfully!`);
            } catch (error) { showAlert(`Error creating ${role}.`); console.error(error); } finally { hideLoading(); }
        }


        function loadAdminClasses() {
            const unsub = onSnapshot(classesRef(), (docSnap) => {
                const listEl = document.getElementById('adminClassList');
                const searchSelectEl = document.getElementById('adminSearchClassSelect');
                const genSelectEl = document.getElementById('adminStudentClassSelect');
                if (!listEl || !searchSelectEl || !genSelectEl) { console.error("Missing class list/select elements"); return;}

                let classNames = (docSnap.exists() && docSnap.data().classNames) ? docSnap.data().classNames.sort() : [];

                listEl.innerHTML = classNames.length === 0 ? '<p class="text-gray-400">No classes.</p>' :
                    classNames.map(name => `<div class="bg-gray-700 p-3 rounded-lg flex justify-between items-center"><span>${name}</span><button data-name="${name}" class="btn-delete-class bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg text-sm">Delete</button></div>`).join('');

                const optionsHTML = classNames.map(name => `<option value="${name}">${name}</option>`).join('');
                searchSelectEl.innerHTML = '<option value="">Select Class</option>' + optionsHTML;
                genSelectEl.innerHTML = '<option value="">Select Class</option>' + optionsHTML;

                // FIX: Capture data *before* calling showConfirm
                document.querySelectorAll('.btn-delete-class').forEach(btn => {
                    const className = btn.dataset.name; // Capture name here
                    btn.onclick = () => showConfirm(`Delete class "${className}"?`, () => deleteAdminClass(className));
                });
            }, error => console.error("Error loading classes:", error));
            currentUnsubscribes.push(unsub);
        }

        async function addAdminClass() {
             const input = document.getElementById('adminClassName');
             if (!input) { console.error("adminClassName input not found"); return; }
             const name = input.value.trim();
            if (!name) return showAlert('Enter class name.');
            showLoading('Adding...');
            try { await setDoc(classesRef(), { classNames: arrayUnion(name) }, { merge: true }); input.value = ''; }
            catch (e) { showAlert('Error: ' + e.message); } finally { hideLoading(); }
        }
        async function deleteAdminClass(name) {
            if (!name) return; showLoading('Deleting...');
            try { await updateDoc(classesRef(), { classNames: arrayRemove(name) }); }
            catch (e) { showAlert('Error: ' + e.message); } finally { hideLoading(); }
        }
        function loadAdminStudents() {
            const q = query(usersRef(), where('role', '==', 'student'));
            const unsub = onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('adminStudentList');
                if (!listEl) { console.error("adminStudentList not found"); return; }
                listEl.innerHTML = snapshot.empty ? '<p>No students.</p>' : snapshot.docs.map(d => `<div class="bg-gray-700 p-3 rounded-lg flex justify-between items-center"><div><span>${d.data().name} (${d.data().class||'N/A'})</span><span class="text-green-400 block text-sm">₹${d.data().balance.toFixed(2)}</span></div><button data-id="${d.id}" data-name="${d.data().name}" class="btn-delete-student bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg text-sm">Delete</button></div>`).join('');

                // FIX: Capture data *before* calling showConfirm
                document.querySelectorAll('.btn-delete-student').forEach(btn => {
                    const studentId = btn.dataset.id; // Capture id here
                    const studentName = btn.dataset.name; // Capture name here
                    btn.onclick = () => showConfirm(`Delete "${studentName}"?`, () => _deleteStudent(studentId));
                });
            }, error => console.error("Error loading students:", error)); currentUnsubscribes.push(unsub);
        }

        // --- MODIFIED: Added Edit/Delete buttons for admin ---
        function renderMenuList(menu, stallId, isAdminView) {
            if (!menu || menu.length === 0) return '<p class="text-sm text-gray-400">No menu items yet.</p>';

            return menu.map(item => `
                <div class="flex justify-between items-center text-sm bg-gray-600 px-3 py-2 rounded">
                    <div class="flex-1 min-w-0">
                        <span class="block font-medium truncate">${item.name}</span>
                        <span class="font-medium text-blue-300">₹${item.price.toFixed(2)}</span>
                        <span class="ml-2 text-xs ${item.stock <= 0 ? 'text-red-400 font-bold' : 'text-gray-300'}">(${item.stock || 0} left)</span>
                    </div>
                    <div class="flex items-center space-x-2 flex-shrink-0 ml-2">
                        ${isAdminView ? `
                        <input type="number" value="${item.stock || 0}" min="0" 
                                class="admin-stock-input bg-gray-700 text-white w-14 text-center rounded px-1 py-0.5 border border-gray-500 focus:ring-blue-500 focus:border-blue-500" 
                                data-item-id="${item.id}" data-stall-id="${stallId}">
                        <button class="btn-edit-menu-item bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs"
                                data-stall-id="${stallId}"
                                data-item-id="${item.id}"
                                data-name="${escapeHTML(item.name)}"
                                data-price="${item.price}">
                            Edit
                        </button>
                        <button class="btn-delete-menu-item bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs"
                                data-stall-id="${stallId}"
                                data-item-id="${item.id}"
                                data-name="${escapeHTML(item.name)}">
                            Del
                        </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function updateItemStock(stallId, itemId, newStock) {
            const stockValue = parseInt(newStock, 10);
            if (isNaN(stockValue) || stockValue < 0) {
                showAlert("Please enter a valid non-negative stock number.");
                return false;
            }

            showLoading(`Updating stock for item ${itemId}...`);
            const stallDocRef = doc(stallsRef(), stallId);
            try {
                await runTransaction(db, async (transaction) => {
                    const stallDoc = await transaction.get(stallDocRef);
                    if (!stallDoc.exists()) throw new Error("Stall not found.");

                    const stallData = stallDoc.data();
                    const menu = stallData.menu || [];
                    const itemIndex = menu.findIndex(item => item.id === itemId);

                    if (itemIndex === -1) throw new Error("Menu item not found.");

                    const updatedMenu = menu.map((item, index) =>
                        index === itemIndex ? { ...item, stock: stockValue } : item
                    );

                    transaction.update(stallDocRef, { menu: updatedMenu });
                });
                console.log(`Stock updated for ${itemId} in stall ${stallId} to ${stockValue}`);
                hideLoading();
                return true;
            } catch (error) {
                console.error("Update Stock Error:", error);
                showAlert(`Error updating stock: ${error.message}`);
                hideLoading();
                return false;
            }
        }

        // --- NEW: Function to show the edit item modal ---
        function showEditItemModal(e) {
            const { stallId, itemId, name, price } = e.currentTarget.dataset;
            if (editItemModal && editItemNameInput && editItemPriceInput && editItemId && editItemStallId) {
                editItemNameInput.value = name;
                editItemPriceInput.value = price;
                editItemId.value = itemId;
                editItemStallId.value = stallId;
                editItemModal.classList.remove('hidden');
            } else {
                console.error("Edit item modal elements not found");
                showAlert("Error: Could not open edit dialog.");
            }
        }

        // --- NEW: Function to handle saving changes from the modal ---
        async function handleSaveItemChanges() {
            if (!editItemNameInput || !editItemPriceInput || !editItemId || !editItemStallId) return;

            const newName = editItemNameInput.value;
            const newPrice = parseFloat(editItemPriceInput.value);
            const itemId = editItemId.value;
            const stallId = editItemStallId.value;

            if (!newName || isNaN(newPrice) || newPrice <= 0 || !itemId || !stallId) {
                return showAlert("Please enter a valid name and price (price > 0).");
            }

            showLoading("Saving changes...");
            const success = await updateMenuItem(stallId, itemId, newName, newPrice);
            if (success) {
                editItemModal.classList.add('hidden');
                showAlert("Item updated successfully.");
            }
            hideLoading();
        }

        // --- NEW: Transactional function to update item name/price ---
        async function updateMenuItem(stallId, itemId, newName, newPrice) {
            const stallDocRef = doc(stallsRef(), stallId);
            try {
                await runTransaction(db, async (transaction) => {
                    const stallDoc = await transaction.get(stallDocRef);
                    if (!stallDoc.exists()) throw new Error("Stall not found.");

                    const menu = stallDoc.data().menu || [];
                    const itemIndex = menu.findIndex(item => item.id === itemId);
                    if (itemIndex === -1) throw new Error("Menu item not found.");

                    const updatedMenu = menu.map((item, index) =>
                        index === itemIndex ? { ...item, name: newName, price: newPrice } : item
                    );

                    transaction.update(stallDocRef, { menu: updatedMenu });
                });
                console.log(`Item ${itemId} in stall ${stallId} updated.`);
                return true;
            } catch (error) {
                console.error("Update Item Error:", error);
                showAlert(`Error updating item: ${error.message}`);
                return false;
            }
        }

        // --- NEW: Transactional function to delete a menu item ---
        async function deleteMenuItem(stallId, itemId, itemName) {
            showLoading(`Deleting ${itemName}...`);
            const stallDocRef = doc(stallsRef(), stallId);
            try {
                await runTransaction(db, async (transaction) => {
                    const stallDoc = await transaction.get(stallDocRef);
                    if (!stallDoc.exists()) throw new Error("Stall not found.");

                    const menu = stallDoc.data().menu || [];
                    const updatedMenu = menu.filter(item => item.id !== itemId);

                    transaction.update(stallDocRef, { menu: updatedMenu });
                });
                console.log(`Item ${itemId} deleted from stall ${stallId}.`);
                showAlert(`${itemName} deleted successfully.`);
            } catch (error) {
                console.error("Delete Item Error:", error);
                showAlert(`Error deleting item: ${error.message}`);
            } finally {
                hideLoading();
            }
        }


        // --- MODIFIED: Added listeners for new/changed functionality ---
        function loadAdminStallsAndMenus() {
            const q = query(stallsRef());
            const unsub = onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('adminStallMenuList');
                const selectEl = document.getElementById('adminStallSelect');
                 if (!listEl || !selectEl) { console.error("Missing stall list/select elements"); return; }


                 if (snapshot.empty) {
                     listEl.innerHTML = '<p class="text-gray-400">No stalls.</p>'; selectEl.innerHTML = '<option value="">No stalls</option>'; 
                     updateAdminStallBulkDownloadButton();
                     return;
                 }

                listEl.innerHTML = snapshot.docs.map(doc => {
                    const stall = doc.data();
                    return `<div class="bg-gray-700 p-4 rounded-lg">
                                    <div class="flex justify-between items-center mb-2">
                                        <h4 class="text-lg font-semibold">${stall.name}</h4>
                                        <button data-id="${stall.ownerId}" data-name="${stall.name}" class="btn-delete-stall bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg text-sm">Delete</button>
                                    </div>
                                    <div id="menu-list-${stall.ownerId}" class="mt-2 space-y-1">
                                        ${renderMenuList(stall.menu, doc.id, true)} 
                                    </div>
                                </div>`;
                }).join('');

                selectEl.innerHTML = snapshot.docs.map(doc => `<option value="${doc.id}">${doc.data().name}</option>`).join('');

                // FIX: Capture data *before* calling showConfirm
                document.querySelectorAll('.btn-delete-stall').forEach(btn => {
                    const stallId = btn.dataset.id; // Capture id here
                    const stallName = btn.dataset.name; // Capture name here
                    btn.onclick = () => showConfirm(`Delete stall "${stallName}"?`, () => _deleteStall(stallId));
                });
                
                // Remove old listeners and add new ones for item management
                listEl.removeEventListener('change', handleStockInputChange);
                listEl.addEventListener('change', handleStockInputChange);

                document.querySelectorAll('.btn-edit-menu-item').forEach(btn => {
                    btn.onclick = showEditItemModal;
                });

                document.querySelectorAll('.btn-delete-menu-item').forEach(btn => {
                    // Data capture is already correct here
                    const { stallId, itemId, name } = btn.dataset;
                    btn.onclick = () => {
                        showConfirm(`Delete item "${name}"?`, () => deleteMenuItem(stallId, itemId, name));
                    };
                });
                
                updateAdminStallBulkDownloadButton();

            }, error => console.error("Error loading stalls:", error));
            currentUnsubscribes.push(unsub);
        }

        async function handleStockInputChange(e) {
            if (e.target.classList.contains('admin-stock-input')) {
                const stallId = e.target.dataset.stallId;
                const itemId = e.target.dataset.itemId;
                const newStock = e.target.value;
                const success = await updateItemStock(stallId, itemId, newStock);
                if (!success) {
                  const stallData = appState.allStallMenus[stallId]; 
                  const oldStock = stallData?.menu?.find(i=>i.id===itemId)?.stock ?? 0;
                  e.target.value = oldStock;
                }
            }
        }


        async function _deleteStall(stallId) {
            if (!stallId) return; showLoading('Deleting...');
            try { await deleteDoc(doc(usersRef(), stallId)); await deleteDoc(doc(stallsRef(), stallId)); }
            catch (e) { showAlert('Error: ' + e.message); } finally { hideLoading(); }
        }
        async function _deleteStudent(studentId) {
             if (!studentId) return; showLoading('Deleting...');
            try { await deleteDoc(doc(usersRef(), studentId)); }
            catch (e) { showAlert('Error: ' + e.message); } finally { hideLoading(); }
        }

        async function addMenuItem() {
            const stallSelect = document.getElementById('adminStallSelect');
            const nameInput = document.getElementById('adminItemName');
            const priceInput = document.getElementById('adminItemPrice');
            const stockInput = document.getElementById('adminItemStock');
             if (!stallSelect || !nameInput || !priceInput || !stockInput) { console.error("Missing elements for adding menu item"); return; }
            
            const stallId = stallSelect.value;
            const name = nameInput.value;
            const price = parseFloat(priceInput.value);
            const stock = parseInt(stockInput.value, 10);

            if (!stallId || !name || isNaN(price) || price <= 0 || isNaN(stock) || stock < 0) {
                showAlert('Please fill out all fields with valid values (price > 0, stock >= 0).');
                return;
            }

            showLoading('Adding item...');
            try {
                const stallDocRef = doc(stallsRef(), stallId);
                const newItem = {
                    id: 'item_' + crypto.randomUUID(), name, price, stock
                };
                await updateDoc(stallDocRef, { menu: arrayUnion(newItem) });

                nameInput.value = '';
                priceInput.value = '';
                stockInput.value = '';
                showAlert('Menu item added!');
            } catch (error) { showAlert('Error adding item.'); console.error(error); } finally { hideLoading(); }
        }


        function loadAdminReports() {
            // Clear existing listeners when manually refreshing or navigating to the tab
            currentUnsubscribes.filter(unsub => unsub.name === 'reports-tx-unsub' || unsub.name === 'reports-users-unsub').forEach(unsub => unsub.unsub());

             let allTx = []; let studentMap = new Map();
            // Note: onSnapshot listeners are used here, making this section reactive, but the explicit call
            // will ensure the latest state is pulled if the listener somehow lagged or was killed.
            const unsubTx = onSnapshot(query(transactionsRef()), snap => { allTx = snap.docs.map(d=>d.data()); _recalculateAdminReports(allTx, studentMap); }, e => console.error("Error loading transactions:", e));
            
            const unsubUsers = onSnapshot(query(usersRef(), where('role', '==', 'student')), snap => { studentMap = new Map(snap.docs.map(d=>[d.id, d.data().class || 'N/A'])); _recalculateAdminReports(allTx, studentMap); }, e => console.error("Error loading users for report:", e));
            
            // Store unsubscribe functions inside a wrapper object with a name property
            currentUnsubscribes.push({ unsub: unsubTx, name: 'reports-tx-unsub' }, { unsub: unsubUsers, name: 'reports-users-unsub' });
        }

        function _recalculateAdminReports(transactions, studentClassMap) {
            const listEl = document.getElementById('adminTransactionList');
            const totalSalesEl = document.getElementById('adminTotalSales');
            const totalRechargedEl = document.getElementById('adminTotalRecharged');
            const totalRefundedEl = document.getElementById('adminTotalRefunded'); // This will now track 'cash_out' deductions
            const outstandingBalanceEl = document.getElementById('adminOutstandingBalance');
            const totalTransactionsEl = document.getElementById('adminTotalTransactions');
            const avgPurchaseValueEl = document.getElementById('adminAvgPurchaseValue');
            const stallSalesEl = document.getElementById('adminStallSalesSummary');
            const topItemsEl = document.getElementById('adminTopItemsList');
            const classSpendingEl = document.getElementById('adminClassSpendingSummary');

            if (!listEl || !totalSalesEl || !totalRechargedEl || !outstandingBalanceEl || !totalTransactionsEl || !avgPurchaseValueEl || !stallSalesEl || !topItemsEl || !classSpendingEl || !totalRefundedEl) { // MODIFIED
                console.error("One or more report elements are missing from the DOM.");
                return;
            }

            let totalSales = 0, totalRecharged = 0, totalRefunded = 0, purchaseCount = 0; // MODIFIED
            const stallSales = {}, topItems = {}, classSpending = {};

             if (transactions.length === 0) {
                 listEl.innerHTML = '<p class="text-gray-400">No transactions yet.</p>';
                 totalSalesEl.textContent = '₹0.00';
                 totalRechargedEl.textContent = '₹0.00';
                 totalRefundedEl.textContent = '₹0.00'; // NEW
                 outstandingBalanceEl.textContent = '₹0.00';
                 totalTransactionsEl.textContent = '0';
                 avgPurchaseValueEl.textContent = '₹0.00';
                 stallSalesEl.innerHTML = '<p class="text-gray-400 text-sm">No sales yet.</p>';
                 topItemsEl.innerHTML = '<p class="text-gray-400 text-sm">No items sold yet.</p>';
                 classSpendingEl.innerHTML = '<p class="text-gray-400 text-sm">No spending data yet.</p>';
                 return;
             }

            transactions.forEach(tx => {
                if (tx.type === 'purchase') {
                    totalSales += tx.amount; purchaseCount++;
                    stallSales[tx.stallName] = (stallSales[tx.stallName] || 0) + tx.amount;
                    if (tx.items) tx.items.forEach(item => topItems[item.name] = (topItems[item.name] || 0) + item.quantity);
                    const studentClass = studentClassMap.get(tx.studentId) || 'N/A';
                    classSpending[studentClass] = (classSpending[studentClass] || 0) + tx.amount;
                } else if (tx.type === 'recharge') { 
                    totalRecharged += tx.amount; 
                } else if (tx.type === 'cash_out') { // MODIFIED: Tracking cash-out deductions here
                    totalRefunded += tx.amount;
                }
            });

            // Outstanding balance is Total Recharge - Total Spent (Sales) - Total Refunded (Cash Out)
            const outstanding = totalRecharged - totalSales - totalRefunded; // MODIFIED
            const totalTx = transactions.length; // MODIFIED
            const avgPurchase = purchaseCount > 0 ? totalSales / purchaseCount : 0;

            totalRechargedEl.textContent = `₹${totalRecharged.toFixed(2)}`;
            totalRefundedEl.textContent = `₹${totalRefunded.toFixed(2)}`; // NEW
            totalSalesEl.textContent = `₹${totalSales.toFixed(2)}`;
            outstandingBalanceEl.textContent = `₹${outstanding.toFixed(2)}`;
            totalTransactionsEl.textContent = totalTx;
            avgPurchaseValueEl.textContent = `₹${avgPurchase.toFixed(2)}`;

            const renderSummary = (element, data, formatFn) => {
                 element.innerHTML = Object.keys(data).length > 0 ? Object.entries(data).sort((a,b)=>b[1]-a[1]).map(formatFn).join('') : '<p class="text-gray-400 text-sm">No data.</p>';
            };

            renderSummary(stallSalesEl, stallSales, ([name, amt]) => `<div class="flex justify-between p-2 bg-gray-700 rounded"><span>${name}</span><span class="font-medium">₹${amt.toFixed(2)}</span></div>`);
            renderSummary(topItemsEl, topItems, ([name, qty]) => `<div class="flex justify-between p-2 bg-gray-700 rounded"><span class="font-medium">${name}</span><span>${qty} sold</span></div>`);
            renderSummary(classSpendingEl, classSpending, ([name, amt]) => `<div class="flex justify-between p-2 bg-gray-700 rounded"><span>Class ${name}</span><span class="font-medium">₹${amt.toFixed(2)}</span></div>`);


            listEl.innerHTML = transactions.map(tx => { 
                const time = tx.timestamp ? new Date(tx.timestamp.seconds * 1000).toLocaleTimeString() : '...';
                const itemsStr = tx.items ? tx.items.map(i => `${i.name} (x${i.quantity})`).join(', ') : '';
                
                // MODIFIED to reflect 'cash_out' deduction
                if (tx.type === 'purchase') return `<div class="bg-gray-700 p-3 rounded-lg"><p class="font-semibold">${tx.studentName} paid ${tx.stallName}</p><p class="text-sm">${itemsStr}</p><div class="flex justify-between items-center mt-1"><span class="text-red-400 font-bold">- ₹${tx.amount.toFixed(2)}</span><span class="text-xs text-gray-400">${time}</span></div></div>`;
                else if (tx.type === 'recharge') return `<div class="bg-gray-700 p-3 rounded-lg"><p class="font-semibold">${tx.studentName} recharged wallet</p><p class="text-sm text-gray-400">Processed by: ${tx.adminName ? 'Admin' : 'Self'}</p><div class="flex justify-between items-center mt-1"><span class="text-green-400 font-bold">+ ₹${tx.amount.toFixed(2)}</span><span class="text-xs text-gray-400">${time}</span></div></div>`;
                else if (tx.type === 'cash_out') return `<div class="bg-gray-700 p-3 rounded-lg"><p class="font-semibold">${tx.studentName} collected cash out</p><p class="text-sm text-gray-400">Deducted by: Admin</p><div class="flex justify-between items-center mt-1"><span class="text-red-400 font-bold">- ₹${tx.amount.toFixed(2)}</span><span class="text-xs text-gray-400">${time}</span></div></div>`;
                else return '';
             }).reverse().join('');
            appState.allTransactionsForExport = transactions;
        }
        
        // --- NEW VOTING ADMIN FUNCTIONS ---
        function loadAdminVotingResults() {
            const listEl = document.getElementById('adminVotingResults');
            if (!listEl) return;
            
            listEl.innerHTML = '<p class="text-yellow-400">Fetching votes...</p>';

            const unsub = onSnapshot(query(votesRef()), (snapshot) => {
                const allVotes = snapshot.docs.map(d => d.data());
                const results = calculateVotingResults(allVotes);
                renderVotingResults(listEl, results);
            }, error => {
                console.error("Error loading voting results:", error);
                listEl.innerHTML = '<p class="text-red-500">Error loading voting results.</p>';
            });
            currentUnsubscribes.push(unsub);
        }

        function calculateVotingResults(votes) {
            const results = {};
            votes.forEach(vote => {
                const categoryId = vote.category;
                const option = vote.option;

                if (!results[categoryId]) {
                    results[categoryId] = { totalVotes: 0, options: {} };
                }
                results[categoryId].totalVotes++;
                results[categoryId].options[option] = (results[categoryId].options[option] || 0) + 1;
            });
            return results;
        }

        function renderVotingResults(listEl, results) {
            if (Object.keys(results).length === 0) {
                listEl.innerHTML = '<p class="text-gray-400">No votes cast yet.</p>';
                return;
            }

            let html = '';
            // Use dynamic config (appState.votingConfig)
            appState.votingConfig.forEach(category => {
                const categoryResults = results[category.id];
                const categoryTitle = category.title;
                
                if (!categoryResults) return;

                // Sort options by vote count descending
                const sortedOptions = Object.entries(categoryResults.options)
                    .sort((a, b) => b[1] - a[1]);
                    
                const total = categoryResults.totalVotes;
                
                html += `
                    <div class="bg-gray-700 p-4 rounded-lg">
                        <h4 class="text-xl font-bold mb-2 text-pink-300">${categoryTitle} (${total} votes)</h4>
                        <div class="space-y-1">
                            ${sortedOptions.map(([option, count]) => {
                                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                                return `
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="font-medium">${option}</span>
                                        <span class="text-right">${count} votes (${percentage}%)</span>
                                    </div>
                                    <div class="w-full bg-gray-600 rounded-full h-2">
                                        <div class="bg-pink-500 h-2 rounded-full transition-all duration-500" style="width: ${percentage}%;"></div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });

            listEl.innerHTML = html;
        }

        // NEW: Renders the Admin UI list of voting categories
        function renderAdminVotingConfig() {
            const listEl = document.getElementById('adminVotingCategoriesList');
            if (!listEl) return;
            
            if (appState.votingConfig.length === 0) {
                listEl.innerHTML = '<p class="text-gray-400">No voting categories defined yet.</p>';
                return;
            }

            listEl.innerHTML = appState.votingConfig.map(category => {
                const optionsList = category.options.map(opt => `<span class="inline-block bg-gray-600 px-2 py-0.5 text-xs rounded-full">${opt}</span>`).join(' ');
                return `
                    <div class="bg-gray-700 p-3 rounded-lg space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-lg">${category.title}</span>
                            <div class="space-x-2 flex items-center flex-wrap justify-end">
                                <button class="btn-edit-voting-options bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm mt-1"
                                    data-id="${category.id}"
                                    data-title="${escapeHTML(category.title)}"
                                    data-options="${escapeHTML(category.options.join('\n'))}">
                                    Edit Options
                                </button>
                                <button class="btn-delete-voting-category bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm mt-1"
                                    data-id="${category.id}"
                                    data-title="${escapeHTML(category.title)}">
                                    Delete
                                </button>
                            </div>
                        </div>
                        <div>
                            <h5 class="text-sm text-gray-300 mb-1">Options:</h5>
                            <p class="text-sm space-x-1">${optionsList}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.querySelectorAll('.btn-delete-voting-category').forEach(btn => {
                const { id, title } = btn.dataset;
                btn.onclick = () => showConfirm(`Delete category "${title}"? This will remove all associated votes!`, () => deleteVotingCategory(id, title));
            });
            
            document.querySelectorAll('.btn-edit-voting-options').forEach(btn => {
                btn.onclick = showEditVotingOptionsModal;
            });
        }
        
        async function addVotingCategory() {
            const titleInput = document.getElementById('adminVotingCategoryTitle');
            const optionsInput = document.getElementById('adminVotingCategoryOptions');
            if (!titleInput || !optionsInput) return console.error("Missing input elements for voting category.");
            
            const title = titleInput.value.trim();
            const options = optionsInput.value.split('\n').map(o => o.trim()).filter(o => o.length > 0);
            
            if (!title) return showAlert("Please enter a category title.");
            if (options.length === 0) return showAlert("Please enter at least one option for the category.");
            
            showLoading("Adding category...");
            try {
                const newCategory = {
                    id: 'vote_' + crypto.randomUUID(),
                    title: title,
                    options: options
                };
                
                // Atomically update the categories array in the single config doc
                const configDoc = await getDoc(votingConfigRef());
                const categories = (configDoc.exists() && Array.isArray(configDoc.data().categories)) ? configDoc.data().categories : [];
                
                if(categories.find(c => c.title === title)) throw new Error("A category with this title already exists.");

                await setDoc(votingConfigRef(), { categories: [...categories, newCategory] });
                
                titleInput.value = '';
                optionsInput.value = '';
                showAlert("Voting category added successfully!");
                
            } catch (error) {
                console.error("Error adding voting category:", error);
                showAlert("Error adding category: " + error.message);
            } finally {
                hideLoading();
            }
        }

        async function deleteVotingCategory(categoryId, categoryTitle) {
            showLoading(`Deleting category "${categoryTitle}" and all associated votes...`);
            try {
                // 1. Remove the category from the config document via transaction
                const configRef = votingConfigRef();
                await runTransaction(db, async (transaction) => {
                    const configDoc = await transaction.get(configRef);
                    if (!configDoc.exists()) return;

                    const categories = configDoc.data().categories || [];
                    const updatedCategories = categories.filter(c => c.id !== categoryId);
                    
                    transaction.set(configRef, { categories: updatedCategories });
                });
                
                // 2. Delete all votes for this category (Fire-and-forget deletion, as it might take time)
                const q = query(votesRef(), where('category', '==', categoryId));
                const snapshot = await getDocs(q);
                const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deletePromises);
                
                showAlert(`Category "${categoryTitle}" and ${snapshot.size} votes deleted successfully.`);
            } catch (error) {
                console.error("Error deleting category:", error);
                showAlert("Error deleting category: " + error.message);
            } finally {
                hideLoading();
            }
        }

        function showEditVotingOptionsModal(e) {
            const { id, title, options } = e.currentTarget.dataset;
            const modal = document.getElementById('editVotingOptionsModal');
            const titleDisplay = document.getElementById('editVotingCategoryTitleDisplay');
            const optionsInput = document.getElementById('editVotingOptionsInput');
            const idInput = document.getElementById('editVotingCategoryId');

            if (modal && titleDisplay && optionsInput && idInput) {
                titleDisplay.textContent = title;
                optionsInput.value = options; // options is already '\n' separated
                idInput.value = id;
                modal.classList.remove('hidden');
            } else {
                console.error("Missing edit voting modal elements.");
                showAlert("Error opening edit dialog.");
            }
        }

        async function handleSaveVotingOptions() {
            const idInput = document.getElementById('editVotingCategoryId');
            const optionsInput = document.getElementById('editVotingOptionsInput');
            const modal = document.getElementById('editVotingOptionsModal');
            
            if (!idInput || !optionsInput) return;
            
            const categoryId = idInput.value;
            const newOptions = optionsInput.value.split('\n').map(o => o.trim()).filter(o => o.length > 0);

            if (newOptions.length === 0) return showAlert("A category must have at least one option.");

            showLoading("Saving voting options...");
            try {
                const configRef = votingConfigRef();
                
                await runTransaction(db, async (transaction) => {
                    const configDoc = await transaction.get(configRef);
                    if (!configDoc.exists()) throw new Error("Voting config not found.");
                    
                    const categories = configDoc.data().categories || [];
                    const categoryIndex = categories.findIndex(c => c.id === categoryId);
                    
                    if (categoryIndex === -1) throw new Error("Category not found.");
                    
                    // Create the updated category object
                    const updatedCategory = { ...categories[categoryIndex], options: newOptions };
                    // Rebuild the entire array to update the document in the transaction
                    const updatedCategories = categories.map((c, i) => i === categoryIndex ? updatedCategory : c);
                    
                    transaction.update(configRef, { categories: updatedCategories });
                });
                
                modal.classList.add('hidden');
                showAlert("Voting options updated successfully.");
            } catch (error) {
                console.error("Error saving voting options:", error);
                showAlert("Error saving changes: " + error.message);
            } finally {
                hideLoading();
            }
        }
        // --- END NEW VOTING ADMIN FUNCTIONS ---


        function exportTransactionsToCSV() {
            if (appState.allTransactionsForExport.length === 0) return showAlert('No transactions.');
            const escapeCSV = (str) => `"${(str || '').replace(/"/g, '""')}"`;
            let csv = "Date,Time,Type,Student,Amount,Stall,Items,Processor\r\n";
            appState.allTransactionsForExport.forEach(tx => {
                const dt = tx.timestamp ? new Date(tx.timestamp.seconds * 1000) : new Date();
                const itemsStr = tx.items ? tx.items.map(i => `${i.name}(x${i.quantity})`).join("|") : 'N/A';
                const processor = tx.adminName || 'Self';
                csv += [dt.toLocaleDateString(), dt.toLocaleTimeString(), tx.type, escapeCSV(tx.studentName), tx.amount.toFixed(2), escapeCSV(tx.stallName||'N/A'), escapeCSV(itemsStr), escapeCSV(processor)].join(',') + "\r\n";
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI("data:text/csv;charset=utf-8," + csv));
            link.setAttribute("download", `tx_${new Date().toISOString().split('T')[0]}.csv`);
            link.click();
        }

        // --- STUDENT DASHBOARD LOGIC ---
        function attachStudentDashboardListeners() { 
            const btnLogout = document.getElementById('btnStudentLogout');
            const btnBack = document.getElementById('btnStudentBack');
            const btnPrint = document.getElementById('btnStudentPrintPass');
            const btnDownload = document.getElementById('btnStudentDownloadQR');

            if(btnLogout) btnLogout.onclick = logout;
            else console.error("btnStudentLogout not found");
            if(btnBack) btnBack.onclick = logout;
             else console.error("btnStudentBack not found");
            if(btnPrint) btnPrint.onclick = () => printPass('student-printable-pass');
             else console.error("btnStudentPrintPass not found");
            if(btnDownload) btnDownload.onclick = () => downloadQR('studentPassQR', appState.currentUser?.name || 'student');
            else console.error("btnStudentDownloadQR not found");

            const btnRefreshStudent = document.getElementById('btnStudentRefresh');
            if(btnRefreshStudent) btnRefreshStudent.onclick = refreshStudentData;
            else console.error("btnStudentRefresh not found");
            
            // Tab Listeners
            const tabs = document.querySelectorAll('#studentDashboardView .student-tab');
            const tabPanels = document.querySelectorAll('#studentDashboardView .student-tab-panel');
            tabs.forEach(tab => {
                tab.onclick = () => {
                    tabs.forEach(t => { t.classList.replace('bg-blue-600', 'bg-gray-700'); t.classList.add('text-gray-300'); });
                    tabPanels.forEach(p => p.classList.add('hidden'));
                    tab.classList.replace('bg-gray-700', 'bg-blue-600');
                    tab.classList.remove('text-gray-300');
                    const targetPanel = document.getElementById(tab.dataset.target);
                    if (targetPanel) targetPanel.classList.remove('hidden');
                    else console.error("Target panel not found:", tab.dataset.target);
                };
            });
        }


        function loadStudentDashboard() { 
            showView('studentDashboard');
            const user = appState.currentUser;
            if (!user) { logout(); return; }
            
            // Reset tabs to default
            document.querySelectorAll('#studentDashboardView .student-tab').forEach((tab, index) => {
                 const targetPanel = document.getElementById(tab.dataset.target);
                 if (index === 0) { // First tab (Wallet)
                     tab.classList.replace('bg-gray-700', 'bg-blue-600');
                     tab.classList.remove('text-gray-300');
                     if(targetPanel) targetPanel.classList.remove('hidden');
                 } else {
                     tab.classList.replace('bg-blue-600', 'bg-gray-700');
                     tab.classList.add('text-gray-300');
                     if(targetPanel) targetPanel.classList.add('hidden');
                 }
            });


            const updateText = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; else console.error(`${id} not found`); };
            
            updateText('studentName', user.name);
            updateText('studentIdDisplay', `ID: ${user.id}`);
            updateText('studentPassName', user.name);
            updateText('studentPassClass', user.class || 'N/A');
            
            const qrContainer = document.getElementById('studentPassQR'); 
            if (qrContainer) {
                 qrContainer.innerHTML = '';
                 new QRCode(qrContainer, { text: user.id, width: 200, height: 200 });
            } else { console.error("studentPassQR container not found"); }

            const unsubBalance = onSnapshot(doc(usersRef(), user.id), (docSnap) => {
                const balanceEl = document.getElementById('studentBalance');
                if (docSnap.exists()) {
                    appState.currentUser.balance = docSnap.data().balance;
                    if(balanceEl) balanceEl.textContent = `₹${docSnap.data().balance.toFixed(2)}`;
                     else console.error("studentBalance element not found");
                } else logout();
            }, error => { console.error("Error listening to balance:", error); logout(); }); 
            currentUnsubscribes.push(unsubBalance);

            // Populate Event Info Tab
            const eventInfoEl = document.getElementById('studentEventInfo');
            if (eventInfoEl) eventInfoEl.innerHTML = formatEventInfo(appState.eventInfo);

            loadStudentStallList();
            loadStudentTransactionHistory();
            loadStudentVotingPanel(); 
        }
        
        // --- NEW VOTING STUDENT FUNCTIONS ---
        function loadStudentVotingPanel() {
            const listEl = document.getElementById('votingCategoriesList');
            if (!appState.currentUser || !listEl) return;

            // 1. Load current student's votes
            const q = query(votesRef(), where('studentId', '==', appState.currentUser.id));
            const unsubVotes = onSnapshot(q, (snapshot) => {
                studentVotesCache = {};
                snapshot.forEach(doc => {
                    const vote = doc.data();
                    studentVotesCache[vote.category] = vote.option;
                });
                renderVotingCategories(listEl); // Re-render when student's votes change
            }, error => {
                console.error("Error loading student votes:", error);
                if(listEl) listEl.innerHTML = '<p class="text-red-500">Error loading your vote history.</p>';
            });
            currentUnsubscribes.push(unsubVotes); 
        }

        function renderVotingCategories(listEl) {
            if (!listEl) return;

            if (appState.votingConfig.length === 0) {
                listEl.innerHTML = '<p class="text-gray-400">No voting categories are active yet.</p>';
                return;
            }

            let html = '';
            appState.votingConfig.forEach(category => {
                const hasVoted = studentVotesCache[category.id];
                const options = category.options; // Directly use the options array

                // FIX: Check if options array is valid and has contents
                if (!options || !Array.isArray(options) || options.length === 0) {
                    html += `<div class="bg-gray-700 p-4 rounded-lg"><h4 class="text-lg font-semibold">${category.title}</h4><p class="text-gray-400">No options defined for this category.</p></div>`;
                    return;
                }

                html += `
                    <div class="bg-gray-700 p-4 rounded-lg shadow-md border-t-4 ${hasVoted ? 'border-green-500' : 'border-pink-500'}">
                        <h4 class="text-xl font-bold mb-3">${category.title}</h4>
                        ${hasVoted ? `
                            <p class="text-green-400 font-semibold text-lg">Voted: ${hasVoted}</p>
                            <p class="text-sm text-gray-400 mt-1">Thank you for voting!</p>
                        ` : `
                            <p class="text-sm text-gray-300 mb-2">Select your choice:</p>
                            <div class="space-y-2">
                                ${options.map(option => `
                                    <button class="btn-vote w-full text-left bg-gray-600 hover:bg-pink-600 text-white py-2 px-3 rounded-lg transition-colors duration-150"
                                        data-category-id="${category.id}"
                                        data-option="${escapeHTML(option)}">
                                        ${option}
                                    </button>
                                `).join('')}
                            </div>
                        `}
                    </div>
                `;
            });
            listEl.innerHTML = html;

            // Attach listeners for newly rendered buttons
            document.querySelectorAll('.btn-vote').forEach(btn => {
                btn.onclick = handleVoteSubmissionClick;
            });
        }

        function handleVoteSubmissionClick(e) {
            const { categoryId, option } = e.currentTarget.dataset;
            const categoryTitle = appState.votingConfig.find(c=>c.id===categoryId)?.title || 'category'; 
            showConfirm(`Cast vote for **${option}** in the **${categoryTitle}**? You cannot change your vote later.`, () => {
                handleVoteSubmission(categoryId, option);
            });
        }


        async function handleVoteSubmission(category, option) {
            if (!appState.currentUser) return showAlert("You must be logged in to vote.");
            if (studentVotesCache[category]) return showAlert("You have already voted in this category.");

            showLoading("Casting vote...");
            try {
                // Pre-check (optional, but good)
                const categoryConfig = appState.votingConfig.find(c => c.id === category);
                if (!categoryConfig || !categoryConfig.options.includes(option)) {
                     throw new Error("Invalid category or option selected.");
                }

                await addDoc(votesRef(), {
                    studentId: appState.currentUser.id,
                    studentName: appState.currentUser.name,
                    class: appState.currentUser.class || 'N/A',
                    category: category,
                    option: option,
                    timestamp: serverTimestamp()
                });
                showAlert("Vote submitted successfully!");
            } catch (error) {
                console.error("Vote submission failed:", error);
                showAlert(`Failed to cast vote: ${error.message}`);
            } finally {
                hideLoading();
            }
        }
        // --- END NEW VOTING STUDENT FUNCTIONS ---

        function loadStudentStallList() {
            const listEl = document.getElementById('studentStallList');
             if (!listEl) { console.error("studentStallList not found"); return; }
            const stallsData = Object.values(appState.allStallMenus);

            if (!stallsData || stallsData.length === 0) {
                listEl.innerHTML = '<p class="text-gray-400">No stalls are open yet.</p>';
                return;
            }

            listEl.innerHTML = stallsData.map(stall => `
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h4 class="text-xl font-semibold text-blue-300">${stall.name}</h4>
                    <div class="mt-2 space-y-1">
                        ${renderMenuList(stall.menu, null, false)} 
                    </div>
                </div>
            `).join('');
        }

        function loadStudentTransactionHistory() { 
            if (!appState.currentUser) return;
            const q = query(transactionsRef(), where('studentId', '==', appState.currentUser.id));
            const listEl = document.getElementById('studentTransactionList');
             if (!listEl) { console.error("studentTransactionList not found"); return; }
            const unsub = onSnapshot(q, (snapshot) => {
                listEl.innerHTML = snapshot.empty ? '<p class="text-gray-400">No history.</p>' : snapshot.docs.map(d => {
                    const tx = d.data(); const time = tx.timestamp ? new Date(tx.timestamp.seconds * 1000).toLocaleString() : '...';
                    const itemsStr = tx.items ? tx.items.map(i => `${i.name} (x${i.quantity})`).join(', ') : '';
                    
                    // MODIFIED to include cash_out
                    if (tx.type === 'purchase') return `<div class="bg-gray-700 p-3 rounded-lg"><p class="font-semibold">Paid ${tx.stallName}</p><p class="text-sm">${itemsStr}</p><div class="flex justify-between items-center mt-1"><span class="text-red-400 font-bold">- ₹${tx.amount.toFixed(2)}</span><span class="text-xs text-gray-400">${time}</span></div></div>`;
                    else if (tx.type === 'recharge') return `<div class="bg-gray-700 p-3 rounded-lg"><p class="font-semibold">Wallet Recharge</p><p class="text-sm text-gray-400">Processed by: ${tx.adminName?'Admin':'Self'}</p><div class="flex justify-between items-center mt-1"><span class="text-green-400 font-bold">+ ₹${tx.amount.toFixed(2)}</span><span class="text-xs text-gray-400">${time}</span></div></div>`;
                    else if (tx.type === 'cash_out') return `<div class="bg-gray-700 p-3 rounded-lg"><p class="font-semibold">Cash Out Collected</p><p class="text-sm text-gray-400">Deducted by: Admin</p><div class="flex justify-between items-center mt-1"><span class="text-red-400 font-bold">- ₹${tx.amount.toFixed(2)}</span><span class="text-xs text-gray-400">${time}</span></div></div>`;
                    else return '';
                }).reverse().join('');
            }, error => console.error("Error loading student history:", error)); currentUnsubscribes.push(unsub);
        }

        // --- STALL DASHBOARD LOGIC ---
        function attachStallDashboardListeners() { 
            const btnLogout = document.getElementById('btnStallLogout');
            const btnBack = document.getElementById('btnStallBack');
            const btnScan = document.getElementById('btnStallScanToPay');

            if(btnLogout) btnLogout.onclick = logout;
            else console.error("btnStallLogout not found");
            if(btnBack) btnBack.onclick = logout;
            else console.error("btnStallBack not found");
            if(btnScan) btnScan.onclick = startStallPaymentScan;
             else console.error("btnStallScanToPay not found");

            const btnRefreshStall = document.getElementById('btnStallRefresh');
            if(btnRefreshStall) btnRefreshStall.onclick = refreshStallData;
            else console.error("btnStallRefresh not found");
            
            // Tab Listeners
            const tabs = document.querySelectorAll('#stallDashboardView .stall-tab');
            const tabPanels = document.querySelectorAll('#stallDashboardView .stall-tab-panel');
            tabs.forEach(tab => {
                tab.onclick = () => {
                    tabs.forEach(t => { t.classList.replace('bg-blue-600', 'bg-gray-700'); t.classList.add('text-gray-300'); });
                    tabPanels.forEach(p => p.classList.add('hidden'));
                    tab.classList.replace('bg-gray-700', 'bg-blue-600');
                    tab.classList.remove('text-gray-300');
                    const targetPanel = document.getElementById(tab.dataset.target);
                    if (targetPanel) targetPanel.classList.remove('hidden');
                    else console.error("Target panel not found:", tab.dataset.target);
                };
            });
        }

        function loadStallDashboard() {
            if (!appState.currentUser) { logout(); return; }
            showView('stallDashboard');
            
            // Reset tabs to default
            document.querySelectorAll('#stallDashboardView .stall-tab').forEach((tab, index) => {
                 const targetPanel = document.getElementById(tab.dataset.target);
                 if (index === 0) { // First tab (Sales)
                     tab.classList.replace('bg-gray-700', 'bg-blue-600');
                     tab.classList.remove('text-gray-300');
                     if(targetPanel) targetPanel.classList.remove('hidden');
                 } else {
                     tab.classList.replace('bg-blue-600', 'bg-gray-700');
                     tab.classList.add('text-gray-300');
                     if(targetPanel) targetPanel.classList.add('hidden');
                 }
            });
            
            const stallNameEl = document.getElementById('stallName');
            if (stallNameEl) stallNameEl.textContent = appState.currentUser.name;
            else console.error("stallName element not found");

            const stallDocRef = doc(stallsRef(), appState.currentUser.id);
            const unsubMenu = onSnapshot(stallDocRef, (docSnap) => {
                 const menuEl = document.getElementById('stallMenuList');
                 if (!menuEl) { console.error("stallMenuList not found"); return; }
                if (docSnap.exists()) {
                    const stall = docSnap.data();
                    menuEl.innerHTML = renderMenuList(stall.menu, null, false);
                    appState.currentUser.menu = stall.menu;
                } else logout();
            }, error => { console.error("Error loading stall menu:", error); logout(); });

            const q = query(transactionsRef(), where('stallId', '==', appState.currentUser.id));
            const listEl = document.getElementById('stallSaleList');
            const totalEl = document.getElementById('stallTotalSales');
            if (!listEl || !totalEl) { console.error("Missing stall sales list/total elements"); return;}

            const unsubHistory = onSnapshot(q, (snapshot) => {
                let totalSales = 0;
                listEl.innerHTML = snapshot.empty ? '<p class="text-gray-400">No sales.</p>' : snapshot.docs.map(d => {
                    const tx = d.data(); totalSales += tx.amount; const time = tx.timestamp ? new Date(tx.timestamp.seconds * 1000).toLocaleString() : '...';
                     const itemsStr = tx.items ? tx.items.map(i => `${i.name} (x${i.quantity})`).join(', ') : '';
                    return `<div class="bg-gray-700 p-3 rounded-lg"><p class="font-semibold">Sale to ${tx.studentName}</p><p class="text-sm">${itemsStr}</p><div class="flex justify-between items-center mt-1"><span class="text-green-400 font-bold">+ ₹${tx.amount.toFixed(2)}</span><span class="text-xs text-gray-400">${time}</span></div></div>`;
                }).reverse().join('');
                totalEl.textContent = `₹${totalSales.toFixed(2)}`;
            }, error => console.error("Error loading stall sales history:", error));
            
            // Populate Event Info Tab
            const eventInfoEl = document.getElementById('stallEventInfo');
            if (eventInfoEl) eventInfoEl.innerHTML = formatEventInfo(appState.eventInfo);

            currentUnsubscribes.push(unsubMenu, unsubHistory);
        }

        // --- STALL PAYMENT VIEW LOGIC ---
        function attachStallPaymentListeners() { 
            const btnCancel = document.getElementById('btnStallPaymentCancel');
            const btnConfirm = document.getElementById('btnStallConfirmPayment');
            if (btnCancel) btnCancel.onclick = () => loadStallDashboard();
             else console.error("btnStallPaymentCancel not found");
            if (btnConfirm) btnConfirm.onclick = processPayment;
            else console.error("btnStallConfirmPayment not found");
        }


        function startStallPaymentScan() {
             showView('stallPayment');
            appState.scannedStudentId = null; appState.stallCart = {};
            const detailsEl = document.getElementById('stallPaymentDetails');
            const scannerContainer = document.getElementById('stall-qr-reader-container');
            const confirmBtn = document.getElementById('btnStallConfirmPayment');
             if (!detailsEl || !scannerContainer || !confirmBtn) { console.error("Missing elements for stall payment scan"); return; }

            detailsEl.classList.add('hidden');
            scannerContainer.classList.remove('hidden');
            confirmBtn.classList.add('hidden');
            
            if (!stallQrScanner) {
                 try { stallQrScanner = new Html5Qrcode("stall-qr-reader"); } 
                 catch(e) { console.error("Failed to init stall scanner:", e); showAlert("Scanner failed"); loadStallDashboard(); return; }
            }
            stallQrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async (text) => {
                stopAllScanners(); showLoading('Fetching Student...');
                try {
                    const userDoc = await getDoc(doc(usersRef(), text));
                    if (!userDoc.exists() || userDoc.data().role !== 'student') throw new Error('Invalid student QR.');
                    const student = userDoc.data();
                    appState.scannedStudentId = text; appState.scannedStudentName = student.name;
                    scannerContainer.classList.add('hidden');
                    detailsEl.classList.remove('hidden');
                    confirmBtn.classList.remove('hidden');
                    
                    const nameEl = document.getElementById('stallPaymentStudentName');
                    const balanceEl = document.getElementById('stallPaymentStudentBalance');
                    if(nameEl) nameEl.textContent = student.name;
                    if(balanceEl) balanceEl.textContent = `₹${student.balance.toFixed(2)}`;

                    buildCartUI(student.balance);
                } catch (e) { showAlert(e.message); loadStallDashboard(); } finally { hideLoading(); }
            }, (e) => {/*console.warn(e)*/}).catch(err => { showAlert("Camera error."); loadStallDashboard(); });
        }


        function buildCartUI(studentBalance) { 
             const cartEl = document.getElementById('stallCart');
             if (!cartEl) { console.error("stallCart element not found"); return; }
            const menu = appState.currentUser?.menu || [];
            if (menu.length === 0) { 
                 cartEl.innerHTML = '<p class="text-yellow-400">Stall menu not available.</p>'; 
                 const confirmBtn = document.getElementById('btnStallConfirmPayment');
                 if(confirmBtn) confirmBtn.classList.add('hidden');
                 return; 
            }
            cartEl.innerHTML = menu.map(item => `
                <div class="bg-gray-700 p-3 rounded-lg flex items-center justify-between">
                    <div>
                        <p class="font-semibold">${item.name}</p>
                        <p class="text-sm text-blue-300">₹${item.price.toFixed(2)}</p>
                    </div>
                    <div class="flex items-center space-x-3">
                         <span class="text-xs ${item.stock <= 0 ? 'text-red-400 font-bold' : 'text-gray-300'}">(${item.stock || 0} left)</span>
                        <button data-id="${item.id}" class="btn-cart-change bg-red-600 w-8 h-8 rounded-full font-bold text-lg">-</button>
                        <span id="cart-qty-${item.id}" class="text-xl font-bold w-10 text-center">0</span>
                        <button data-id="${item.id}" class="btn-cart-change bg-green-600 w-8 h-8 rounded-full font-bold text-lg">+</button>
                    </div>
                </div>
            `).join('');
            document.querySelectorAll('.btn-cart-change').forEach(btn => {
                btn.onclick = (e) => updateCart(e.target.dataset.id, e.target.textContent === '+', studentBalance);
            });
            updateCartTotal(studentBalance);
        }

        function updateCart(itemId, isIncrement, studentBalance) {
            let currentQty = appState.stallCart[itemId] || 0;
            const menuMap = new Map((appState.currentUser?.menu || []).map(i => [i.id, i]));
            const item = menuMap.get(itemId);
            if (!item) { console.error(`Item ${itemId} not found in stall menu`); return; }
            const itemStock = item.stock || 0; 

            if (isIncrement) {
                if (currentQty >= itemStock) {
                    showAlert(`Cannot add more ${item.name}, only ${itemStock} available.`);
                    return; 
                }
                currentQty++;
            } else {
                currentQty = Math.max(0, currentQty - 1);
            }

            if (currentQty === 0) delete appState.stallCart[itemId];
            else appState.stallCart[itemId] = currentQty;

            const qtyEl = document.getElementById(`cart-qty-${itemId}`);
            if (qtyEl) qtyEl.textContent = currentQty;
            else console.error(`cart-qty-${itemId} element not found`);
            updateCartTotal(studentBalance);
        }


        function updateCartTotal(studentBalance) { 
             const totalEl = document.getElementById('stallCartTotal');
            const confirmBtn = document.getElementById('btnStallConfirmPayment');
             if (!totalEl || !confirmBtn) { console.error("Missing cart total/confirm button elements"); return; }

            const menuMap = new Map((appState.currentUser?.menu||[]).map(i=>[i.id, i]));
            let total = 0;
            for (const [id, qty] of Object.entries(appState.stallCart)) { total += (menuMap.get(id)?.price || 0) * qty; }
            totalEl.textContent = `₹${total.toFixed(2)}`;
            const canAfford = total <= studentBalance; const hasItems = total > 0;
            totalEl.classList.toggle('text-red-500', !canAfford); totalEl.classList.toggle('text-green-400', canAfford);
            confirmBtn.disabled = !canAfford || !hasItems;
            confirmBtn.classList.toggle('opacity-50', !canAfford || !hasItems); confirmBtn.classList.toggle('cursor-not-allowed', !canAfford || !hasItems);
        }

        async function processPayment() {
             if (!appState.currentUser || !appState.scannedStudentId) {
                 showAlert("Error: Missing user or scanned student data.");
                 return;
             }
            const menuMap = new Map((appState.currentUser.menu || []).map(i => [i.id, i]));
            let totalAmount = 0;
            const cartItemsForTx = []; 
            const itemsToUpdateStock = []; 

            for (const [itemId, quantity] of Object.entries(appState.stallCart)) {
                if (quantity > 0) {
                    const item = menuMap.get(itemId);
                    if (!item) {showAlert(`Error: Item ${itemId} not found in menu.`); return;} 
                    totalAmount += item.price * quantity;
                    cartItemsForTx.push({ id: itemId, name: item.name, price: item.price, quantity: quantity });
                    itemsToUpdateStock.push({ id: itemId, quantity });
                }
            }

            if (totalAmount === 0) return showAlert('Cart is empty.');

            showLoading('Processing Payment...');
            const studentId = appState.scannedStudentId;
            const stallId = appState.currentUser.id;
            const studentDocRef = doc(usersRef(), studentId);
            const stallDocRef = doc(stallsRef(), stallId); 

            try {
                await runTransaction(db, async (transaction) => {
                    // 1. Get student and stall data
                    const studentDoc = await transaction.get(studentDocRef);
                    const stallDoc = await transaction.get(stallDocRef);
                    if (!studentDoc.exists()) throw new Error("Student not found.");
                    if (!stallDoc.exists()) throw new Error("Stall not found.");

                    // 2. Check balance
                    const studentBalance = studentDoc.data().balance;
                    if (studentBalance < totalAmount) throw new Error("Insufficient student balance.");

                    // 3. Check stock and prepare stock updates
                    const currentMenu = stallDoc.data().menu || [];
                    const updatedMenu = [...currentMenu]; 
                    let stockError = null;

                    for (const itemUpdate of itemsToUpdateStock) {
                        const itemIndex = updatedMenu.findIndex(i => i.id === itemUpdate.id);
                        if (itemIndex === -1) { stockError = `Item ${itemUpdate.id} missing.`; break; }
                        const currentStock = updatedMenu[itemIndex].stock || 0;
                        if (currentStock < itemUpdate.quantity) { stockError = `Stock error for ${updatedMenu[itemIndex].name}. ${currentStock} left.`; break; }
                        updatedMenu[itemIndex] = { ...updatedMenu[itemIndex], stock: currentStock - itemUpdate.quantity };
                    }
                    if (stockError) throw new Error(stockError); // Abort

                    // 4. Update balance
                    transaction.update(studentDocRef, { balance: increment(-totalAmount) });
                    // 5. Update stock
                    transaction.update(stallDocRef, { menu: updatedMenu });
                    // 6. Log transaction
                    transaction.set(doc(transactionsRef()), { studentId, studentName: appState.scannedStudentName, stallId, stallName: appState.currentUser.name, amount: totalAmount, items: cartItemsForTx, type: 'purchase', timestamp: serverTimestamp() });
                });
                showAlert('Payment Successful!');
                loadStallDashboard(); 
            } catch (error) {
                console.error("Payment Error:", error);
                showAlert(`Payment Failed: ${error.message}`);
                hideLoading(); 
            }
        }


        // --- ADMIN RECHARGE VIEW LOGIC ---
        function attachAdminRechargeListeners() { 
            const btnCancel = document.getElementById('btnAdminRechargeCancel');
            const btnConfirm = document.getElementById('btnAdminConfirmRecharge');
            const btnCashOut = document.getElementById('btnAdminConfirmCashOut'); // MODIFIED ID
            
            if(btnCancel) btnCancel.onclick = () => loadAdminDashboard();
              else console.error("btnAdminRechargeCancel not found");
            
            // Recharge calls with sign=1 (ADD)
            if(btnConfirm) btnConfirm.onclick = () => _processBalanceChange('recharge', 1); 
             else console.error("btnAdminConfirmRecharge not found");
            
            // Cash Out calls with sign=-1 (DEDUCT)
            if(btnCashOut) btnCashOut.onclick = () => _processBalanceChange('cash_out', -1); 
             else console.error("btnAdminConfirmCashOut not found");
        }

        function startAdminRechargeScan() { 
            showView('adminRecharge'); appState.scannedStudentId=null;
            const detailsEl = document.getElementById('adminRechargeDetails');
            const scannerContainer = document.getElementById('admin-recharge-qr-reader-container');
            const confirmBtn = document.getElementById('btnAdminConfirmRecharge');
            const cashOutBtn = document.getElementById('btnAdminConfirmCashOut'); // MODIFIED
            const amountInput = document.getElementById('adminRechargeAmount');
             if (!detailsEl || !scannerContainer || !confirmBtn || !amountInput || !cashOutBtn) { console.error("Missing elements for admin recharge scan"); return; }


            detailsEl.classList.add('hidden');
            scannerContainer.classList.remove('hidden');
            confirmBtn.classList.add('hidden');
            cashOutBtn.classList.add('hidden'); // MODIFIED
            amountInput.value = '';
            
            if(!adminRechargeQrScanner) {
                 try { adminRechargeQrScanner = new Html5Qrcode("admin-recharge-qr-reader"); } 
                 catch(e) { console.error("Failed to init admin recharge scanner:", e); showAlert("Scanner failed"); loadAdminDashboard(); return; }
            }
            adminRechargeQrScanner.start({facingMode:"environment"},{fps:10,qrbox:250}, async (text)=>{
                stopAllScanners(); showLoading('Fetching...');
                try {
                    const userDoc = await getDoc(doc(usersRef(),text));
                    if(!userDoc.exists() || userDoc.data().role !== 'student') throw new Error('Invalid student QR.');
                    const student = userDoc.data(); appState.scannedStudentId=text; appState.scannedStudentName=student.name;
                    scannerContainer.classList.add('hidden');
                    detailsEl.classList.remove('hidden');
                    confirmBtn.classList.remove('hidden');
                    cashOutBtn.classList.remove('hidden'); // MODIFIED

                    const nameEl = document.getElementById('adminRechargeStudentName');
                    const balanceEl = document.getElementById('adminRechargeStudentBalance');
                    if (nameEl) nameEl.textContent = `${student.name} (${student.class||'N/A'})`;
                     else console.error("adminRechargeStudentName not found");
                    if (balanceEl) balanceEl.textContent = `₹${student.balance.toFixed(2)}`;
                    else console.error("adminRechargeStudentBalance not found");

                } catch(e) { showAlert(e.message); loadAdminDashboard(); } finally { hideLoading(); }
            }, (e)=>{/*console.warn(e)*/}).catch(err=>{showAlert("Camera error."); loadAdminDashboard();});
        }
        
        // MODIFIED: Renamed to _processBalanceChange and added sign logic
        async function _processBalanceChange(type, sign) { 
             const amountInput = document.getElementById('adminRechargeAmount');
             if (!amountInput) { console.error("adminRechargeAmount input not found"); return; }
            const amount = parseFloat(amountInput.value);
            if (!amount || amount <= 0) return showAlert('Invalid amount.');
             if (!appState.scannedStudentId) { showAlert("No student scanned."); return; }

            showLoading('Processing...'); const studentId = appState.scannedStudentId; const studentRef = doc(usersRef(), studentId);
            try {
                await runTransaction(db, async tx => {
                    const studentDoc = await tx.get(studentRef); if (!studentDoc.exists()) throw new Error("Student not found.");
                    
                    const changeAmount = amount * sign; // -amount for cash_out, +amount for recharge

                    // Check for insufficient funds only if deducting
                    if (sign === -1 && studentDoc.data().balance < amount) {
                        throw new Error(`Insufficient funds. Current balance: ₹${studentDoc.data().balance.toFixed(2)}`);
                    }
                    
                    tx.update(studentRef, { balance: increment(changeAmount) }); 
                    tx.set(doc(transactionsRef()), { 
                        studentId, 
                        studentName:appState.scannedStudentName, 
                        amount, // Always log the positive absolute amount
                        type: type, // 'recharge' or 'cash_out'
                        adminName:appState.currentUser?.id || 'admin', 
                        timestamp:serverTimestamp() 
                    });
                });
                showAlert(`${type === 'recharge' ? 'Recharge' : 'Cash Out'} OK!`); 
                loadAdminDashboard();
            } catch (e) { showAlert(`Error: ${e.message}`); } finally { hideLoading(); }
        }

        // --- NEW BULK IMPORT FUNCTIONS ---

        async function createStudentInFirestore(name, className) {
            if (!name || !className) {
                console.warn("Skipping invalid student data:", { name, className });
                throw new Error("Missing name or class");
            }
            
            // Check if class exists, if not, add it.
            const classesSnap = await getDoc(classesRef());
            // FIX: Corrected syntax error (ReferenceError) in classesSnap check
            const classNames = (classesSnap.exists() && classesSnap.data().classNames) ? classesSnap.data().classNames : [];
            if (!classNames.includes(className)) {
                console.log(`Adding new class from bulk import: ${className}`);
                await setDoc(classesRef(), { classNames: arrayUnion(className) }, { merge: true });
            }

            const newUser = {
                name,
                role: 'student',
                balance: 0,
                class: className,
                createdAt: serverTimestamp()
            };
            const newDocRef = await addDoc(usersRef(), newUser);
            await updateDoc(newDocRef, { userId: newDocRef.id });
            return newDocRef.id;
        }

        async function processBulkImport(students) {
            let success = 0;
            let failed = 0;
            const total = students.length;

            for (let i = 0; i < total; i++) {
                const student = students[i];
                try {
                    await createStudentInFirestore(student.name, student.class);
                    success++;
                } catch (error) {
                    console.error("Failed to import student:", student.name, error);
                    failed++;
                }

                // Update loading message every 10 students or on the last one
                if ((i + 1) % 10 === 0 || (i + 1) === total) {
                    showLoading(`Importing... ${i + 1} / ${total}`);
                }
            }
            return { success, failed };
        }

        function parseCSV(csvText) {
            const students = [];
            if (!csvText) return students;

            const lines = csvText.split('\n');
            lines.forEach(line => {
                const trimmedLine = line.trim();
                if (trimmedLine) {
                    // Find the last comma
                    const lastCommaIndex = trimmedLine.lastIndexOf(',');
                    if (lastCommaIndex > -1 && lastCommaIndex < trimmedLine.length -1) {
                        const name = trimmedLine.substring(0, lastCommaIndex).trim();
                        const className = trimmedLine.substring(lastCommaIndex + 1).trim();

                        // Basic validation and skip header
                        if (name && className && name.toLowerCase() !== "name" && className.toLowerCase() !== "class") {
                            students.push({ name, class: className });
                        }
                    }
                }
            });
            console.log(`Parsed ${students.length} students from CSV.`);
            return students;
        }

        async function handleBulkImport() {
            const fileInput = document.getElementById('adminStudentBulkUpload');
            if (!fileInput.files || fileInput.files.length === 0) {
                return showAlert("Please select a CSV file to upload.");
            }
            const file = fileInput.files[0];

            if (file.type !== "text/csv" && !file.name.endsWith(".csv") && file.type !== "application/vnd.ms-excel") {
                return showAlert("Invalid file type. Please upload a .csv file.");
            }

            showLoading("Reading CSV file...");

            try {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const csvText = event.target.result;
                        const studentsToCreate = parseCSV(csvText);

                        if (studentsToCreate.length === 0) {
                            hideLoading();
                            return showAlert("No valid student data found in the CSV. Make sure format is: Name,Class (no header row).");
                        }

                        showLoading(`Importing ${studentsToCreate.length} students...`);
                        const results = await processBulkImport(studentsToCreate);

                        hideLoading();
                        showAlert(`Bulk import complete:\n- ${results.success} students imported successfully.\n- ${results.failed} students failed to import (see console for errors).`);
                        
                        fileInput.value = ''; // Clear the file input

                    } catch (readError) {
                        console.error("Error processing file content:", readError);
                        hideLoading();
                        showAlert(`Error processing file: ${readError.message}`);
                    }
                };
                reader.onerror = () => {
                    console.error("FileReader error:", reader.error);
                    hideLoading();
                    showAlert("Error reading the selected file.");
                };
                reader.readAsText(file);

            } catch (error) {
                console.error("Bulk Import Error:", error);
                hideLoading();
                showAlert(`An error occurred: ${error.message}`);
            }
        }
        // --- END NEW BULK IMPORT FUNCTIONS ---

    </script>

    <style>
        .spinner { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media print {
            body * { visibility: hidden; } .print-this-one, .print-this-one * { visibility: visible; }
            .print-this-one { position: absolute; left: 0; top: 0; width: 100%; max-width: 100%; margin: 0; padding: 0; border: none !important; box-shadow: none !important; background-color: white !important; }
            .print-this-one div[id^="qr-code-inner-"], .print-this-one #studentPassQR { background-color: white !important; }
            .print-this-one, .print-this-one * { color: #000 !important; background-color: white !important; }
            .print-hide { display: none !important; }
        }
        /* Helper for formatting event info */
        .event-info-content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans antialiased">

    <!-- Main Container --><div class="container mx-auto p-4 max-w-lg min-h-screen pb-16">

        <!-- VIEW: Home --><div id="homeView" class="">
            <header class="text-center my-12"> <h1 class="text-4xl font-bold text-blue-400 mb-2">Smart QR Event Wallet</h1> <p class="text-lg text-gray-300">Udaya Public School - Annual Fest 2025-26</p> </header>
            
            <main class="space-y-6"> <button id="btnAdminLogin" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg text-lg transition-all">Admin Login</button> <button id="btnStallLogin" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg text-lg transition-all">Stall Login (Scan QR)</button> <button id="btnStudentLogin" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg text-lg transition-all">Student Login (Scan QR)</button> </main>
        </div>

        <!-- VIEW: Admin Login --><div id="adminLoginView" class="hidden">
            <header class="my-8"> <div class="flex items-center space-x-3 mb-4"> <div> <h2 class="text-lg font-semibold text-white">Udaya Public School</h2> <p class="text-sm text-gray-400">Annual Fest 2025-26</p> </div> </div> <button id="btnAdminLoginBack" class="text-blue-400 hover:text-blue-300">&larr; Back to Home</button> <h1 class="text-3xl font-bold text-center text-red-400 mt-4">Admin Login</h1> </header>
            <main class="space-y-4 bg-gray-800 p-6 rounded-lg shadow-xl"> <div> <label for="adminPassword" class="block text-sm font-medium text-gray-300 mb-1">Password</label> <input type="password" id="adminPassword" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3 focus:ring-red-500 focus:border-red-500" placeholder="••••••••"> </div> <button id="btnAdminLoginSubmit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all"> Login </button> 
            </main>
        </div>

        <!-- VIEW: Admin Dashboard --><div id="adminDashboardView" class="hidden">
            <header class="my-8 flex justify-between items-center"> 
                <div class="flex items-center space-x-3"> 
                    <div> 
                        <h1 class="text-3xl font-bold text-red-400">Admin Dashboard</h1> 
                        <p class="text-sm text-gray-400">Udaya Public School</p> 
                    </div> 
                </div> 
                <div class="flex space-x-3">
                    <button id="btnAdminRefresh" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg text-sm transition-all self-start">Refresh Data</button>
                    <button id="btnAdminLogout" class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg text-sm transition-all self-start">Logout</button> 
                </div>
            </header>
            <!-- Admin Tabs --><div class="mb-4 border-b border-gray-700"> <nav class="flex space-x-1 overflow-x-auto pb-2" aria-label="Tabs"> <button data-target="panel-students" class="admin-tab bg-blue-600 text-white px-4 py-3 rounded-t-lg font-medium text-sm flex-shrink-0">Students</button> <button data-target="panel-stalls" class="admin-tab bg-gray-700 text-gray-300 px-4 py-3 rounded-t-lg font-medium text-sm flex-shrink-0">Stalls</button> <button data-target="panel-classes" class="admin-tab bg-gray-700 text-gray-300 px-4 py-3 rounded-t-lg font-medium text-sm flex-shrink-0">Classes</button> <button data-target="panel-reports" class="admin-tab bg-gray-700 text-gray-300 px-4 py-3 rounded-t-lg font-medium text-sm flex-shrink-0">Reports</button> <!-- NEW TAB --> <button data-target="panel-event" class="admin-tab bg-gray-700 text-gray-300 px-4 py-3 rounded-t-lg font-medium text-sm flex-shrink-0">Event</button> </nav> </div>
            <main class="space-y-6">
                <!-- Panel 1: Manage Students -->
                <div id="panel-students" class="admin-tab-panel space-y-6">
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h2 class="text-2xl font-semibold mb-4 text-blue-300">Generate Student</h2> <div class="space-y-4"> <input type="text" id="adminStudentName" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Student Name"> <select id="adminStudentClassSelect" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3"> <option value="">Select a Class</option> </select> <button id="btnAdminGenerateStudent" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all"> Generate Student QR </button> <div id="adminStudentQRContainer" class="mt-4"> </div> <button id="btnAdminRechargeStudent" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all mt-4"> Recharge / Refund Student (Scan QR) </button> </div> </section>
                    
                    <!-- NEW Bulk Import Section -->
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-semibold mb-4 text-purple-300">Bulk Import Students</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="adminStudentBulkUpload" class="block text-sm font-medium text-gray-300 mb-1">Upload CSV File</label>
                                <input type="file" id="adminStudentBulkUpload" accept=".csv,application/vnd.ms-excel" class="w-full text-sm text-gray-400
                                            file:mr-4 file:py-2 file:px-4
                                            file:rounded-lg file:border-0
                                            file:text-sm file:font-semibold
                                            file:bg-purple-600 file:text-white
                                            hover:file:bg-purple-700
                                            cursor-pointer">
                                <p class="text-xs text-gray-400 mt-2">Required format: <code class="bg-gray-700 px-1 rounded">Name,Class</code> (one per line, no header row).</p>
                                <p class="text-xs text-gray-400">Example: <code class="bg-gray-700 px-1 rounded">John Doe,10-A</code></p>
                            </div>
                            <button id="btnAdminBulkImport" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all">
                                Start Bulk Import
                            </button>
                        </div>
                    </section>
                    
                    <!-- +++ NEW SECTION +++ -->
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-semibold mb-4 text-yellow-300">Find Student by Name</h2>
                        <div class="space-y-4">
                            <input type="text" id="adminSearchStudentName" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Enter Full Student Name">
                            <button id="btnAdminSearchStudent" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all">
                                Search Student
                            </button>
                            <div id="adminSearchStudentQRContainer" class="mt-4 hidden">
                                <!-- QR will be rendered here by displayUserQR -->
                            </div>
                        </div>
                    </section>
                    
                    <!-- MODIFIED: Added btnDownloadAllPasses -->
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h2 class="text-2xl font-semibold mb-4 text-yellow-300">Find Student QR by Class</h2> <div class="space-y-4"> <div> <label class="block text-sm font-medium text-gray-300 mb-1">Select Class</label> <select id="adminSearchClassSelect" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3"> <option value="">Select a Class</option> </select> </div> <div id="adminStudentListByClass" class="space-y-2 max-h-60 overflow-y-auto"> </div> <button id="btnDownloadAllPasses" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all mt-4 hidden"> Download All Passes for this Class </button> <div id="adminSearchQRContainer" class="mt-4 hidden"> </div> </div> </section>
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h2 class="text-2xl font-semibold mb-4">Current Students</h2> <div id="adminStudentList" class="space-y-2 max-h-60 overflow-y-auto"> </div> </section>
                </div>

                <!-- Panel 2: Manage Stalls -->
                <div id="panel-stalls" class="admin-tab-panel hidden space-y-6">
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h2 class="text-2xl font-semibold mb-4 text-green-300">Generate Stall</h2> <div class="space-y-4"> <input type="text" id="adminStallName" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Stall Name (e.g., Pizza Corner)"> <button id="btnAdminGenerateStall" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all"> Generate Stall QR </button> <div id="adminStallQRContainer" class="mt-4"> </div> </section>

                    <!-- NEW: Bulk Stall Download Button -->
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> 
                        <h2 class="text-2xl font-semibold mb-4 text-purple-300">Bulk Download Stall Passes</h2>
                        <p class="text-sm text-gray-400 mb-4">Download QR passes for all registered stalls. Passes are formatted to print 6 per page.</p>
                        <button id="btnDownloadAllStallPasses" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all hidden"> Download All Stall Passes </button>
                    </section>
                    
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h2 class="text-2xl font-semibold mb-4 text-yellow-300">Find Stall QR</h2> <div class="space-y-4"> <input type="text" id="adminSearchStallName" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Enter Full Stall Name"> <button id="btnAdminSearchStall" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all"> Search </button> <div id="adminSearchStallQRContainer" class="mt-4 hidden"> </div> </section>
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-semibold mb-4 text-green-300">Add Menu Item</h2>
                        <div class="space-y-4">
                            <div><label class="block text-sm font-medium text-gray-300 mb-1">Select Stall</label><select id="adminStallSelect" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3"></select></div>
                            <input type="text" id="adminItemName" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Item Name">
                            <input type="number" id="adminItemPrice" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Item Price">
                            <input type="number" id="adminItemStock" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Initial Stock (e.g., 50)" min="0">
                            <button id="btnAdminAddMenuItem" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all">Add Item</button>
                        </div>
                    </section>
                    <section>
                        <h2 class="text-2xl font-semibold mb-4">Current Stalls & Menus</h2>
                        <div id="adminStallMenuList" class="space-y-4"> </div>
                    </section>
                </div>

                <!-- Panel 3: Manage Classes -->
                <div id="panel-classes" class="admin-tab-panel hidden space-y-6">
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h2 class="text-2xl font-semibold mb-4 text-purple-300">Add New Class</h2> <div class="space-y-4"> <input type="text" id="adminClassName" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Class Name (e.g., 10-A, 12-C)"> <button id="btnAdminAddClass" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all"> Add Class </button> </div> </section>
                    <section> <h2 class="text-2xl font-semibold mb-4">Current Classes</h2> <div id="adminClassList" class="space-y-3"> </div> </section>
                </div>

                <!-- Panel 4: Reports -->
                <div id="panel-reports" class="admin-tab-panel hidden space-y-6">
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-4"> <h2 class="text-2xl font-semibold mb-4 text-yellow-300">Event Financials</h2> <div class="flex justify-between bg-gray-700 p-4 rounded-lg"> <span>Total Recharged:</span> <span id="adminTotalRecharged" class="text-lg font-bold text-green-400">₹0.00</span> </div> <div class="flex justify-between bg-gray-700 p-4 rounded-lg"> <span>Total Sales:</span> <span id="adminTotalSales" class="text-lg font-bold text-red-400">₹0.00</span> </div> <!-- NEW Refund Stat --> <div class="flex justify-between bg-gray-700 p-4 rounded-lg"> <span>Total Refunded (Cash Out):</span> <span id="adminTotalRefunded" class="text-lg font-bold text-yellow-400">₹0.00</span> </div> <div class="flex justify-between bg-gray-700 p-4 rounded-lg"> <span>Outstanding Balance:</span> <span id="adminOutstandingBalance" class="text-lg font-bold text-blue-400">₹0.00</span> </div> <div class="grid grid-cols-2 gap-4"> <div class="bg-gray-700 p-4 rounded-lg text-center"> <span class="text-sm text-gray-400">Total Transactions</span> <span id="adminTotalTransactions" class="text-2xl font-bold block">0</span> </div> <div class="bg-gray-700 p-4 rounded-lg text-center"> <span class="text-sm text-gray-400">Avg. Purchase</span> <span id="adminAvgPurchaseValue" class="text-2xl font-bold block">₹0.00</span> </div> </div> </section>
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h3 class="text-xl font-semibold mb-2">Sales per Stall</h3> <div id="adminStallSalesSummary" class="space-y-2 max-h-60 overflow-y-auto"> </div> </section>
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h3 class="text-xl font-semibold mb-2">Top-Selling Items</h3> <div id="adminTopItemsList" class="space-y-2 max-h-60 overflow-y-auto"> </div> </section> <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h3 class="text-xl font-semibold mb-2">Total Spending by Class</h3> <div id="adminClassSpendingSummary" class="space-y-2 max-h-60 overflow-y-auto"> </div> </section>
                    <!-- NEW: Voting Results Summary -->
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> 
                        <h2 class="text-2xl font-semibold mb-4 text-pink-300">Voting Results Summary</h2> 
                        <div id="adminVotingResults" class="space-y-4">
                            <p class="text-gray-400">Loading results...</p>
                        </div>
                    </section>
                    <section class="flex justify-between items-center mb-4"> 
                        <h2 class="text-2xl font-semibold text-yellow-300">Transaction History</h2> 
                        <button id="btnAdminRefreshReports" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition-all text-sm">Refresh Data</button> 
                    </section> 
                    <section> 
                         <div id="adminTransactionList" class="space-y-3 max-h-96 overflow-y-auto"> </div> 
                         <button id="btnExportCSV" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all mt-4"> Export All Transactions to CSV </button>
                    </section>
                </div>
                
                <!-- NEW Panel 5: Manage Event Info & Voting Categories -->
                <div id="panel-event" class="admin-tab-panel hidden space-y-6">
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-semibold mb-4 text-indigo-300">Edit Event Info</h2>
                        <div class="space-y-4">
                            <p class="text-sm text-gray-400">This content will be displayed on the "Event" tab for all students and stalls. You can include schedules, announcements, rules, etc. (Line breaks will be preserved).</p>
                            <textarea id="adminEventInfoTextarea" rows="10" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Enter event info here..."></textarea>
                            <button id="btnAdminSaveEventInfo" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all">
                                Save Event Info
                            </button>
                        </div>
                    </section>
                    
                    <!-- NEW: Manage Voting Categories -->
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-semibold mb-4 text-pink-300">Manage Voting Categories</h2>
                        <div class="space-y-4 mb-6 p-4 bg-gray-700 rounded-lg">
                            <h3 class="text-lg font-semibold text-white">Add New Category</h3>
                            <input type="text" id="adminVotingCategoryTitle" class="w-full bg-gray-600 text-white border border-gray-500 rounded-lg p-3" placeholder="Category Title (e.g., Best Stall)">
                            <textarea id="adminVotingCategoryOptions" rows="3" class="w-full bg-gray-600 text-white border border-gray-500 rounded-lg p-3" placeholder="Enter options, one per line (e.g., Stall A, Stall B)"></textarea>
                            <p class="text-xs text-gray-400">Enter one option per line. Changes here will instantly affect the student voting panel.</p>
                            <button id="btnAdminAddVotingCategory" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-4 rounded-lg transition-all">Add Category</button>
                        </div>
                        
                        <h3 class="text-xl font-semibold mb-2">Current Categories</h3>
                        <div id="adminVotingCategoriesList" class="space-y-3">
                            <p class="text-gray-400">Loading categories...</p>
                        </div>
                    </section>
                </div>
            </main>
        </div>

        <!-- VIEW: Scanner --><div id="scannerView" class="hidden">
            <header class="my-8"> <div class="flex items-center space-x-3 mb-4"> <div> <h2 class="text-lg font-semibold text-white">Udaya Public School</h2> <p class="text-sm text-gray-400">Annual Fest 2025-26</p> </div> </div> <h1 id="scannerTitle" class="text-3xl font-bold text-center text-yellow-300">Scan QR Code</h1> </header>
            <main class="space-y-4"> <div id="qr-reader" class="w-full rounded-lg overflow-hidden border-4 border-gray-700"></div> <button id="btnCancelScan" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all"> Cancel </button> </main>
        </div>

        <!-- VIEW: Student Dashboard --><div id="studentDashboardView" class="hidden">
            <header class="my-8"> 
                <button id="btnStudentBack" class="text-blue-400 hover:text-blue-300 mb-4">&larr; Back to Home (Logout)</button> 
                <div class="flex justify-between items-start"> 
                    <div class="flex items-center space-x-3"> 
                        <div> 
                            <h1 class="text-3xl font-bold text-blue-400">Welcome, <span id="studentName"></span></h1> 
                            <p class="text-sm text-gray-400">Udaya Public School</p> 
                        </div> 
                    </div> 
                    <div class="flex space-x-3">
                        <button id="btnStudentRefresh" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg text-sm transition-all self-start">Refresh Data</button>
                        <button id="btnStudentLogout" class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg text-sm transition-all self-start flex-shrink-0">Logout</button> 
                    </div>
                </div> 
                <div class="mt-4"> 
                    <p id="studentIdDisplay" class="text-sm text-gray-400"></p> 
                    <p class="text-lg text-gray-300 mt-4">Your Balance:</p> 
                    <p id="studentBalance" class="text-5xl font-extrabold text-green-400">₹0.00</p> 
                </div> 
            </header>
            
            <!-- Student Tabs -->
            <div class="mb-4 border-b border-gray-700">
                <nav class="flex space-x-1 overflow-x-auto pb-2" aria-label="Tabs">
                    <button data-target="student-panel-wallet" class="student-tab bg-blue-600 text-white px-4 py-3 rounded-t-lg font-medium text-sm flex-shrink-0">Wallet & Pass</button>
                    <button data-target="student-panel-stalls" class="student-tab bg-gray-700 text-gray-300 px-4 py-3 rounded-t-lg font-medium text-sm flex-shrink-0">Stalls</button>
                    <button data-target="student-panel-event" class="student-tab bg-gray-700 text-gray-300 px-4 py-3 rounded-t-lg font-medium text-sm flex-shrink-0">Event Info</button>
                    <button data-target="student-panel-voting" class="student-tab bg-gray-700 text-gray-300 px-4 py-3 rounded-t-lg font-medium text-sm flex-shrink-0">Voting</button> <!-- NEW TAB -->
                </nav>
            </div>

            <main class="space-y-8">
                
                <!-- Student Panel 1: Wallet, Pass, History -->
                <div id="student-panel-wallet" class="student-tab-panel space-y-8">
                    <!-- Entry Pass Section -->
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-4">
                        <h2 class="text-2xl font-semibold mb-4 text-blue-300">My Entry Pass</h2>
                        <div id="student-printable-pass" class="printable-area bg-white text-black p-6 rounded-lg shadow-lg max-w-xs mx-auto border-4 border-blue-600"> 
                            <div class="text-center border-b pb-4 border-gray-300"> <h3 class="text-xl font-bold text-gray-800">Udaya Public School</h3> <p class="text-xs text-gray-600">Mahadev Jharkhandi, Kunraghat, Gorakhpur</p> </div> 
                            <div class="my-4 text-center"> <p class="text-sm font-medium text-gray-700">ANNUAL FEST 2025-26</p> <p class="text-2xl font-bold text-blue-600">ENTRY PASS</p> <p class="text-sm font-semibold text-gray-700">Date: 1-FEB-2026</p> </div> 
                            <div class="my-4 text-center"> <p id="studentPassName" class="text-lg font-bold text-black">[Student Name]</p> <p class="text-base text-gray-700">Class: <span id="studentPassClass">[Class]</span></p> </div> 
                            <div id="studentPassQR" class="flex justify-center p-4 bg-white rounded-lg"> </div> 
                        </div>
                        <div class="flex space-x-2 mt-4 max-w-xs mx-auto print-hide">
                            <button id="btnStudentPrintPass" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Print Pass</button>
                            <button id="btnStudentDownloadQR" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Download QR</button>
                        </div>
                    </section>
                    <!-- Transaction History -->
                    <section>
                        <h2 class="text-2xl font-semibold mb-4">Transaction History</h2>
                        <div id="studentTransactionList" class="space-y-3 max-h-96 overflow-y-auto"> </div>
                    </section>
                </div>
                
                <!-- Student Panel 2: Stalls & Prices -->
                <div id="student-panel-stalls" class="student-tab-panel hidden space-y-8">
                    <section>
                        <h2 class="text-2xl font-semibold mb-4">Stalls & Prices</h2>
                        <div id="studentStallList" class="space-y-4"> </div>
                    </section>
                </div>

                <!-- NEW Student Panel 3: Event Info -->
                <div id="student-panel-event" class="student-tab-panel hidden space-y-8">
                     <section class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-semibold mb-4 text-indigo-300">Event Information</h2>
                        <div id="studentEventInfo" class="text-gray-200 leading-relaxed event-info-content">
                            <!-- Content injected by JS -->
                        </div>
                    </section>
                </div>
                
                <!-- NEW Student Panel 4: Voting -->
                <div id="student-panel-voting" class="student-tab-panel hidden space-y-8">
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-semibold mb-4 text-pink-300">Event Voting</h2>
                        <p class="text-sm text-gray-400 mb-4">Cast your vote for different event categories. You can only vote once per category!</p>
                        <div id="votingCategoriesList" class="space-y-6">
                            <p class="text-gray-400">Loading voting categories...</p>
                        </div>
                    </section>
                </div>
            </main>
        </div>

        <!-- VIEW: Stall Dashboard --><div id="stallDashboardView" class="hidden">
            <header class="my-8"> 
                <button id="btnStallBack" class="text-blue-400 hover:text-blue-300 mb-4">&larr; Back to Home (Logout)</button> 
                <div class="flex justify-between items-start"> 
                    <div class="flex items-center space-x-3"> 
                        <div> 
                            <h1 class="text-3xl font-bold text-green-400"><span id="stallName"></span></h1> 
                            <p class="text-sm text-gray-400">Udaya Public School</p> 
                        </div> 
                    </div> 
                    <div class="flex space-x-3">
                        <button id="btnStallRefresh" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg text-sm transition-all self-start">Refresh Data</button>
                        <button id="btnStallLogout" class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg text-sm transition-all self-start flex-shrink-0">Logout</button> 
                    </div>
                </div> 
                <div class="mt-4"> 
                    <p class="text-lg text-gray-300">Total Sales:</p> 
                    <p id="stallTotalSales" class="text-5xl font-extrabold text-white">₹0.00</p> 
                </div> 
            </header>
            
            <!-- NEW: Stall Tabs -->
            <div class="mb-4 border-b border-gray-700">
                <nav class="flex space-x-1" aria-label="Tabs">
                    <button data-target="stall-panel-sales" class="stall-tab bg-blue-600 text-white px-4 py-3 rounded-t-lg font-medium text-sm">Sales</button>
                    <button data-target="stall-panel-menu" class="stall-tab bg-gray-700 text-gray-300 px-4 py-3 rounded-t-lg font-medium text-sm">My Menu</button>
                    <button data-target="stall-panel-event" class="stall-tab bg-gray-700 text-gray-300 px-4 py-3 rounded-t-lg font-medium text-sm">Event Info</button>
                </nav>
            </div>
            
            <main class="space-y-8">
                <!-- Stall Panel 1: Sales -->
                <div id="stall-panel-sales" class="stall-tab-panel space-y-8">
                    <section><button id="btnStallScanToPay" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-6 px-6 rounded-lg shadow-lg text-2xl transition-all">Scan Student QR to Pay</button></section>
                    <section> <h2 class="text-2xl font-semibold mb-4">Sales History</h2> <div id="stallSaleList" class="space-y-3 max-h-96 overflow-y-auto"> </div> </section>
                </div>
                
                <!-- Stall Panel 2: Menu -->
                <div id="stall-panel-menu" class="stall-tab-panel hidden space-y-8">
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h2 class="text-2xl font-semibold mb-4">My Menu</h2> <div id="stallMenuList" class="space-y-2"> </div> </section>
                </div>
                
                <!-- NEW Stall Panel 3: Event Info -->
                <div id="stall-panel-event" class="stall-tab-panel hidden space-y-8">
                     <section class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-semibold mb-4 text-indigo-300">Event Information</h2>
                        <div id="stallEventInfo" class="text-gray-200 leading-relaxed event-info-content">
                            <!-- Content injected by JS -->
                        </div>
                    </section>
                </div>
            </main>
        </div>

        <!-- VIEW: Stall Payment --><div id="stallPaymentView" class="hidden">
            <header class="my-8"> <div class="flex items-center space-x-3 mb-4"> <div> <h2 class="text-lg font-semibold text-white">Udaya Public School</h2> <p class="text-sm text-gray-400">Annual Fest 2025-26</p> </div> </div> <h1 class="text-3xl font-bold text-center text-blue-400">Process Payment</h1> </header>
            <main class="space-y-6">
                 <div id="stall-qr-reader-container"> <p class="text-center text-lg text-yellow-300 mb-4">Scanning for Student QR...</p> <div id="stall-qr-reader" class"w-full rounded-lg overflow-hidden border-4 border-gray-700"></div> </div>
                <div id="stallPaymentDetails" class="hidden space-y-6">
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h2 class="text-2xl font-semibold mb-2">Student Details</h2> <div class="flex justify-between items-center"> <span id="stallPaymentStudentName" class="text-xl"></span> <span id="stallPaymentStudentBalance" class="text-xl font-bold text-green-400"></span> </div> </section>
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h2 class="text-2xl font-semibold mb-4">Create Order</h2> <div id="stallCart" class="space-y-4"> </div> </section>
                    <section class="text-center"> <p class="text-lg text-gray-300">Total Amount:</p> <p id="stallCartTotal" class="text-6xl font-extrabold text-green-400">₹0.00</p> </section>
                </div>
                <button id="btnStallConfirmPayment" class="hidden w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg text-lg transition-all"> Confirm Payment </button>
                <button id="btnStallPaymentCancel" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all"> Cancel </button>
            </main>
        </div>

        <!-- VIEW: Admin Recharge --><div id="adminRechargeView" class="hidden">
             <!-- MODIFIED Title -->
             <header class="my-8"> <div class="flex items-center space-x-3 mb-4"> <div> <h2 class="text-lg font-semibold text-white">Udaya Public School</h2> <p class="text-sm text-gray-400">Annual Fest 2025-26</p> </div> </div> <h1 class="text-3xl font-bold text-center text-green-400">Recharge / Cash Out Wallet</h1> </header>
             <main class="space-y-6"> <div id="admin-recharge-qr-reader-container"> <p class="text-center text-lg text-yellow-300 mb-4">Scanning for Student QR...</p> <div id="admin-recharge-qr-reader" class="w-full rounded-lg overflow-hidden border-4 border-gray-700"></div> </div> <div id="adminRechargeDetails" class="hidden space-y-6"> <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h2 class="text-2xl font-semibold mb-2">Student Details</h2> <div class="flex justify-between items-center"> <span id="adminRechargeStudentName" class="text-xl"></span> <span id="adminRechargeStudentBalance" class="text-xl font-bold text-green-400"></span> </div> </section> <section class="bg-gray-800 p-6 rounded-lg shadow-xl"> <h2 class="text-2xl font-semibold mb-4">Enter Amount</h2> <input type="number" id="adminRechargeAmount" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3 text-2xl" placeholder="e.g., 500"> </section> </div> 
             <!-- MODIFIED Button Layout -->
             <div class="space-y-4">
                 <button id="btnAdminConfirmRecharge" class="hidden w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg text-lg transition-all"> Confirm Recharge </button> 
                 <button id="btnAdminConfirmCashOut" class="hidden w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg text-lg transition-all"> Deduct for Cash Out </button> 
                 <button id="btnAdminRechargeCancel" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all"> Cancel </button> 
             </div>
            </main>
        </div>

        <!-- VIEW: Loading Overlay --><div id="loadingView" class="hidden fixed inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center z-50"> <div class="spinner w-16 h-16 border-4 border-gray-600 rounded-full"></div> <p id="loadingMessage" class="text-white text-xl mt-4">Loading...</p> </div>
        <!-- Modal (Alert) --><div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"> <div class="bg-white text-black p-6 rounded-lg shadow-xl max-w-sm w-full"> <p id="modalMessage" class="text-lg mb-4">This is an alert message.</p> <button id="modalButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg"> OK </button> </div> </div>
        <!-- Modal (Confirm) --><div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"> <div class="bg-white text-black p-6 rounded-lg shadow-xl max-w-sm w-full"> <p id="confirmModalMessage" class="text-lg mb-6">Are you sure?</p> <div class="flex space-x-4"> <button id="btnConfirmNo" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg"> Cancel </button> <button id="btnConfirmYes" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg"> Yes </button> </div> </div> </div>
        <!-- NEW: Modal (Edit Item) --><div id="editItemModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"> <div class="bg-white text-black p-6 rounded-lg shadow-xl max-w-sm w-full"> <h3 class="text-xl font-semibold mb-4">Edit Menu Item</h3> <div class="space-y-4"> <div> <label for="editItemNameInput" class="block text-sm font-medium text-gray-700 mb-1">Item Name</label> <input type="text" id="editItemNameInput" class="w-full bg-gray-100 text-black border border-gray-300 rounded-lg p-3"> </div> <div> <label for="editItemPriceInput" class="block text-sm font-medium text-gray-700 mb-1">Item Price</label> <input type="number" id="editItemPriceInput" class="w-full bg-gray-100 text-black border border-gray-300 rounded-lg p-3"> </div> <!-- Hidden fields to store context --> <input type="hidden" id="editItemId"> <input type="hidden" id="editItemStallId"> </div> <div class="flex space-x-4 mt-6"> <button id="btnCancelItemEdit" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg"> Cancel </button> <button id="btnSaveItemChanges" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg"> Save Changes </button> </div> </div> </div>

        <!-- NEW: Modal (Edit Voting Options) -->
        <div id="editVotingOptionsModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div class="bg-white text-black p-6 rounded-lg shadow-xl max-w-sm w-full">
                <h3 class="text-xl font-semibold mb-4">Edit Options for: <span id="editVotingCategoryTitleDisplay" class="text-blue-600"></span></h3>
                <div class="space-y-4">
                    <label for="editVotingOptionsInput" class="block text-sm font-medium text-gray-700 mb-1">Options (One per line)</label>
                    <textarea id="editVotingOptionsInput" rows="6" class="w-full bg-gray-100 text-black border border-gray-300 rounded-lg p-3" placeholder="One option per line"></textarea>
                    <!-- Hidden fields to store context -->
                    <input type="hidden" id="editVotingCategoryId">
                </div>
                <div class="flex space-x-4 mt-6">
                    <button id="btnCancelVotingEdit" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg"> Cancel </button>
                    <button id="btnSaveVotingOptions" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg"> Save Changes </button>
                </div>
            </div>
        </div>

        <!-- Global Footer -->
        <footer class="text-center w-full mt-12 mb-4 text-gray-500 text-xs">
            <!-- NEW: Attribution Block (Moved from homeView) -->
            <div class="text-center text-sm text-gray-400 p-4 bg-gray-800 rounded-lg shadow-xl border border-gray-700 mb-4 mx-auto max-w-sm">
                <p class="mb-1 text-xs">© 2025 UPS Event | Designed & Developed by <strong class="text-white">Aditya (IoT Developer)</strong></p>
                <p class="text-xs">✦ Need a website like this? Contact Aditya (IoT Developer) for web development services.</p>
                <p class="text-xs mt-1 font-semibold text-blue-400">✉ adityagupta11iot@gmail.com</p>
            </div>
            <!-- End NEW: Attribution Block -->
            <p class="font-semibold">Udaya Public School</p>
            <p>Mahadev Jharkhandi, Kunraghat, Gorakhpur</p>
        </footer>
    </div> <!-- End Main Container -->
</body>
</html>
