<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart QR Event Wallet</title>
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. QR Code Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- 3. QR Code Scanning Library -->
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>
    <!-- 4. Firebase SDKs (Using 11.6.1) -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            setPersistence,
            inMemoryPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            addDoc, 
            getDocs,
            serverTimestamp,
            increment,
            arrayUnion,
            runTransaction,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // --- GLOBAL STATE ---
        let db, auth, analytics;
        let html5QrCode; // Main scanner
        let stallQrScanner; // Stall's payment scanner
        let currentUnsubscribes = []; // To detach listeners on logout
        let appState = {
            currentUser: null, // { id, name, role, balance }
            currentView: 'home',
            rechargeAmount: 0,
            scannedStudentId: null,
            stallCart: {},
            adminSelectedStudent: null,
            adminSelectedStall: null,
        };
        let modal, modalMessage, modalButton;
        let confirmModal, confirmMessage, confirmYes, confirmNo, confirmCallback;

        // --- FIREBASE CONFIG & PATHS ---
        const appId = 'my-event-wallet-v2'; 
        
        // --- DOM Elements ---
        let views = {};
        
        // --- FIREBASE COLLECTION REFERENCES ---
        // This logic is for the Canvas environment.
        const usersRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'users');
        const stallsRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'stalls');
        const transactionsRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'transactions');
        const configRef = () => doc(db, 'artifacts', appId, 'public', 'data', 'eventConfig', 'config');

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Cache all view elements
            views = {
                home: document.getElementById('homeView'),
                adminLogin: document.getElementById('adminLoginView'),
                adminDashboard: document.getElementById('adminDashboardView'),
                scanner: document.getElementById('scannerView'),
                studentDashboard: document.getElementById('studentDashboardView'),
                stallDashboard: document.getElementById('stallDashboardView'),
                stallPayment: document.getElementById('stallPaymentView'),
                loading: document.getElementById('loadingView'),
                recharge: document.getElementById('rechargeView'),
            };
            modal = document.getElementById('modal');
            modalMessage = document.getElementById('modalMessage');
            modalButton = document.getElementById('modalButton');
            
            confirmModal = document.getElementById('confirmModal');
            confirmMessage = document.getElementById('confirmMessage');
            confirmYes = document.getElementById('confirmYes');
            confirmNo = document.getElementById('confirmNo');

            // Initialize Firebase
            initFirebase();
            
            // Attach base event listeners
            attachHomeListeners();
            attachAdminLoginListeners();
            attachScannerListeners();
            attachAdminDashboardListeners();
            attachStudentDashboardListeners();
            attachStallDashboardListeners();
            attachStallPaymentListeners();
            attachRechargeListeners();

            modalButton.onclick = () => modal.classList.add('hidden');
            confirmNo.onclick = () => confirmModal.classList.add('hidden');
            confirmYes.onclick = () => {
                confirmModal.classList.add('hidden');
                if (confirmCallback) confirmCallback();
            };
        });

        async function initFirebase() {
            try {
                // This logic handles both Canvas and GitHub Pages deployment
                let finalFirebaseConfig;
                let isCanvasEnv = false;

                if (typeof __firebase_config !== 'undefined' && __firebase_config !== '%%FIREBASE_CONFIG%%') {
                    // We are in the Canvas environment
                    finalFirebaseConfig = JSON.parse(__firebase_config);
                    isCanvasEnv = true;
                } else {
                    // We are outside Canvas (e.g., GitHub Pages)
                    // --- FALLBACK/DEPLOYMENT CONFIG ---
                    // Replace this with your actual Firebase config
                    firebaseConfig = {
                      apiKey: "AIzaSyCsuWEjnrYr1g7ruvZ60ur6TADzbHkJpno",
                      authDomain: "qr-wallet-2ef48.firebaseapp.com",
                      projectId: "qr-wallet-2ef48",
                      storageBucket: "qr-wallet-2ef48.firebasestorage.app",
                      messagingSenderId: "755057942199",
                      appId: "1:755057942199:web:f5fa763b08534bcf1f3732",
                      measurementId: "G-NSLXTCC8JM"
                    };
                    
                    if (finalFirebaseConfig.projectId === "YOUR_PROJECT_ID") {
                         showAlert("SETUP REQUIRED: Please add your Firebase project config to index.html (see setup.md).");
                         return;
                    }
                }

                const app = initializeApp(finalFirebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                analytics = getAnalytics(app);

                await setPersistence(auth, inMemoryPersistence);

                onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                        showLoading('Connecting to event...');
                        try {
                            if (isCanvasEnv && typeof __initial_auth_token !== 'undefined') {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Auth Error:", error);
                            if (error.code === 'auth/configuration-not-found') {
                                showAlert("SETUP ERROR: Anonymous sign-in is not enabled in your Firebase project.");
                            } else {
                                showAlert(`Error connecting: ${error.message}`);
                            }
                        }
                    } else {
                        console.log("User is authenticated:", user.uid);
                        hideLoading();
                        showView('home');
                    }
                });

            } catch (error) {
                console.error("Firebase Init Error:", error);
                showAlert("Critical error loading app configuration.");
            }
        }

        // --- VIEW NAVIGATION ---
        function showView(viewId) {
            cleanupListeners();
            stopAllScanners();
            
            appState.currentView = viewId;
            for (const id in views) {
                if (views[id]) {
                    views[id].classList.add('hidden');
                }
            }
            if (views[viewId]) {
                views[viewId].classList.remove('hidden');
            }
            hideLoading();
        }
        
        function showLoading(message) {
            document.getElementById('loadingMessage').textContent = message;
            views.loading.classList.remove('hidden');
        }

        function hideLoading() {
            views.loading.classList.add('hidden');
        }

        function showAlert(message) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }
        
        function showConfirm(message, onConfirm) {
            confirmMessage.textContent = message;
            confirmCallback = onConfirm;
            confirmModal.classList.remove('hidden');
        }
        
        function cleanupListeners() {
            currentUnsubscribes.forEach(unsub => unsub());
            currentUnsubscribes = [];
        }
        
        function stopAllScanners() {
            try {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().catch(err => {});
                }
            } catch (e) {}
            
            try {
                if (stallQrScanner && stallQrScanner.isScanning) {
                    stallQrScanner.stop().catch(err => {});
                }
            } catch (e) {}
        }
        
        function logout() {
            appState.currentUser = null;
            appState.scannedStudentId = null;
            appState.stallCart = {};
            appState.adminSelectedStudent = null;
            appState.adminSelectedStall = null;
            showView('home');
        }

        // --- HOME VIEW LOGIC ---
        function attachHomeListeners() {
            document.getElementById('btnAdminLogin').onclick = () => showView('adminLogin');
            document.getElementById('btnStallLogin').onclick = () => startScanner('stall');
            document.getElementById('btnStudentLogin').onclick = () => startScanner('student');
        }

        // --- SCANNER VIEW LOGIC ---
        function attachScannerListeners() {
            document.getElementById('btnCancelScan').onclick = () => showView('home');
        }
        
        function startScanner(loginType) {
            showView('scanner');
            document.getElementById('scannerTitle').textContent = `Scan ${loginType.charAt(0).toUpperCase() + loginType.slice(1)} QR Code`;
            
            if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
            
            html5QrCode.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => handleLoginScan(decodedText, loginType),
                (error) => {}
            ).catch(err => {
                showAlert("Could not start camera. Please grant camera permissions.");
                showView('home');
            });
        }
        
        async function handleLoginScan(decodedText, loginType) {
            stopAllScanners();
            showLoading('Verifying QR Code...');
            
            try {
                const userDoc = await getDoc(doc(usersRef(), decodedText));
                
                if (!userDoc.exists()) throw new Error('Invalid QR Code. Not found.');
                
                const user = { id: userDoc.id, ...userDoc.data() };
                if (user.role !== loginType) throw new Error(`Incorrect QR Code. This is a ${user.role} QR.`);
                
                appState.currentUser = user;
                
                if (loginType === 'student') loadStudentDashboard();
                else if (loginType === 'stall') loadStallDashboard();
                
            } catch (error) {
                showAlert(error.message);
                showView('home');
            }
        }

        // --- ADMIN LOGIN VIEW LOGIC ---
        function attachAdminLoginListeners() {
            document.getElementById('btnAdminLoginBack').onclick = () => showView('home');
            document.getElementById('btnAdminLoginSubmit').onclick = async () => {
                const password = document.getElementById('adminPassword').value;
                if (!password) return showAlert('Please enter a password.');
                
                showLoading('Verifying password...');
                try {
                    const config = await getDoc(configRef());
                    const adminPass = config.exists() ? config.data().adminPassword : 'admin123';
                    
                    if (!config.exists()) {
                        await setDoc(configRef(), { adminPassword: 'admin123' });
                    }
                    
                    if (password === adminPass) {
                        loadAdminDashboard();
                    } else {
                        throw new Error('Wrong password.');
                    }
                } catch (error) {
                    showAlert(error.message);
                    hideLoading();
                }
            };
        }

        // --- ADMIN DASHBOARD LOGIC ---
        function attachAdminDashboardListeners() {
            document.getElementById('btnAdminLogout').onclick = logout;
            
            // Tab navigation
            const tabs = document.querySelectorAll('#adminDashboardView .admin-tab');
            const tabPanels = document.querySelectorAll('#adminDashboardView .admin-tab-panel');
            tabs.forEach(tab => {
                tab.onclick = () => {
                    tabs.forEach(t => t.classList.remove('bg-blue-600', 'text-white'));
                    tabs.forEach(t => t.classList.add('bg-gray-700', 'text-gray-300'));
                    tabPanels.forEach(p => p.classList.add('hidden'));
                    
                    tab.classList.add('bg-blue-600', 'text-white');
                    tab.classList.remove('bg-gray-700', 'text-gray-300');
                    document.getElementById(tab.dataset.target).classList.remove('hidden');
                };
            });

            // --- User Management ---
            document.getElementById('btnAdminGenerateStudent').onclick = () => generateUser('student');
            document.getElementById('adminStudentSearch').oninput = handleStudentSearch;
            document.getElementById('btnPrintStudentPass').onclick = () => printPass('adminStudentDetailPass');
            document.getElementById('btnAdminRechargeStudent').onclick = rechargeStudentFromAdmin;
            document.getElementById('btnAdminDeleteStudent').onclick = deleteStudent;
            
            // --- Stall Management ---
            document.getElementById('btnAdminGenerateStall').onclick = () => generateUser('stall');
            document.getElementById('btnAdminAddMenuItem').onclick = addMenuItem;
            document.getElementById('adminStallSearch').oninput = handleStallSearch;
            document.getElementById('btnPrintStallPass').onclick = () => printPass('adminStallDetailPass');
            document.getElementById('btnAdminDeleteStall').onclick = deleteStall;
        }

        function loadAdminDashboard() {
            showView('adminDashboard');
            appState.currentUser = { id: 'admin', role: 'admin' };
            
            // Load stalls for the menu dropdown
            loadAdminStallsAndMenus();
            // Load reports
            loadAdminReports();
        }

        async function generateUser(role) {
            const nameInput = document.getElementById(role === 'student' ? 'adminStudentName' : 'adminStallName');
            const classInput = document.getElementById('adminStudentClass');
            const name = nameInput.value;
            const sClass = (role === 'student') ? classInput.value : null;

            if (!name) return showAlert(`Please enter a ${role} name.`);
            if (role === 'student' && !sClass) return showAlert('Please enter a student class.');
            
            showLoading(`Generating ${role}...`);
            try {
                const newUser = {
                    name,
                    role,
                    balance: role === 'student' ? 0 : null,
                    class: sClass,
                    createdAt: serverTimestamp()
                };
                const newDocRef = await addDoc(usersRef(), newUser);
                const userId = newDocRef.id;
                await updateDoc(newDocRef, { userId: userId });
                
                const userObject = { ...newUser, id: userId, userId: userId };

                if (role === 'stall') {
                    await setDoc(doc(stallsRef(), userId), {
                        name: name,
                        ownerId: userId,
                        menu: []
                    });
                    renderStallPass('adminStallPassContainer', userObject);
                } else {
                    renderStudentPass('adminStudentPassContainer', userObject);
                }
                
                nameInput.value = '';
                if (classInput) classInput.value = '';
                hideLoading();
                showAlert(`${role.charAt(0).toUpperCase() + role.slice(1)} created successfully!`);
                
            } catch (error) {
                showAlert(`Error creating ${role}.`);
                hideLoading();
            }
        }
        
        function renderStudentPass(containerId, user) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="event-pass-print-area">
                    <div class="event-pass">
                        <div class="pass-header">
                            <img src="https://placehold.co/80x80/1D4ED8/FFFFFF?text=UPS" alt="School Logo" class="pass-logo">
                            <div class="pass-school-info">
                                <h3 class="pass-school-name">Udaya Public School</h3>
                                <p class="pass-school-address">Mahadev Jharkhandi, Kunraghat, Gorakhpur</p>
                            </div>
                        </div>
                        <h2 class="pass-event-title">EVENT PASS 2026</h2>
                        <div class="pass-body">
                            <div id="pass-qr-${containerId}" class="pass-qr"></div>
                            <div class="pass-details">
                                <p class="pass-label">Name:</p>
                                <h4 class="pass-name">${user.name}</h4>
                                <p class="pass-label">Class:</p>
                                <h4 class="pass-name">${user.class}</h4>
                                <p class="pass-label">Student ID:</p>
                                <p class="pass-id">${user.id}</p>
                            </div>
                        </div>
                        <div class="pass-footer">
                            <p>Event Date: 1 Feb 2026</p>
                        </div>
                    </div>
                </div>
            `;
            
            new QRCode(document.getElementById(`pass-qr-${containerId}`), {
                text: user.id,
                width: 120,
                height: 120,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }
        
        function renderStallPass(containerId, stall) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="event-pass-print-area">
                    <div class="event-pass">
                        <div class="pass-header">
                            <img src="https://placehold.co/80x80/166534/FFFFFF?text=UPS" alt="School Logo" class="pass-logo">
                            <div class="pass-school-info">
                                <h3 class="pass-school-name">Udaya Public School</h3>
                                <p class="pass-school-address">Mahadev Jharkhandi, Kunraghat, Gorakhpur</p>
                            </div>
                        </div>
                        <h2 class="pass-event-title bg-green-700">STALL VENDOR PASS</h2>
                        <div class="pass-body">
                            <div id="pass-qr-${containerId}" class="pass-qr"></div>
                            <div class="pass-details">
                                <p class="pass-label">Stall Name:</p>
                                <h4 class="pass-name">${stall.name}</h4>
                                <p class="pass-label">Stall ID:</p>
                                <p class="pass-id">${stall.id}</p>
                            </div>
                        </div>
                        <div class="pass-footer bg-green-800">
                            <p>Event Date: 1 Feb 2026</p>
                        </div>
                    </div>
                </div>
            `;
            
            new QRCode(document.getElementById(`pass-qr-${containerId}`), {
                text: stall.id,
                width: 120,
                height: 120,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        async function handleStudentSearch() {
            const term = document.getElementById('adminStudentSearch').value.toLowerCase();
            const listEl = document.getElementById('adminStudentSearchList');
            
            if (!term) {
                listEl.innerHTML = '';
                return;
            }
            
            const q = query(usersRef(), where('role', '==', 'student'));
            const snapshot = await getDocs(q);
            
            listEl.innerHTML = '';
            snapshot.docs.forEach(doc => {
                const user = { id: doc.id, ...doc.data() };
                if (user.name.toLowerCase().includes(term)) {
                    const item = document.createElement('button');
                    item.className = 'w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded-lg';
                    item.innerHTML = `<span class="font-semibold">${user.name}</span> <span class="text-sm text-gray-400">- ${user.class}</span>`;
                    item.onclick = () => selectStudentForAdmin(user);
                    listEl.appendChild(item);
                }
            });
        }
        
        function selectStudentForAdmin(user) {
            appState.adminSelectedStudent = user;
            document.getElementById('adminStudentSearch').value = user.name;
            document.getElementById('adminStudentSearchList').innerHTML = '';
            
            renderStudentPass('adminStudentDetailPass', user);
            
            document.getElementById('adminStudentCurrentBalance').textContent = `Current Balance: ₹${user.balance.toFixed(2)}`;
            document.getElementById('adminStudentManagement').classList.remove('hidden');
        }
        
        async function handleStallSearch() {
            const term = document.getElementById('adminStallSearch').value.toLowerCase();
            const listEl = document.getElementById('adminStallSearchList');
            
            if (!term) {
                listEl.innerHTML = '';
                return;
            }
            
            const q = query(usersRef(), where('role', '==', 'stall'));
            const snapshot = await getDocs(q);
            
            listEl.innerHTML = '';
            snapshot.docs.forEach(doc => {
                const stall = { id: doc.id, ...doc.data() };
                if (stall.name.toLowerCase().includes(term)) {
                    const item = document.createElement('button');
                    item.className = 'w-full text-left p-3 bg-gray-700 hover:bg-gray-600 rounded-lg';
                    item.innerHTML = `<span class="font-semibold">${stall.name}</span>`;
                    item.onclick = () => selectStallForAdmin(stall);
                    listEl.appendChild(item);
                }
            });
        }

        function selectStallForAdmin(stall) {
            appState.adminSelectedStall = stall;
            document.getElementById('adminStallSearch').value = stall.name;
            document.getElementById('adminStallSearchList').innerHTML = '';
            
            renderStallPass('adminStallDetailPass', stall);
            document.getElementById('adminStallManagement').classList.remove('hidden');
        }

        function printPass(containerId) {
            const printArea = document.getElementById(containerId).querySelector('.event-pass-print-area').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = printArea;
            window.print();
            document.body.innerHTML = originalContent;
            
            // Re-attach listeners because document.body.innerHTML breaks them
            // This is a tradeoff for simplicity. A better way is a dedicated print CSS.
            location.reload(); // Simple solution
        }

        async function rechargeStudentFromAdmin() {
            const amountInput = document.getElementById('adminRechargeAmount');
            const amount = parseFloat(amountInput.value);
            const student = appState.adminSelectedStudent;
            
            if (!student) return showAlert('No student selected.');
            if (!amount || amount <= 0) return showAlert('Please enter a valid amount.');
            
            showLoading('Recharging wallet...');
            try {
                const studentDocRef = doc(usersRef(), student.id);
                
                await runTransaction(db, async (transaction) => {
                    const newTxRef = doc(transactionsRef());
                    transaction.set(newTxRef, {
                        studentId: student.id,
                        studentName: student.name,
                        amount: amount,
                        type: 'recharge',
                        note: 'Admin Recharge',
                        timestamp: serverTimestamp()
                    });
                    
                    transaction.update(studentDocRef, { balance: increment(amount) });
                });
                
                appState.adminSelectedStudent.balance += amount;
                document.getElementById('adminStudentCurrentBalance').textContent = `Current Balance: ₹${appState.adminSelectedStudent.balance.toFixed(2)}`;
                amountInput.value = '';
                hideLoading();
                showAlert('Recharge Successful!');
                
            } catch (error) {
                showAlert(`Recharge failed: ${error.message}`);
                hideLoading();
            }
        }

        function deleteStudent() {
            const student = appState.adminSelectedStudent;
            if (!student) return showAlert('No student selected.');
            
            showConfirm(`Are you sure you want to delete ${student.name}? This action cannot be undone.`, async () => {
                showLoading('Deleting student...');
                try {
                    await deleteDoc(doc(usersRef(), student.id));
                    
                    document.getElementById('adminStudentSearch').value = '';
                    document.getElementById('adminStudentDetailPass').innerHTML = '';
                    document.getElementById('adminStudentManagement').classList.add('hidden');
                    appState.adminSelectedStudent = null;
                    
                    hideLoading();
                    showAlert('Student deleted.');
                } catch (error) {
                    showAlert(`Error deleting: ${error.message}`);
                    hideLoading();
                }
            });
        }

        function deleteStall() {
            const stall = appState.adminSelectedStall;
            if (!stall) return showAlert('No stall selected.');
            
            showConfirm(`Are you sure you want to delete ${stall.name}? This will also delete their menu. This action cannot be undone.`, async () => {
                showLoading('Deleting stall...');
                try {
                    const batch = writeBatch(db);
                    batch.delete(doc(usersRef(), stall.id)); // Delete user doc
                    batch.delete(doc(stallsRef(), stall.id)); // Delete stall menu doc
                    await batch.commit();
                    
                    document.getElementById('adminStallSearch').value = '';
                    document.getElementById('adminStallDetailPass').innerHTML = '';
                    document.getElementById('adminStallManagement').classList.add('hidden');
                    appState.adminSelectedStall = null;
                    
                    hideLoading();
                    showAlert('Stall deleted.');
                    loadAdminStallsAndMenus(); // Refresh dropdown
                } catch (error) {
                    showAlert(`Error deleting: ${error.message}`);
                    hideLoading();
                }
            });
        }
        
        function loadAdminStallsAndMenus() {
            const q = query(stallsRef());
            const unsub = onSnapshot(q, (snapshot) => {
                const selectEl = document.getElementById('adminStallSelect');
                
                if (snapshot.empty) {
                    selectEl.innerHTML = '<option value="">No stalls available</option>';
                    return;
                }
                
                selectEl.innerHTML = snapshot.docs.map(doc => {
                    const stall = doc.data();
                    return `<option value="${stall.ownerId}">${stall.name}</option>`;
                }).join('');
            });
            currentUnsubscribes.push(unsub);
        }
        
        function renderMenuList(menu) {
            if (!menu || menu.length === 0) {
                return '<p class="text-sm text-gray-400">No menu items yet.</p>';
            }
            return menu.map(item => `
                <div class="flex justify-between text-sm bg-gray-600 px-2 py-1 rounded">
                    <span>${item.name}</span>
                    <span class="font-medium">₹${item.price.toFixed(2)}</span>
                </div>
            `).join('');
        }
        
        async function addMenuItem() {
            const stallId = document.getElementById('adminStallSelect').value;
            const name = document.getElementById('adminItemName').value;
            const price = parseFloat(document.getElementById('adminItemPrice').value);
            
            if (!stallId || !name || !price) {
                showAlert('Please fill out all fields.');
                return;
            }
            
            showLoading('Adding item...');
            try {
                const newItem = { id: 'item_' + crypto.randomUUID(), name, price };
                await updateDoc(doc(stallsRef(), stallId), { menu: arrayUnion(newItem) });
                
                document.getElementById('adminItemName').value = '';
                document.getElementById('adminItemPrice').value = '';
                hideLoading();
                showAlert('Menu item added!');
                
            } catch (error) {
                showAlert('Error adding item.');
                hideLoading();
            }
        }
        
        function loadAdminReports() {
            const q = query(transactionsRef());
            const unsub = onSnapshot(q, (snapshot) => {
                const listEl = document.getElementById('adminTransactionList');
                let totalSales = 0, totalRecharged = 0;
                const stallSales = {};
                
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-gray-400">No transactions yet.</p>';
                    document.getElementById('adminTotalSales').textContent = '₹0.00';
                    document.getElementById('adminTotalRecharged').textContent = '₹0.00';
                    document.getElementById('adminStallSalesSummary').innerHTML = '';
                    return;
                }
                
                const transactions = snapshot.docs.map(doc => doc.data());
                
                transactions.forEach(tx => {
                    if (tx.type === 'purchase') {
                        totalSales += tx.amount;
                        stallSales[tx.stallName] = (stallSales[tx.stallName] || 0) + tx.amount;
                    } else if (tx.type === 'recharge') {
                        totalRecharged += tx.amount;
                    }
                });
                
                document.getElementById('adminTotalSales').textContent = `₹${totalSales.toFixed(2)}`;
                document.getElementById('adminTotalRecharged').textContent = `₹${totalRecharged.toFixed(2)}`;
                
                document.getElementById('adminStallSalesSummary').innerHTML = Object.entries(stallSales)
                    .map(([name, amount]) => `
                        <div class="flex justify-between p-2 bg-gray-700 rounded">
                            <span>${name}</span>
                            <span class="font-medium">₹${amount.toFixed(2)}</span>
                        </div>
                    `).join('');
                
                listEl.innerHTML = transactions.map(tx => {
                    const time = tx.timestamp ? new Date(tx.timestamp.seconds * 1000).toLocaleTimeString() : '...';
                    if (tx.type === 'purchase') {
                        return `<div class="bg-gray-700 p-3 rounded-lg">
                                    <p class="font-semibold">${tx.studentName} paid ${tx.stallName}</p>
                                    <p class="text-sm">${tx.items.map(i => `${i.name} (x${i.quantity})`).join(', ')}</p>
                                    <div class="flex justify-between items-center mt-1">
                                        <span class="text-red-400 font-bold">- ₹${tx.amount.toFixed(2)}</span>
                                        <span class="text-xs text-gray-400">${time}</span>
                                    </div>
                                </div>`;
                    } else {
                        return `<div class="bg-gray-700 p-3 rounded-lg">
                                    <p class="font-semibold">${tx.studentName} recharged wallet</p>
                                    <div class="flex justify-between items-center mt-1">
                                        <span class="text-green-400 font-bold">+ ₹${tx.amount.toFixed(2)}</span>
                                        <span class="text-xs text-gray-400">${time}</span>
                                    </div>
                                </div>`;
                    }
                }).reverse().join('');
            });
            currentUnsubscribes.push(unsub);
        }

        // --- STUDENT DASHBOARD LOGIC ---
        function attachStudentDashboardListeners() {
            document.getElementById('btnStudentLogout').onclick = logout;
            document.getElementById('btnStudentBack').onclick = logout;
            document.getElementById('btnStudentRecharge').onclick = () => {
                const amount = parseFloat(document.getElementById('studentRechargeAmount').value);
                if (!amount || amount <= 0) {
                    showAlert('Please enter a valid amount to recharge.');
                    return;
                }
                appState.rechargeAmount = amount;
                document.getElementById('rechargeAmountDisplay').textContent = `₹${amount.toFixed(2)}`;
                showView('recharge');
            };
        }
        
        function loadStudentDashboard() {
            showView('studentDashboard');
            
            document.getElementById('studentName').textContent = appState.currentUser.name;
            document.getElementById('studentIdDisplay').textContent = `ID: ${appState.currentUser.id}`;
            
            const unsubBalance = onSnapshot(doc(usersRef(), appState.currentUser.id), (doc) => {
                if (doc.exists()) {
                    appState.currentUser.balance = doc.data().balance;
                    document.getElementById('studentBalance').textContent = `₹${appState.currentUser.balance.toFixed(2)}`;
                } else {
                    showAlert("Your user account was not found. Logging out.");
                    logout();
                }
            });
            currentUnsubscribes.push(unsubBalance);
            
            loadStudentStallList();
            loadStudentTransactionHistory();
        }
        
        async function loadStudentStallList() {
            const listEl = document.getElementById('studentStallList');
            try {
                const snapshot = await getDocs(stallsRef());
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-gray-400">No stalls are open yet.</p>';
                    return;
                }
                listEl.innerHTML = snapshot.docs.map(doc => {
                    const stall = doc.data();
                    return `<div class="bg-gray-800 p-4 rounded-lg">
                                <h4 class="text-xl font-semibold text-blue-300">${stall.name}</h4>
                                <div class="mt-2 space-y-1">
                                    ${renderMenuList(stall.menu)}
                                </div>
                            </div>`;
                }).join('');
            } catch (error) {
                listEl.innerHTML = '<p class="text-red-400">Error loading stalls.</p>';
            }
        }
        
        function loadStudentTransactionHistory() {
            const q = query(transactionsRef(), where('studentId', '==', appState.currentUser.id));
            const listEl = document.getElementById('studentTransactionList');
            
            const unsubHistory = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-gray-400">No transactions yet.</p>';
                    return;
                }
                listEl.innerHTML = snapshot.docs.map(doc => {
                    const tx = doc.data();
                    const time = tx.timestamp ? new Date(tx.timestamp.seconds * 1000).toLocaleString() : '...';
                    if (tx.type === 'purchase') {
                        return `<div class="bg-gray-700 p-3 rounded-lg">
                                    <p class="font-semibold">Paid ${tx.stallName}</p>
                                    <p class="text-sm">${tx.items.map(i => `${i.name} (x${i.quantity})`).join(', ')}</p>
                                    <div class="flex justify-between items-center mt-1">
                                        <span class="text-red-400 font-bold">- ₹${tx.amount.toFixed(2)}</span>
                                        <span class="text-xs text-gray-400">${time}</span>
                                    </div>
                                </div>`;
                    } else {
                        return `<div class="bg-gray-700 p-3 rounded-lg">
                                    <p class="font-semibold">Wallet Recharge</p>
                                    <div class="flex justify-between items-center mt-1">
                                        <span class="text-green-400 font-bold">+ ₹${tx.amount.toFixed(2)}</span>
                                        <span class="text-xs text-gray-400">${time}</span>
                                    </div>
                                </div>`;
                    }
                }).reverse().join('');
            });
            currentUnsubscribes.push(unsubHistory);
        }

        // --- RECHARGE VIEW LOGIC ---
        function attachRechargeListeners() {
            document.getElementById('btnPaymentSuccess').onclick = handleRecharge;
            document.getElementById('btnRechargeBack').onclick = () => loadStudentDashboard();
            document.getElementById('btnPaymentFail').onclick = () => {
                showAlert('Payment failed. Please try again.');
                document.getElementById('studentRechargeAmount').value = '';
                showView('studentDashboard');
            };
        }
        
        async function handleRecharge() {
            showLoading('Processing Recharge...');
            try {
                const studentDocRef = doc(usersRef(), appState.currentUser.id);
                
                await runTransaction(db, async (transaction) => {
                    const newTxRef = doc(transactionsRef());
                    transaction.set(newTxRef, {
                        studentId: appState.currentUser.id,
                        studentName: appState.currentUser.name,
                        amount: appState.rechargeAmount,
                        type: 'recharge',
                        timestamp: serverTimestamp()
                    });
                    transaction.update(studentDocRef, { balance: increment(appState.rechargeAmount) });
                });
                
                document.getElementById('studentRechargeAmount').value = '';
                appState.rechargeAmount = 0;
                showAlert('Recharge Successful!');
                loadStudentDashboard();
                
            } catch (error) {
                showAlert('Recharge failed. Please try again.');
                hideLoading();
            }
        }

        // --- STALL DASHBOARD LOGIC ---
        function attachStallDashboardListeners() {
            document.getElementById('btnStallLogout').onclick = logout;
            document.getElementById('btnStallBack').onclick = logout;
            document.getElementById('btnStallScanToPay').onclick = startStallPaymentScan;
        }

        function loadStallDashboard() {
            showView('stallDashboard');
            
            document.getElementById('stallName').textContent = appState.currentUser.name;
            
            const unsubMenu = onSnapshot(doc(stallsRef(), appState.currentUser.id), (doc) => {
                if (doc.exists()) {
                    appState.currentUser.menu = doc.data().menu;
                    document.getElementById('stallMenuList').innerHTML = renderMenuList(appState.currentUser.menu);
                } else {
                    showAlert("Your stall data was not found. Logging out.");
                    logout();
                }
            });
            currentUnsubscribes.push(unsubMenu);
            
            const q = query(transactionsRef(), where('stallId', '==', appState.currentUser.id));
            const listEl = document.getElementById('stallSaleList');
            const salesTotalEl = document.getElementById('stallTotalSales');
            
            const unsubHistory = onSnapshot(q, (snapshot) => {
                let totalSales = 0;
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-gray-400">No sales yet.</p>';
                    salesTotalEl.textContent = '₹0.00';
                    return;
                }
                
                snapshot.docs.forEach(doc => totalSales += doc.data().amount);
                
                listEl.innerHTML = snapshot.docs.map(doc => {
                    const tx = doc.data();
                    const time = tx.timestamp ? new Date(tx.timestamp.seconds * 1000).toLocaleString() : '...';
                    return `<div class="bg-gray-700 p-3 rounded-lg">
                                <p class="font-semibold">Sale to ${tx.studentName}</p>
                                <p class="text-sm">${tx.items.map(i => `${i.name} (x${i.quantity})`).join(', ')}</p>
                                <div class="flex justify-between items-center mt-1">
                                    <span class="text-green-400 font-bold">+ ₹${tx.amount.toFixed(2)}</span>
                                    <span class="text-xs text-gray-400">${time}</span>
                                </div>
                            </div>`;
                }).reverse().join('');
                
                salesTotalEl.textContent = `₹${totalSales.toFixed(2)}`;
            });
            currentUnsubscribes.push(unsubHistory);
        }
        
        // --- STALL PAYMENT VIEW LOGIC ---
        function attachStallPaymentListeners() {
            document.getElementById('btnStallPaymentCancel').onclick = () => loadStallDashboard();
            document.getElementById('btnStallConfirmPayment').onclick = processPayment;
        }
        
        function startStallPaymentScan() {
            showView('stallPayment');
            appState.scannedStudentId = null;
            appState.stallCart = {};
            
            document.getElementById('stallPaymentDetails').classList.add('hidden');
            document.getElementById('stall-qr-reader-container').classList.remove('hidden');
            document.getElementById('btnStallConfirmPayment').classList.add('hidden');
            
            if (!stallQrScanner) stallQrScanner = new Html5Qrcode("stall-qr-reader");

            stallQrScanner.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: { width: 250, height: 250 } },
                async (decodedText) => {
                    stopAllScanners();
                    showLoading('Fetching Student Details...');
                    
                    try {
                        const userDoc = await getDoc(doc(usersRef(), decodedText));
                        if (!userDoc.exists() || userDoc.data().role !== 'student') {
                            throw new Error('Invalid or non-student QR code.');
                        }
                        
                        const student = userDoc.data();
                        appState.scannedStudentId = decodedText;
                        
                        document.getElementById('stall-qr-reader-container').classList.add('hidden');
                        document.getElementById('stallPaymentDetails').classList.remove('hidden');
                        document.getElementById('btnStallConfirmPayment').classList.remove('hidden');
                        
                        document.getElementById('stallPaymentStudentName').textContent = student.name;
                        document.getElementById('stallPaymentStudentBalance').textContent = `₹${student.balance.toFixed(2)}`;
                        
                        buildCartUI(student.balance);
                        hideLoading();
                        
                    } catch (error) {
                        showAlert(error.message);
                        loadStallDashboard();
                    }
                },
                (error) => {}
            ).catch(err => {
                showAlert("Could not start camera.");
                loadStallDashboard();
            });
        }
        
        function buildCartUI(studentBalance) {
            const cartEl = document.getElementById('stallCart');
            const menu = appState.currentUser.menu || [];
            if (menu.length === 0) {
                cartEl.innerHTML = '<p class="text-yellow-400">You have no menu items configured.</p>';
                document.getElementById('btnStallConfirmPayment').classList.add('hidden');
                return;
            }
            
            cartEl.innerHTML = menu.map(item => `
                <div class="bg-gray-700 p-3 rounded-lg flex items-center justify-between">
                    <div>
                        <p class="font-semibold">${item.name}</p>
                        <p class="text-sm text-blue-300">₹${item.price.toFixed(2)}</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button data-id="${item.id}" class="btn-cart-change bg-red-600 w-8 h-8 rounded-full font-bold text-lg">-</button>
                        <span id="cart-qty-${item.id}" class="text-xl font-bold w-10 text-center">0</span>
                        <button data-id="${item.id}" class="btn-cart-change bg-green-600 w-8 h-8 rounded-full font-bold text-lg">+</button>
                    </div>
                </div>
            `).join('');
            
            document.querySelectorAll('.btn-cart-change').forEach(btn => {
                btn.onclick = (e) => {
                    const id = e.target.dataset.id;
                    const isIncrement = e.target.textContent === '+';
                    updateCart(id, isIncrement, studentBalance);
                };
            });
            
            updateCartTotal(studentBalance);
        }
        
        function updateCart(itemId, isIncrement, studentBalance) {
            let currentQty = appState.stallCart[itemId] || 0;
            currentQty = isIncrement ? currentQty + 1 : Math.max(0, currentQty - 1);
            
            if (currentQty === 0) delete appState.stallCart[itemId];
            else appState.stallCart[itemId] = currentQty;
            
            const qtyEl = document.getElementById(`cart-qty-${itemId}`);
            if (qtyEl) qtyEl.textContent = currentQty;
            updateCartTotal(studentBalance);
        }
        
        function updateCartTotal(studentBalance) {
            const totalEl = document.getElementById('stallCartTotal');
            const confirmBtn = document.getElementById('btnStallConfirmPayment');
            const menuMap = new Map(appState.currentUser.menu.map(i => [i.id, i]));
            
            let total = 0;
            for (const [itemId, quantity] of Object.entries(appState.stallCart)) {
                total += (menuMap.get(itemId)?.price || 0) * quantity;
            }
            
            totalEl.textContent = `₹${total.toFixed(2)}`;
            
            if (total > studentBalance) {
                totalEl.classList.add('text-red-500');
                totalEl.classList.remove('text-green-400');
                confirmBtn.disabled = true;
                confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                totalEl.classList.remove('text-red-500');
                totalEl.classList.add('text-green-400');
                confirmBtn.disabled = (total === 0);
                confirmBtn.classList.toggle('opacity-50', total === 0);
                confirmBtn.classList.toggle('cursor-not-allowed', total === 0);
            }
        }
        
        async function processPayment() {
            const menuMap = new Map(appState.currentUser.menu.map(i => [i.id, i]));
            let totalAmount = 0;
            const cartItems = [];
            
            for (const [itemId, quantity] of Object.entries(appState.stallCart)) {
                if (quantity > 0) {
                    const item = menuMap.get(itemId);
                    totalAmount += item.price * quantity;
                    cartItems.push({ id: itemId, name: item.name, price: item.price, quantity: quantity });
                }
            }
            
            if (totalAmount === 0) return showAlert('Cart is empty.');
            
            showLoading('Processing Payment...');
            
            try {
                await runTransaction(db, async (transaction) => {
                    const studentDocRef = doc(usersRef(), appState.scannedStudentId);
                    const studentDoc = await transaction.get(studentDocRef);
                    if (!studentDoc.exists()) throw new Error("Student not found.");
                    
                    if (studentDoc.data().balance < totalAmount) throw new Error("Insufficient student balance.");
                    
                    transaction.update(studentDocRef, { balance: increment(-totalAmount) });
                    
                    const newTxRef = doc(transactionsRef());
                    transaction.set(newTxRef, {
                        studentId: appState.scannedStudentId,
                        studentName: document.getElementById('stallPaymentStudentName').textContent,
                        stallId: appState.currentUser.id,
                        stallName: appState.currentUser.name,
                        amount: totalAmount,
                        items: cartItems,
                        type: 'purchase',
                        timestamp: serverTimestamp()
                    });
                });
                
                showAlert('Payment Successful!');
                loadStallDashboard();
                
            } catch (error) {
                showAlert(error.message);
                hideLoading();
            }
        }

    </script>

    <style>
        .spinner { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Event Pass Styles */
        .event-pass {
            font-family: Arial, sans-serif;
            width: 320px;
            border: 1px solid #4B5563; /* gray-600 */
            border-radius: 16px;
            background-color: #ffffff;
            color: #000000;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            margin: auto; /* Center it */
        }
        .pass-header {
            display: flex;
            align-items: center;
            padding: 16px;
            background-color: #F9FAFB; /* gray-50 */
            border-bottom: 1px solid #E5E7EB; /* gray-200 */
        }
        .pass-logo { width: 60px; height: 60px; border-radius: 50%; }
        .pass-school-info { margin-left: 12px; }
        .pass-school-name { font-size: 1.125rem; font-weight: 700; color: #1F2937; /* gray-800 */ }
        .pass-school-address { font-size: 0.75rem; color: #4B5563; /* gray-600 */ }
        .pass-event-title {
            background-color: #2563EB; /* blue-600 */
            color: #FFFFFF;
            font-size: 1rem;
            font-weight: 700;
            text-align: center;
            padding: 8px 0;
            letter-spacing: 0.05em;
        }
        .pass-body {
            display: flex;
            padding: 20px;
            gap: 16px;
        }
        .pass-qr {
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .pass-details { flex: 1; }
        .pass-label { font-size: 0.75rem; color: #6B7280; /* gray-500 */ margin-bottom: 2px; }
        .pass-name { font-size: 1.25rem; font-weight: 700; color: #111827; /* gray-900 */ line-height: 1.2; }
        .pass-id { font-size: 0.75rem; color: #4B5563; /* gray-600 */ word-break: break-all; }
        .pass-footer {
            background-color: #1F2937; /* gray-800 */
            color: #E5E7EB; /* gray-200 */
            padding: 8px 16px;
            text-align: center;
            font-size: 0.875rem;
        }
        
        /* Print styles */
        @media print {
            body * {
                visibility: hidden;
            }
            .event-pass-print-area, .event-pass-print-area * {
                visibility: visible;
            }
            .event-pass-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .event-pass {
                margin: 0;
                border: none;
                box-shadow: none;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans antialiased">

    <!-- Main Container -->
    <div class="container mx-auto p-4 max-w-lg min-h-screen">

        <!-- VIEW: Home (Unchanged) -->
        <div id="homeView" class="">
            <header class="text-center my-12">
                <h1 class="text-4xl font-bold text-blue-400 mb-2">Smart QR Event Wallet</h1>
                <p class="text-lg text-gray-300">Udaya Public School</p>
            </header>
            <main class="space-y-6">
                <button id="btnAdminLogin" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg text-lg transition-all">Admin Login</button>
                <button id="btnStallLogin" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg text-lg transition-all">Stall Login (Scan QR)</button>
                <button id="btnStudentLogin" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg text-lg transition-all">Student Login (Scan QR)</button>
            </main>
        </div>

        <!-- VIEW: Admin Login (Unchanged) -->
        <div id="adminLoginView" class="hidden">
            <header class="my-8">
                <button id="btnAdminLoginBack" class="text-blue-400 hover:text-blue-300">&larr; Back to Home</button>
                <h1 class="text-3xl font-bold text-center text-red-400 mt-4">Admin Login</h1>
            </header>
            <main class="space-y-4 bg-gray-800 p-6 rounded-lg shadow-xl">
                <div>
                    <label for="adminPassword" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                    <input type="password" id="adminPassword" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3 focus:ring-red-500 focus:border-red-500" placeholder="••••••••">
                </div>
                <button id="btnAdminLoginSubmit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all">Login</button>
            </main>
        </div>

        <!-- VIEW: Admin Dashboard (HEAVILY MODIFIED) -->
        <div id="adminDashboardView" class="hidden">
            <header class="my-8 flex justify-between items-center">
                <h1 class="text-3xl font-bold text-red-400">Admin Dashboard</h1>
                <button id="btnAdminLogout" class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg text-sm transition-all">Logout</button>
            </header>
            
            <div class="mb-4 border-b border-gray-700">
                <nav class="flex space-x-1" aria-label="Tabs">
                    <button data-target="panel-users" class="admin-tab bg-blue-600 text-white px-4 py-3 rounded-t-lg font-medium text-sm">Manage Students</button>
                    <button data-target="panel-stalls" class="admin-tab bg-gray-700 text-gray-300 px-4 py-3 rounded-t-lg font-medium text-sm">Manage Stalls</button>
                    <button data-target="panel-reports" class="admin-tab bg-gray-700 text-gray-300 px-4 py-3 rounded-t-lg font-medium text-sm">Reports</button>
                </nav>
            </div>
            
            <main class="space-y-6">
                <!-- Panel 1: Manage Students -->
                <div id="panel-users" class="admin-tab-panel space-y-6">
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-semibold mb-4 text-blue-300">Generate Student Pass</h2>
                        <div class="space-y-4">
                            <input type="text" id="adminStudentName" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Student Name">
                            <input type="text" id="adminStudentClass" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Student Class (e.g., 10-B)">
                            <button id="btnAdminGenerateStudent" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all">
                                Generate Pass
                            </button>
                            <div id="adminStudentPassContainer" class="mt-4">
                                <!-- Generated pass will appear here -->
                            </div>
                        </div>
                    </section>
                    
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-semibold mb-4 text-blue-300">Manage Existing Student</h2>
                        <input type="search" id="adminStudentSearch" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Search by name...">
                        <div id="adminStudentSearchList" class="space-y-2 mt-2 max-h-48 overflow-y-auto">
                            <!-- Search results appear here -->
                        </div>
                        
                        <div id="adminStudentDetailPass" class="mt-4">
                            <!-- Selected student's pass appears here -->
                        </div>
                        
                        <div id="adminStudentManagement" class="hidden mt-4 space-y-4">
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <p id="adminStudentCurrentBalance" class="text-lg font-semibold text-green-400">Current Balance: ₹0.00</p>
                                <div class="flex gap-2 mt-2">
                                    <input type="number" id="adminRechargeAmount" class="flex-grow bg-gray-600 text-white border border-gray-500 rounded-lg p-2" placeholder="Amount">
                                    <button id="btnAdminRechargeStudent" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg">Recharge</button>
                                </div>
                            </div>
                            <button id="btnPrintStudentPass" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg">Print/Download Pass</button>
                            <button id="btnAdminDeleteStudent" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg">Delete Student</button>
                        </div>
                    </section>
                </div>
                
                <!-- Panel 2: Manage Stalls -->
                <div id="panel-stalls" class="admin-tab-panel hidden space-y-6">
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-semibold mb-4 text-green-300">Generate Stall Pass</h2>
                        <div class="space-y-4">
                            <input type="text" id="adminStallName" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Stall Name (e.g., Pizza Corner)">
                            <button id="btnAdminGenerateStall" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all">
                                Generate Stall Pass
                            </button>
                            <div id="adminStallPassContainer" class="mt-4">
                                <!-- Generated pass will appear here -->
                            </div>
                        </div>
                    </section>
                    
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-semibold mb-4 text-green-300">Add Menu Item</h2>
                        <div class="space-y-4">
                            <select id="adminStallSelect" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3"></select>
                            <input type="text" id="adminItemName" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Item Name (e.g., Veg Pizza)">
                            <input type="number" id="adminItemPrice" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Item Price (e.g., 100)">
                            <button id="btnAdminAddMenuItem" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all">
                                Add Item
                            </button>
                        </div>
                    </section>
                    
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-semibold mb-4 text-green-300">Manage Existing Stall</h2>
                        <input type="search" id="adminStallSearch" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Search by name...">
                        <div id="adminStallSearchList" class="space-y-2 mt-2 max-h-48 overflow-y-auto">
                            <!-- Search results appear here -->
                        </div>
                        
                        <div id="adminStallDetailPass" class="mt-4">
                            <!-- Selected stall's pass appears here -->
                        </div>
                        
                        <div id="adminStallManagement" class="hidden mt-4 space-y-4">
                            <button id="btnPrintStallPass" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg">Print/Download Pass</button>
                            <button id="btnAdminDeleteStall" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg">Delete Stall</button>
                        </div>
                    </section>
                </div>
                
                <!-- Panel 3: Reports (Unchanged) -->
                <div id="panel-reports" class="admin-tab-panel hidden space-y-6">
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-4">
                        <h2 class="text-2xl font-semibold mb-4 text-yellow-300">Event Financials</h2>
                        <div class="flex justify-between bg-gray-700 p-4 rounded-lg">
                            <span class="text-lg">Total Recharged:</span>
                            <span id="adminTotalRecharged" class="text-lg font-bold text-green-400">₹0.00</span>
                        </div>
                        <div class="flex justify-between bg-gray-700 p-4 rounded-lg">
                            <span class="text-lg">Total Sales:</span>
                            <span id="adminTotalSales" class="text-lg font-bold text-red-400">₹0.00</span>
                        </div>
                    </section>
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h3 class="text-xl font-semibold mb-2">Sales per Stall</h3>
                        <div id="adminStallSalesSummary" class="space-y-2"></div>
                    </section>
                    <section>
                        <h2 class="text-2xl font-semibold mb-4">All Transactions</h2>
                        <div id="adminTransactionList" class="space-y-3 max-h-96 overflow-y-auto"></div>
                    </section>
                </div>
            </main>
        </div>

        <!-- VIEW: Scanner (Unchanged) -->
        <div id="scannerView" class="hidden">
            <header class="my-8">
                <h1 id="scannerTitle" class="text-3xl font-bold text-center text-yellow-300">Scan QR Code</h1>
            </header>
            <main class="space-y-4">
                <div id="qr-reader" class="w-full rounded-lg overflow-hidden border-4 border-gray-700"></div>
                <button id="btnCancelScan" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all">Cancel</button>
            </main>
        </div>

        <!-- VIEW: Student Dashboard (Unchanged) -->
        <div id="studentDashboardView" class="hidden">
            <header class="my-8">
                <button id="btnStudentBack" class="text-blue-400 hover:text-blue-300 mb-4">&larr; Back to Home (Logout)</button>
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-blue-400">Welcome, <span id="studentName"></span></h1>
                        <p id="studentIdDisplay" class="text-sm text-gray-400"></p>
                        <p class="text-lg text-gray-300 mt-4">Your Balance:</p>
                        <p id="studentBalance" class="text-5xl font-extrabold text-green-400">₹0.00</p>
                    </div>
                    <button id="btnStudentLogout" class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg text-sm transition-all self-start">Logout</button>
                </div>
            </header>
            <main class="space-y-8">
                <section class="bg-gray-800 p-6 rounded-lg shadow-xl space-y-4">
                    <h2 class="text-2xl font-semibold mb-4 text-green-300">Recharge Wallet</h2>
                    <input type="number" id="studentRechargeAmount" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg p-3" placeholder="Enter Amount (e.g., 500)">
                    <button id="btnStudentRecharge" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all">Go to Payment</button>
                </section>
                <section>
                    <h2 class="text-2xl font-semibold mb-4">Stalls & Prices</h2>
                    <div id="studentStallList" class="space-y-4"></div>
                </section>
                <section>
                    <h2 class="text-2xl font-semibold mb-4">Transaction History</h2>
                    <div id="studentTransactionList" class="space-y-3 max-h-96 overflow-y-auto"></div>
                </section>
            </main>
        </div>
        
        <!-- VIEW: Recharge (Unchanged) -->
        <div id="rechargeView" class="hidden">
            <header class="my-8">
                <button id="btnRechargeBack" class="text-blue-400 hover:text-blue-300 mb-4">&larr; Back to Dashboard</button>
                <h1 class="text-3xl font-bold text-center text-yellow-300 mt-4">Mock UPI Payment</h1>
            </header>
            <main class="space-y-6 bg-gray-800 p-8 rounded-lg shadow-xl text-center">
                <p class="text-lg text-gray-300">You are about to pay:</p>
                <p id="rechargeAmountDisplay" class="text-6xl font-extrabold text-white">₹0.00</p>
                <p class="text-sm text-gray-400">This is a mock payment screen. Click "Successful" to add funds.</p>
                <button id="btnPaymentSuccess" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg text-lg transition-all">Payment Successful</button>
                <button id="btnPaymentFail" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all">Payment Failed</button>
            </main>
        </div>

        <!-- VIEW: Stall Dashboard (Unchanged) -->
        <div id="stallDashboardView" class="hidden">
            <header class="my-8">
                <button id="btnStallBack" class="text-blue-400 hover:text-blue-300 mb-4">&larr; Back to Home (Logout)</button>
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-green-400"><span id="stallName"></span></h1>
                        <p class="text-lg text-gray-300">Total Sales:</p>
                        <p id="stallTotalSales" class="text-5xl font-extrabold text-white">₹0.00</p>
                    </div>
                    <button id="btnStallLogout" class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg text-sm transition-all self-start">Logout</button>
                </div>
            </header>
            <main class="space-y-8">
                <section>
                    <button id="btnStallScanToPay" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-6 px-6 rounded-lg shadow-lg text-2xl transition-all">Scan Student QR to Pay</button>
                </section>
                <section class="bg-gray-800 p-6 rounded-lg shadow-xl">
                    <h2 class="text-2xl font-semibold mb-4">My Menu</h2>
                    <div id="stallMenuList" class="space-y-2"></div>
                </section>
                <section>
                    <h2 class="text-2xl font-semibold mb-4">Sales History</h2>
                    <div id="stallSaleList" class="space-y-3 max-h-96 overflow-y-auto"></div>
                </section>
            </main>
        </div>
        
        <!-- VIEW: Stall Payment (Unchanged) -->
        <div id="stallPaymentView" class="hidden">
            <header class="my-8">
                <h1 class="text-3xl font-bold text-center text-blue-400">Process Payment</h1>
            </header>
            <main class="space-y-6">
                <div id="stall-qr-reader-container">
                    <p class="text-center text-lg text-yellow-300 mb-4">Scanning for Student QR...</p>
                    <div id="stall-qr-reader" class="w-full rounded-lg overflow-hidden border-4 border-gray-700"></div>
                </div>
                <div id="stallPaymentDetails" class="hidden space-y-6">
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-semibold mb-2">Student Details</h2>
                        <div class="flex justify-between items-center">
                            <span id="stallPaymentStudentName" class="text-xl"></span>
                            <span id="stallPaymentStudentBalance" class="text-xl font-bold text-green-400"></span>
                        </div>
                    </section>
                    <section class="bg-gray-800 p-6 rounded-lg shadow-xl">
                        <h2 class="text-2xl font-semibold mb-4">Create Order</h2>
                        <div id="stallCart" class="space-y-4"></div>
                    </section>
                    <section class="text-center">
                        <p class="text-lg text-gray-300">Total Amount:</p>
                        <p id="stallCartTotal" class="text-6xl font-extrabold text-green-400">₹0.00</p>
                    </section>
                </div>
                <button id="btnStallConfirmPayment" class="hidden w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg text-lg transition-all">Confirm Payment</button>
                <button id="btnStallPaymentCancel" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all">Cancel</button>
            </main>
        </div>

        <!-- VIEW: Loading Overlay (Unchanged) -->
        <div id="loadingView" class="hidden fixed inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center z-50">
            <div class="spinner w-16 h-16 border-4 border-gray-600 rounded-full"></div>
            <p id="loadingMessage" class="text-white text-xl mt-4">Loading...</p>
        </div>

        <!-- Modal (Alert) (Unchanged) -->
        <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div class="bg-white text-black p-6 rounded-lg shadow-xl max-w-sm w-full">
                <p id="modalMessage" class="text-lg mb-4">This is an alert message.</p>
                <button id="modalButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">OK</button>
            </div>
        </div>
        
        <!-- NEW: Confirm Modal -->
        <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
            <div class="bg-white text-black p-6 rounded-lg shadow-xl max-w-sm w-full">
                <p id="confirmMessage" class="text-lg mb-6">Are you sure?</p>
                <div class="flex gap-4">
                    <button id="confirmNo" class="w-full bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button id="confirmYes" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Yes, Delete</button>
                </div>
            </div>
        </div>

    </div>
</body>
</html>

